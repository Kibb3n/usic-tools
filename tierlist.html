<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Tier List Maker - Final</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @keyframes blob1 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(150px, 100px) scale(1.2);
            }

            66% {
                transform: translate(-100px, 150px) scale(0.9);
            }
        }

        @keyframes blob2 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(-150px, -100px) scale(0.9);
            }

            66% {
                transform: translate(100px, -150px) scale(1.2);
            }
        }

        .grain {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='3.5' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.3'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        .tier-slot {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            min-height: 80px;
        }

        .tier-slot.drag-over {
            border-color: #60a5fa !important;
            background: rgba(96, 165, 250, 0.2);
        }

        .draggable-item {
            cursor: grab;
            user-select: none;
            transition: transform 0.2s;
        }

        .draggable-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .draggable-item:active {
            cursor: grabbing;
        }

        .draggable-item.dragging {
            opacity: 0.4;
            transform: scale(0.9);
        }

        .song-bg {
            position: absolute;
            inset: 0;
            object-fit: cover;
            filter: blur(8px);
            transform: scale(1.1);
        }

        .song-title {
            position: relative;
            z-index: 1;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .mode-switch {
            position: relative;
            width: 200px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 22px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .mode-switch-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 96px;
            height: 36px;
            background: white;
            border-radius: 18px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .mode-switch.songs .mode-switch-slider {
            transform: translateX(96px);
        }

        .mode-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            font-weight: 600;
            transition: color 0.3s ease;
            width: 100px;
            text-align: center;
        }

        .mode-label.left {
            left: 0;
        }

        .mode-label.right {
            right: 0;
        }

        .mode-switch .mode-label.left {
            color: black;
        }

        .mode-switch .mode-label.right {
            color: white;
        }

        .mode-switch.songs .mode-label.left {
            color: white;
        }

        .mode-switch.songs .mode-label.right {
            color: black;
        }

        .editable-title {
            cursor: text;
            transition: all 0.2s;
            display: inline-block;
            min-width: 200px;
            text-align: center;
        }

        .editable-title:hover:not(.editing) {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 4px 12px;
        }

        .undo-toast {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .sticky-sidebar {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const Trash = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const Pencil = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
            </svg>
        );

        const Music = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
        );

        const ChevronLeft = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const Plus = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const RotateCcw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
        );

        const Move = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
            </svg>
        );

        const ArrowLeft = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        );

        const ArrowRight = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
        );

        const FileDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const Keyboard = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
            </svg>
        );

        const jsonpRequest = (url) => {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                const script = document.createElement('script');
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                document.body.appendChild(script);
            });
        };

        const normalizeString = (str) => {
            return str.toLowerCase().replace(/[^a-z0-9]/g, '');
        };

        const TIER_COLORS = {
            S: '#ff7f7f',
            A: '#ffbf7f',
            B: '#ffdf7f',
            C: '#ffff7f',
            D: '#bfff7f',
            E: '#7fff7f',
            F: '#7fbfff'
        };

        const DEFAULT_TIERS = ['S', 'A', 'B', 'C', 'D', 'E', 'F'];

        function AnimatedBackground({ colors }) {
            return (
                <div className="fixed inset-0 overflow-hidden pointer-events-none">
                    <div
                        className="absolute w-[900px] h-[900px] rounded-full opacity-70 blur-3xl will-change-transform transition-all duration-1000"
                        style={{
                            background: `radial-gradient(circle, ${colors[0]} 0%, transparent 70%)`,
                            animation: `blob1 12s ease-in-out infinite`,
                            top: '50%',
                            left: '33.333%',
                            transform: 'translate(-50%, -50%)',
                        }}
                    />
                    <div
                        className="absolute w-[900px] h-[900px] rounded-full opacity-70 blur-3xl will-change-transform transition-all duration-1000"
                        style={{
                            background: `radial-gradient(circle, ${colors[1]} 0%, transparent 70%)`,
                            animation: `blob2 12s ease-in-out infinite`,
                            top: '50%',
                            right: '33.333%',
                            transform: 'translate(50%, -50%)',
                        }}
                    />
                    <div className="absolute inset-0 grain opacity-30" />
                </div>
            );
        }

        function TierListApp() {
            const [tiers, setTiers] = useState({
                S: [], A: [], B: [], C: [], D: [], E: [], F: [], unranked: []
            });
            const [tierNames, setTierNames] = useState(DEFAULT_TIERS);
            const [tierColors, setTierColors] = useState(TIER_COLORS);
            const [songsMode, setSongsMode] = useState(false);
            const [albumBackup, setAlbumBackup] = useState(null);
            const [title, setTitle] = useState('My Music Tier List');
            const [bgColors, setBgColors] = useState(['#ff0080', '#7928ca']);
            const [editingTitle, setEditingTitle] = useState(false);
            const [tempTitle, setTempTitle] = useState(title);

            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [advancedSearchMode, setAdvancedSearchMode] = useState(false);
            const [artistSearchQuery, setArtistSearchQuery] = useState('');
            const [artistSuggestions, setArtistSuggestions] = useState([]);
            const [selectedArtist, setSelectedArtist] = useState(null);
            const [artistAlbums, setArtistAlbums] = useState([]);
            const [loadingArtist, setLoadingArtist] = useState(false);
            const [selectedAlbum, setSelectedAlbum] = useState(null);
            const [albumSongs, setAlbumSongs] = useState([]);
            const [loadingSongs, setLoadingSongs] = useState(false);

            const [draggedItem, setDraggedItem] = useState(null);
            const [draggedFrom, setDraggedFrom] = useState(null);
            const [dragOverTier, setDragOverTier] = useState(null);

            const [renameModalOpen, setRenameModalOpen] = useState(false);
            const [renameItem, setRenameItem] = useState(null);
            const [renameTitle, setRenameTitle] = useState('');
            const [createTileModalOpen, setCreateTileModalOpen] = useState(false);
            const [newTileTitle, setNewTileTitle] = useState('');
            const [newTileColor, setNewTileColor] = useState('#8b5cf6');

            const [searchCollapsed, setSearchCollapsed] = useState(false);
            const [unrankedInSidebar, setUnrankedInSidebar] = useState(false);
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [editingTierName, setEditingTierName] = useState(null);
            const [tempTierName, setTempTierName] = useState('');

            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [undoToast, setUndoToast] = useState(null);
            const [bulkMoveFrom, setBulkMoveFrom] = useState('');
            const [bulkMoveTo, setBulkMoveTo] = useState('');
            const [showReorderButtons, setShowReorderButtons] = useState(true);
            const [modeWarningOpen, setModeWarningOpen] = useState(false);
            const [settingsTitleEdit, setSettingsTitleEdit] = useState('');

            const tierListRef = useRef(null);
            const scrollIntervalRef = useRef(null);
            const titleInputRef = useRef(null);

            const saveToHistory = useCallback((newTiers) => {
                setHistory(prev => {
                    const newHistory = prev.slice(0, historyIndex + 1);
                    newHistory.push(JSON.parse(JSON.stringify(newTiers)));
                    if (newHistory.length > 50) newHistory.shift();
                    return newHistory;
                });
                setHistoryIndex(prev => Math.min(prev + 1, 49));
            }, [historyIndex]);

            const undo = useCallback(() => {
                if (historyIndex > 0) {
                    const previousState = history[historyIndex - 1];
                    setTiers(previousState);
                    setHistoryIndex(prev => prev - 1);
                    setUndoToast('Undone');
                    setTimeout(() => setUndoToast(null), 2000);
                }
            }, [history, historyIndex]);

            const redo = useCallback(() => {
                if (historyIndex < history.length - 1) {
                    const nextState = history[historyIndex + 1];
                    setTiers(nextState);
                    setHistoryIndex(prev => prev + 1);
                    setUndoToast('Redone');
                    setTimeout(() => setUndoToast(null), 2000);
                }
            }, [history, historyIndex]);

            useEffect(() => {
                const handleKeyPress = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo();
                    }
                    if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') ||
                        ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
                        e.preventDefault();
                        redo();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                        e.preventDefault();
                        setSearchCollapsed(prev => !prev);
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                        e.preventDefault();
                        exportAsImage();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        exportData();
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [undo, redo]);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('tierListData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.tiers) {
                            const reconstructedTiers = { ...data.tiers };
                            if (data.tierNames) {
                                data.tierNames.forEach(tierName => {
                                    if (!reconstructedTiers[tierName]) {
                                        reconstructedTiers[tierName] = [];
                                    }
                                });
                            }
                            setTiers(reconstructedTiers);
                            saveToHistory(reconstructedTiers);
                        }
                        setTitle(data.title || 'My Music Tier List');
                        setTempTitle(data.title || 'My Music Tier List');
                        setSettingsTitleEdit(data.title || 'My Music Tier List');
                        if (data.tierNames) {
                            setTierNames(data.tierNames);
                        }
                        if (data.tierColors) {
                            setTierColors(data.tierColors);
                        }
                        if (data.showReorderButtons !== undefined) {
                            setShowReorderButtons(data.showReorderButtons);
                        }
                    }
                } catch (err) {
                    console.error('Failed to load:', err);
                }
            }, []);

            useEffect(() => {
                if (!songsMode) {
                    try {
                        const data = { tiers, title, tierNames, tierColors, showReorderButtons };
                        localStorage.setItem('tierListData', JSON.stringify(data));
                    } catch (err) {
                        console.error('Failed to save:', err);
                    }
                }
            }, [tiers, title, songsMode, tierNames, tierColors, showReorderButtons]);

            useEffect(() => {
                if (editingTitle && titleInputRef.current) {
                    titleInputRef.current.focus();
                    titleInputRef.current.select();
                }
            }, [editingTitle]);

            useEffect(() => {
                const allItems = Object.values(tiers).flat().filter(item => item);

                if (allItems.length === 0) {
                    setBgColors(['#ff0080', '#7928ca']);
                    return;
                }

                const extractColors = async () => {
                    const colors = [];
                    const recentItems = allItems.slice(-2);

                    for (const item of recentItems) {
                        try {
                            if (item.custom) {
                                colors.push(item.color);
                                continue;
                            }

                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.src = item.image;

                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                setTimeout(reject, 3000);
                            });

                            const canvas = document.createElement('canvas');
                            canvas.width = 50;
                            canvas.height = 50;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, 50, 50);

                            const imageData = ctx.getImageData(0, 0, 50, 50);
                            const data = imageData.data;

                            let r = 0, g = 0, b = 0;
                            for (let i = 0; i < data.length; i += 4) {
                                r += data[i];
                                g += data[i + 1];
                                b += data[i + 2];
                            }

                            const count = data.length / 4;
                            r = Math.floor(r / count);
                            g = Math.floor(g / count);
                            b = Math.floor(b / count);

                            colors.push(`rgb(${r}, ${g}, ${b})`);
                        } catch (err) {
                            console.error('Color extraction failed:', err);
                        }
                    }

                    if (colors.length > 0) {
                        if (colors.length === 1) colors.push(colors[0]);
                        setBgColors(colors);
                    }
                };

                extractColors();
            }, [tiers]);

            const searchAlbums = useCallback(async () => {
                if (!searchQuery.trim()) return;
                setLoading(true);
                setSearchResults([]);

                try {
                    // First, try to get the canonical album from Last.fm for better matching
                    let lastfmCanonical = [];
                    try {
                        const lastfmUrl = `https://ws.audioscrobbler.com/2.0/?method=album.search&album=${encodeURIComponent(searchQuery)}&api_key=33866e12a02528e0bb9211bd2f351c28&format=json&limit=30`;
                        const lastfmResponse = await fetch(lastfmUrl);
                        const lastfmData = await lastfmResponse.json();

                        if (lastfmData.results?.albummatches?.album) {
                            const albums = Array.isArray(lastfmData.results.albummatches.album)
                                ? lastfmData.results.albummatches.album
                                : [lastfmData.results.albummatches.album];

                            const enrichedAlbums = await Promise.all(
                                albums
                                    .filter(album => {
                                        const image = album.image?.find(img => img.size === 'extralarge')?.['#text'] || '';
                                        return image && image.length > 20 &&
                                            !image.includes('2a96cbd8b46e442fc41c2b86b821562f') &&
                                            !image.includes('c6f59c1e5e7240a4c0d427abd71f3dbb');
                                    })
                                    .slice(0, 15)
                                    .map(async album => {
                                        try {
                                            const infoUrl = `https://ws.audioscrobbler.com/2.0/?method=album.getinfo&api_key=33866e12a02528e0bb9211bd2f351c28&artist=${encodeURIComponent(album.artist)}&album=${encodeURIComponent(album.name)}&format=json`;
                                            const infoResponse = await fetch(infoUrl);
                                            const infoData = await infoResponse.json();

                                            const playcount = parseInt(infoData.album?.playcount || '0');
                                            const listeners = parseInt(infoData.album?.listeners || '0');

                                            return {
                                                title: album.name,
                                                artist: album.artist,
                                                image: album.image.find(img => img.size === 'extralarge')?.['#text'] || '',
                                                playcount,
                                                listeners,
                                                popularityScore: playcount + (listeners * 3)
                                            };
                                        } catch (err) {
                                            return null;
                                        }
                                    })
                            );

                            lastfmCanonical = enrichedAlbums.filter(a => a !== null);
                        }
                    } catch (error) {
                        console.error('Last.fm initial search error:', error);
                    }

                    // Get iTunes results
                    const itunesData = await jsonpRequest(
                        `https://itunes.apple.com/search?term=${encodeURIComponent(searchQuery)}&entity=album&limit=200`
                    );

                    let itunesResults = [];
                    if (itunesData.results) {
                        itunesResults = itunesData.results
                            .filter(item => item.wrapperType === 'collection')
                            .map(album => ({
                                id: `itunes-${album.collectionId}`,
                                title: album.collectionName,
                                artist: album.artistName,
                                image: album.artworkUrl100.replace('100x100', '600x600'),
                                year: album.releaseDate ? new Date(album.releaseDate).getFullYear() : '',
                                collectionId: album.collectionId,
                                trackCount: album.trackCount || 0,
                                primaryGenreName: album.primaryGenreName || '',
                                source: 'iTunes'
                            }));
                    }

                    // Merge iTunes results with Last.fm popularity data
                    const mergedResults = itunesResults.map(itunes => {
                        const matchingLastfm = lastfmCanonical.find(lfm => {
                            const itunesTitleNorm = normalizeString(itunes.title);
                            const itunesArtistNorm = normalizeString(itunes.artist);
                            const lfmTitleNorm = normalizeString(lfm.title);
                            const lfmArtistNorm = normalizeString(lfm.artist);

                            return itunesTitleNorm === lfmTitleNorm && itunesArtistNorm === lfmArtistNorm;
                        });

                        return {
                            ...itunes,
                            playcount: matchingLastfm?.playcount || 0,
                            listeners: matchingLastfm?.listeners || 0,
                            popularityScore: matchingLastfm?.popularityScore || 0
                        };
                    });

                    // Add Last.fm albums that weren't in iTunes
                    const lastfmOnly = lastfmCanonical.filter(lfm => {
                        return !mergedResults.some(merged => {
                            const mergedTitleNorm = normalizeString(merged.title);
                            const mergedArtistNorm = normalizeString(merged.artist);
                            const lfmTitleNorm = normalizeString(lfm.title);
                            const lfmArtistNorm = normalizeString(lfm.artist);

                            return mergedTitleNorm === lfmTitleNorm && mergedArtistNorm === lfmArtistNorm;
                        });
                    }).map(lfm => ({
                        id: `lastfm-${Math.random()}-${lfm.title}`,
                        title: lfm.title,
                        artist: lfm.artist,
                        image: lfm.image,
                        year: '',
                        playcount: lfm.playcount,
                        listeners: lfm.listeners,
                        popularityScore: lfm.popularityScore,
                        source: 'Last.fm'
                    }));

                    const allResults = [...mergedResults, ...lastfmOnly];

                    // Remove exact duplicates
                    const seen = new Map();
                    const uniqueResults = [];
                    for (const album of allResults) {
                        const key = `${normalizeString(album.title)}|||${normalizeString(album.artist)}`;
                        if (!seen.has(key)) {
                            seen.set(key, true);
                            uniqueResults.push(album);
                        }
                    }

                    // Advanced sorting with popularity bias
                    const queryNorm = normalizeString(searchQuery);
                    const sortedResults = uniqueResults.sort((a, b) => {
                        const aTitleNorm = normalizeString(a.title);
                        const bTitleNorm = normalizeString(b.title);

                        // Exact title match
                        const aExactTitle = aTitleNorm === queryNorm;
                        const bExactTitle = bTitleNorm === queryNorm;
                        if (aExactTitle && !bExactTitle) return -1;
                        if (!aExactTitle && bExactTitle) return 1;

                        // Both exact matches - sort by popularity
                        if (aExactTitle && bExactTitle) {
                            if (a.popularityScore !== b.popularityScore) {
                                return b.popularityScore - a.popularityScore;
                            }
                        }

                        // Title starts with query
                        const aStartsTitle = aTitleNorm.startsWith(queryNorm);
                        const bStartsTitle = bTitleNorm.startsWith(queryNorm);
                        if (aStartsTitle && !bStartsTitle) return -1;
                        if (!aStartsTitle && bStartsTitle) return 1;

                        // Both start with query - sort by popularity heavily
                        if (aStartsTitle && bStartsTitle) {
                            if (a.popularityScore > 10000 && b.popularityScore < 10000) return -1;
                            if (b.popularityScore > 10000 && a.popularityScore < 10000) return 1;
                            if (a.popularityScore !== b.popularityScore) {
                                return b.popularityScore - a.popularityScore;
                            }
                        }

                        // Contains query in title
                        const aContainsTitle = aTitleNorm.includes(queryNorm);
                        const bContainsTitle = bTitleNorm.includes(queryNorm);
                        if (aContainsTitle && !bContainsTitle) return -1;
                        if (!aContainsTitle && bContainsTitle) return 1;

                        // Sort by popularity for everything else
                        if (a.popularityScore !== b.popularityScore) {
                            return b.popularityScore - a.popularityScore;
                        }

                        // Finally by year
                        if (a.year && b.year && a.year !== b.year) {
                            return b.year - a.year;
                        }

                        return 0;
                    });

                    setSearchResults(sortedResults.slice(0, 40));
                } catch (error) {
                    console.error('Search error:', error);
                }
                setLoading(false);
            }, [searchQuery]);

            const searchArtistForAlbums = useCallback(async () => {
                if (!artistSearchQuery.trim()) return;
                setLoadingArtist(true);
                setArtistSuggestions([]);

                try {
                    const data = await jsonpRequest(
                        `https://itunes.apple.com/search?term=${encodeURIComponent(artistSearchQuery)}&entity=musicArtist&limit=20`
                    );

                    if (data.results) {
                        const seen = new Set();
                        const artists = data.results.filter(item => {
                            if (item.wrapperType !== 'artist') return false;
                            const name = item.artistName.toLowerCase();
                            if (seen.has(name)) return false;
                            seen.add(name);
                            return true;
                        });
                        setArtistSuggestions(artists);
                    }
                } catch (err) {
                    console.error('Artist search error:', err);
                }
                setLoadingArtist(false);
            }, [artistSearchQuery]);

            const selectArtistAndLoadAlbums = useCallback(async (artist) => {
                setLoadingArtist(true);
                setSelectedArtist(artist);
                setArtistAlbums([]);

                try {
                    const data = await jsonpRequest(
                        `https://itunes.apple.com/lookup?id=${artist.artistId}&entity=album&limit=200`
                    );

                    if (data.results && data.results.length > 1) {
                        const albums = data.results.slice(1).filter(item => item.wrapperType === 'collection').map(album => ({
                            id: `itunes-${album.collectionId}`,
                            title: album.collectionName,
                            artist: album.artistName,
                            image: album.artworkUrl100.replace('100x100', '600x600'),
                            year: album.releaseDate ? new Date(album.releaseDate).getFullYear() : '',
                            collectionId: album.collectionId,
                            source: 'iTunes'
                        })).sort((a, b) => (b.year || 0) - (a.year || 0));
                        setArtistAlbums(albums);
                    }
                } catch (err) {
                    console.error('Album loading error:', err);
                }
                setLoadingArtist(false);
            }, []);

            const selectAlbumAndLoadSongs = useCallback(async (album) => {
                setLoadingSongs(true);
                setSelectedAlbum(album);
                setAlbumSongs([]);

                try {
                    const data = await jsonpRequest(
                        `https://itunes.apple.com/lookup?id=${album.collectionId}&entity=song&limit=200`
                    );

                    if (data.results && data.results.length > 1) {
                        const songs = data.results.slice(1).filter(item => item.wrapperType === 'track').sort((a, b) => (a.trackNumber || 0) - (b.trackNumber || 0)).map(track => ({
                            id: `track-${track.trackId}`,
                            title: track.trackName,
                            artist: track.artistName,
                            image: album.image,
                            albumTitle: album.title,
                            trackNumber: track.trackNumber,
                            collectionId: album.collectionId
                        }));
                        setAlbumSongs(songs);
                    }
                } catch (err) {
                    console.error('Song loading error:', err);
                }
                setLoadingSongs(false);
            }, []);

            const fetchAlbumTracks = useCallback(async (album) => {
                if (!album.collectionId) return [];

                try {
                    const data = await jsonpRequest(
                        `https://itunes.apple.com/lookup?id=${album.collectionId}&entity=song&limit=200`
                    );

                    if (data.results && data.results.length > 1) {
                        return data.results.slice(1).filter(item => item.wrapperType === 'track').sort((a, b) => (a.trackNumber || 0) - (b.trackNumber || 0)).map(track => ({
                            id: `track-${track.trackId}`,
                            title: track.trackName,
                            artist: track.artistName,
                            image: album.image,
                            albumTitle: album.title,
                            trackNumber: track.trackNumber,
                            collectionId: album.collectionId
                        }));
                    }
                } catch (err) {
                    console.error('Track fetch error:', err);
                }
                return [];
            }, []);

            const handleDragStart = useCallback((e, item, fromTier) => {
                setDraggedItem(item);
                setDraggedFrom(fromTier);
                e.dataTransfer.effectAllowed = 'move';
                e.currentTarget.classList.add('dragging');
            }, []);

            const handleDragEnd = useCallback((e) => {
                e.currentTarget.classList.remove('dragging');
                setDragOverTier(null);
                setDraggedItem(null);
                setDraggedFrom(null);
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
            }, []);

            const handleDragOver = useCallback((e, tier) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverTier(tier);

                const y = e.clientY;
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }

                if (y < 100) {
                    scrollIntervalRef.current = setInterval(() => window.scrollBy(0, -10), 16);
                } else if (y > window.innerHeight - 100) {
                    scrollIntervalRef.current = setInterval(() => window.scrollBy(0, 10), 16);
                }
            }, []);

            const handleDragLeave = useCallback(() => {
                setDragOverTier(null);
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
            }, []);

            const handleDrop = useCallback((e, toTier) => {
                e.preventDefault();
                setDragOverTier(null);
                if (!draggedItem) return;

                setTiers(prev => {
                    const newTiers = { ...prev };
                    if (draggedFrom !== null) {
                        newTiers[draggedFrom] = newTiers[draggedFrom].filter(item => item.id !== draggedItem.id);
                    }
                    if (!newTiers[toTier]) {
                        newTiers[toTier] = [];
                    }
                    newTiers[toTier] = [...newTiers[toTier], draggedItem];
                    saveToHistory(newTiers);
                    return newTiers;
                });

                setDraggedItem(null);
                setDraggedFrom(null);
            }, [draggedItem, draggedFrom, saveToHistory]);

            const removeItem = useCallback((tier, itemId) => {
                setTiers(prev => {
                    const newTiers = {
                        ...prev,
                        [tier]: prev[tier].filter(item => item.id !== itemId)
                    };
                    saveToHistory(newTiers);
                    return newTiers;
                });
            }, [saveToHistory]);

            const moveItemToFront = useCallback((tier, itemId) => {
                setTiers(prev => {
                    const newTiers = { ...prev };
                    const item = newTiers[tier].find(i => i.id === itemId);
                    if (!item) return prev;

                    newTiers[tier] = [item, ...newTiers[tier].filter(i => i.id !== itemId)];
                    saveToHistory(newTiers);
                    return newTiers;
                });
            }, [saveToHistory]);

            const moveItemToEnd = useCallback((tier, itemId) => {
                setTiers(prev => {
                    const newTiers = { ...prev };
                    const item = newTiers[tier].find(i => i.id === itemId);
                    if (!item) return prev;

                    newTiers[tier] = [...newTiers[tier].filter(i => i.id !== itemId), item];
                    saveToHistory(newTiers);
                    return newTiers;
                });
            }, [saveToHistory]);

            const openRenameModal = useCallback((tier, item) => {
                setRenameItem({ tier, item });
                setRenameTitle(item.title);
                setRenameModalOpen(true);
            }, []);

            const confirmRename = useCallback(() => {
                if (!renameItem) return;
                setTiers(prev => ({
                    ...prev,
                    [renameItem.tier]: prev[renameItem.tier].map(item =>
                        item.id === renameItem.item.id ? { ...item, title: renameTitle } : item
                    )
                }));
                setRenameModalOpen(false);
                setRenameItem(null);
                setRenameTitle('');
            }, [renameItem, renameTitle]);

            const createCustomTile = useCallback(() => {
                if (!newTileTitle.trim()) return;

                const newTile = {
                    id: `custom-${Date.now()}-${Math.random()}`,
                    title: newTileTitle,
                    image: `data:image/svg+xml,${encodeURIComponent(`<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="200" fill="${newTileColor}"/></svg>`)}`,
                    artist: 'Custom',
                    custom: true,
                    color: newTileColor
                };

                setTiers(prev => ({
                    ...prev,
                    unranked: [...prev.unranked, newTile]
                }));

                setCreateTileModalOpen(false);
                setNewTileTitle('');
                setNewTileColor('#8b5cf6');
            }, [newTileTitle, newTileColor]);

            const toggleSongsMode = useCallback(async () => {
                setModeWarningOpen(true);
            }, []);

            const confirmModeSwitch = useCallback(async () => {
                setModeWarningOpen(false);

                if (!songsMode) {
                    setAlbumBackup(JSON.parse(JSON.stringify(tiers)));
                    const newTiers = {};
                    tierNames.forEach(tierName => {
                        newTiers[tierName] = [];
                    });
                    newTiers.unranked = [];

                    const seenSongs = new Set();

                    for (const tierName of Object.keys(tiers)) {
                        const albums = tiers[tierName];
                        for (const album of albums) {
                            if (album.collectionId) {
                                const tracks = await fetchAlbumTracks(album);
                                for (const track of tracks) {
                                    const songKey = `${normalizeString(track.title)}|||${normalizeString(track.artist)}|||${track.collectionId}`;
                                    if (!seenSongs.has(songKey)) {
                                        seenSongs.add(songKey);
                                        newTiers.unranked.push(track);
                                    }
                                }
                            }
                        }
                    }
                    setTiers(newTiers);
                    setSongsMode(true);
                } else {
                    if (albumBackup) {
                        const newTiers = {};
                        tierNames.forEach(tierName => {
                            newTiers[tierName] = [];
                        });
                        const allAlbums = Object.values(albumBackup).flat();
                        newTiers.unranked = allAlbums;
                        setTiers(newTiers);
                        setAlbumBackup(null);
                    }
                    setSongsMode(false);
                }
            }, [songsMode, tiers, albumBackup, fetchAlbumTracks, tierNames]);

            const bulkMoveTiers = useCallback(() => {
                if (!bulkMoveFrom || !bulkMoveTo || bulkMoveFrom === bulkMoveTo) {
                    alert('Please select different source and destination tiers');
                    return;
                }

                setTiers(prev => {
                    const newTiers = { ...prev };
                    const itemsToMove = [...newTiers[bulkMoveFrom]];

                    if (!newTiers[bulkMoveTo]) {
                        newTiers[bulkMoveTo] = [];
                    }

                    newTiers[bulkMoveTo] = [...newTiers[bulkMoveTo], ...itemsToMove];
                    newTiers[bulkMoveFrom] = [];

                    saveToHistory(newTiers);
                    return newTiers;
                });

                setBulkMoveFrom('');
                setBulkMoveTo('');
            }, [bulkMoveFrom, bulkMoveTo, saveToHistory]);

            const exportAsImage = useCallback(async () => {
                if (!tierListRef.current) return;

                try {
                    const style = document.createElement('style');
                    style.id = 'export-style';
                    style.textContent = '.group:hover > div { opacity: 1 !important; } .group > div { opacity: 0 !important; }';
                    document.head.appendChild(style);

                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvas = await html2canvas(tierListRef.current, {
                        backgroundColor: '#1a1a1a',
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });

                    document.getElementById('export-style')?.remove();

                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = `tier-list-${Date.now()}.png`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Failed to export. Try a different browser.');
                }
            }, []);

            const exportData = useCallback(() => {
                const exportTiers = albumBackup || tiers;
                const data = { tiers: exportTiers, title, tierNames, tierColors };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `tier-list-${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }, [tiers, albumBackup, title, tierNames, tierColors]);

            const exportToCSV = useCallback(() => {
                let csv = 'Tier,Title,Artist,Year\n';

                tierNames.forEach(tierName => {
                    (tiers[tierName] || []).forEach(item => {
                        const title = `"${(item.title || '').replace(/"/g, '""')}"`;
                        const artist = `"${(item.artist || '').replace(/"/g, '""')}"`;
                        const year = item.year || '';
                        csv += `${tierName},${title},${artist},${year}\n`;
                    });
                });

                (tiers.unranked || []).forEach(item => {
                    const title = `"${(item.title || '').replace(/"/g, '""')}"`;
                    const artist = `"${(item.artist || '').replace(/"/g, '""')}"`;
                    const year = item.year || '';
                    csv += `Unranked,${title},${artist},${year}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `tier-list-${Date.now()}.csv`;
                link.click();
                URL.revokeObjectURL(url);
            }, [tiers, tierNames]);

            const importData = useCallback((event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.tiers) {
                            alert('Invalid file');
                            return;
                        }
                        setSongsMode(false);
                        setAlbumBackup(null);

                        if (data.tierNames) {
                            setTierNames(data.tierNames);
                        }
                        if (data.tierColors) {
                            setTierColors(data.tierColors);
                        }

                        const reconstructedTiers = { ...data.tiers };
                        const namesArray = data.tierNames || DEFAULT_TIERS;
                        namesArray.forEach(tierName => {
                            if (!reconstructedTiers[tierName]) {
                                reconstructedTiers[tierName] = [];
                            }
                        });
                        if (!reconstructedTiers.unranked) {
                            reconstructedTiers.unranked = [];
                        }

                        setTiers(reconstructedTiers);
                        setTitle(data.title || 'My Music Tier List');
                        setSettingsTitleEdit(data.title || 'My Music Tier List');
                        saveToHistory(reconstructedTiers);
                    } catch (err) {
                        alert('Failed to import: ' + err.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }, [saveToHistory]);

            const clearAll = useCallback(() => {
                if (confirm('Clear all items? This cannot be undone.')) {
                    const newTiers = {};
                    tierNames.forEach(tierName => {
                        newTiers[tierName] = [];
                    });
                    newTiers.unranked = [];
                    setTiers(newTiers);
                    setAlbumBackup(null);
                    setSongsMode(false);
                    saveToHistory(newTiers);
                }
            }, [tierNames, saveToHistory]);

            const resetGrid = useCallback(() => {
                if (confirm('Reset grid to default S-F tiers? All items will move to unranked.')) {
                    const allItems = [];
                    Object.values(tiers).forEach(tierItems => {
                        allItems.push(...tierItems);
                    });

                    setTierNames(DEFAULT_TIERS);
                    setTierColors(TIER_COLORS);
                    const newTiers = {
                        S: [], A: [], B: [], C: [], D: [], E: [], F: [],
                        unranked: allItems
                    };
                    setTiers(newTiers);
                    saveToHistory(newTiers);
                }
            }, [tiers, saveToHistory]);

            const handleTitleClick = useCallback(() => {
                setEditingTitle(true);
                setTempTitle(title);
            }, [title]);

            const handleTitleBlur = useCallback(() => {
                setEditingTitle(false);
                if (tempTitle.trim()) {
                    setTitle(tempTitle.trim());
                    setSettingsTitleEdit(tempTitle.trim());
                } else {
                    setTempTitle(title);
                }
            }, [tempTitle, title]);

            const handleTitleKeyPress = useCallback((e) => {
                if (e.key === 'Enter') {
                    handleTitleBlur();
                } else if (e.key === 'Escape') {
                    setEditingTitle(false);
                    setTempTitle(title);
                }
            }, [handleTitleBlur, title]);

            const addNewTier = useCallback(() => {
                const newTierName = String.fromCharCode(65 + tierNames.length);
                if (tierNames.length >= 26) {
                    alert('Maximum 26 tiers reached');
                    return;
                }
                setTierNames(prev => [...prev, newTierName]);
                setTierColors(prev => ({
                    ...prev,
                    [newTierName]: `#${Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0')}`
                }));
                setTiers(prev => ({
                    ...prev,
                    [newTierName]: []
                }));
            }, [tierNames]);

            const removeTier = useCallback((tierName) => {
                if (tierNames.length <= 1) {
                    alert('Must have at least one tier');
                    return;
                }
                if (!confirm(`Remove tier ${tierName}? All items will move to unranked.`)) {
                    return;
                }
                setTiers(prev => {
                    const items = prev[tierName] || [];
                    const newTiers = { ...prev };
                    delete newTiers[tierName];
                    newTiers.unranked = [...newTiers.unranked, ...items];
                    saveToHistory(newTiers);
                    return newTiers;
                });
                setTierNames(prev => prev.filter(n => n !== tierName));
                setTierColors(prev => {
                    const newColors = { ...prev };
                    delete newColors[tierName];
                    return newColors;
                });
            }, [tierNames, saveToHistory]);

            const renameTier = useCallback((oldName, newName) => {
                if (!newName.trim()) return;
                if (oldName === newName) return;
                if (tierNames.includes(newName)) {
                    alert('Tier name already exists');
                    return;
                }

                setTierNames(prev => prev.map(n => n === oldName ? newName : n));
                setTiers(prev => {
                    const newTiers = { ...prev };
                    newTiers[newName] = newTiers[oldName];
                    delete newTiers[oldName];
                    return newTiers;
                });
                setTierColors(prev => {
                    const newColors = { ...prev };
                    newColors[newName] = newColors[oldName];
                    delete newColors[oldName];
                    return newColors;
                });
                setEditingTierName(null);
            }, [tierNames]);

            const updateTierColor = useCallback((tierName, color) => {
                setTierColors(prev => ({
                    ...prev,
                    [tierName]: color
                }));
            }, []);

            const renderTile = (item, tier) => (
                <div
                    key={item.id}
                    draggable
                    onDragStart={(e) => handleDragStart(e, item, tier)}
                    onDragEnd={handleDragEnd}
                    onContextMenu={(e) => {
                        e.preventDefault();
                        openRenameModal(tier, item);
                    }}
                    className="group relative draggable-item"
                >
                    {item.trackNumber !== undefined ? (
                        <div className="w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden relative">
                            <img src={item.image} alt={item.title} className="song-bg" />
                            <div className="relative w-full h-full flex items-center justify-center p-1">
                                <span className="song-title text-white text-[10px] text-center leading-tight line-clamp-3">
                                    {item.title}
                                </span>
                            </div>
                        </div>
                    ) : (
                        <img
                            src={item.image}
                            alt={item.title}
                            className="w-16 h-16 md:w-20 md:h-20 object-cover rounded"
                        />
                    )}
                    <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                        <button
                            onClick={() => openRenameModal(tier, item)}
                            className="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded"
                            title="Rename"
                        >
                            <Pencil className="w-3 h-3" />
                        </button>
                        <button
                            onClick={() => removeItem(tier, item.id)}
                            className="bg-red-500 hover:bg-red-600 text-white p-1 rounded"
                            title="Remove"
                        >
                            <Trash className="w-3 h-3" />
                        </button>
                    </div>
                    {showReorderButtons && (
                        <div className="absolute bottom-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                            <button
                                onClick={() => moveItemToFront(tier, item.id)}
                                className="bg-purple-500 hover:bg-purple-600 text-white p-1 rounded"
                                title="Move to front"
                            >
                                <ArrowLeft className="w-3 h-3" />
                            </button>
                            <button
                                onClick={() => moveItemToEnd(tier, item.id)}
                                className="bg-purple-500 hover:bg-purple-600 text-white p-1 rounded"
                                title="Move to end"
                            >
                                <ArrowRight className="w-3 h-3" />
                            </button>
                        </div>
                    )}
                </div>
            );

            const renderUnrankedSection = () => (
                <div className="mt-4">
                    <h3 className="text-white text-base font-semibold mb-2">Unranked</h3>
                    <div
                        onDragOver={(e) => handleDragOver(e, 'unranked')}
                        onDragLeave={handleDragLeave}
                        onDrop={(e) => handleDrop(e, 'unranked')}
                        className={`tier-slot rounded-lg bg-white/5 p-3 flex flex-wrap gap-2 ${dragOverTier === 'unranked' ? 'drag-over' : ''}`}
                        style={{ minHeight: '120px' }}
                    >
                        <div
                            onClick={() => setCreateTileModalOpen(true)}
                            className="w-16 h-16 md:w-20 md:h-20 rounded bg-purple-500/20 border-2 border-dashed border-purple-500/50 flex items-center justify-center cursor-pointer hover:bg-purple-500/30 transition-all"
                        >
                            <Plus className="w-8 h-8 text-purple-400" />
                        </div>
                        {tiers.unranked.length === 0 && (
                            <span className="text-white/30 text-sm ml-2 self-center">Add custom tiles or drag items here</span>
                        )}
                        {tiers.unranked.map((item) => renderTile(item, 'unranked'))}
                    </div>
                </div>
            );

            const showUnrankedInSidebar = searchCollapsed && unrankedInSidebar;

            return (
                <div className="min-h-screen bg-black relative overflow-hidden">
                    <AnimatedBackground colors={bgColors} />

                    {undoToast && (
                        <div className="fixed bottom-4 right-4 z-50 undo-toast">
                            <div className="bg-gray-900 border border-white/20 rounded-lg px-4 py-2 shadow-2xl flex items-center gap-2">
                                <RotateCcw className="w-4 h-4 text-green-400" />
                                <span className="text-white text-sm">{undoToast}</span>
                            </div>
                        </div>
                    )}

                    {modeWarningOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-4">Switch Mode</h3>
                                <p className="text-white mb-6">
                                    {songsMode
                                        ? "Switching back to Album mode will move all items to unranked."
                                        : "Switching to Songs mode will convert all albums to their tracks and move them to unranked."
                                    }
                                </p>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setModeWarningOpen(false)}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmModeSwitch}
                                        className="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Continue
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {createTileModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-4">Create Custom Tile</h3>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Title</label>
                                        <input
                                            type="text"
                                            value={newTileTitle}
                                            onChange={(e) => setNewTileTitle(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && createCustomTile()}
                                            placeholder="Enter title"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Color</label>
                                        <div className="flex gap-2">
                                            <input
                                                type="color"
                                                value={newTileColor}
                                                onChange={(e) => setNewTileColor(e.target.value)}
                                                className="w-16 h-10 rounded cursor-pointer"
                                            />
                                            <input
                                                type="text"
                                                value={newTileColor}
                                                onChange={(e) => setNewTileColor(e.target.value)}
                                                className="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setCreateTileModalOpen(false);
                                            setNewTileTitle('');
                                            setNewTileColor('#8b5cf6');
                                        }}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={createCustomTile}
                                        className="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Create
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {renameModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-4">Rename {songsMode ? 'Song' : 'Album'}</h3>
                                <div className="mb-6">
                                    <label className="block text-white text-sm font-medium mb-2">Title</label>
                                    <input
                                        type="text"
                                        value={renameTitle}
                                        onChange={(e) => setRenameTitle(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && confirmRename()}
                                        placeholder="Enter title"
                                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                        autoFocus
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setRenameModalOpen(false);
                                            setRenameItem(null);
                                            setRenameTitle('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmRename}
                                        className="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Rename
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {settingsOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto">
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-xl font-bold text-white">Settings</h3>
                                    <button
                                        onClick={() => setSettingsOpen(false)}
                                        className="text-gray-400 hover:text-white transition-colors"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <h4 className="text-lg font-semibold text-white mb-3">Tier List Title</h4>
                                        <input
                                            type="text"
                                            value={settingsTitleEdit}
                                            onChange={(e) => setSettingsTitleEdit(e.target.value)}
                                            onBlur={() => {
                                                if (settingsTitleEdit.trim()) {
                                                    setTitle(settingsTitleEdit.trim());
                                                    setTempTitle(settingsTitleEdit.trim());
                                                } else {
                                                    setSettingsTitleEdit(title);
                                                }
                                            }}
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                        />
                                    </div>

                                    <div className="border-t border-white/10 pt-6">
                                        <h4 className="text-lg font-semibold text-white mb-3">Layout Options</h4>
                                        <div className="space-y-3">
                                            <label className="flex items-center gap-3 cursor-pointer text-white hover:text-white/80 transition-colors">
                                                <input
                                                    type="checkbox"
                                                    checked={unrankedInSidebar}
                                                    onChange={(e) => setUnrankedInSidebar(e.target.checked)}
                                                    className="w-5 h-5 rounded"
                                                />
                                                <span>Show unranked section on left sidebar (when search is hidden)</span>
                                            </label>
                                            <label className="flex items-center gap-3 cursor-pointer text-white hover:text-white/80 transition-colors">
                                                <input
                                                    type="checkbox"
                                                    checked={showReorderButtons}
                                                    onChange={(e) => setShowReorderButtons(e.target.checked)}
                                                    className="w-5 h-5 rounded"
                                                />
                                                <span>Show reorder buttons (move to front/end)</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div className="border-t border-white/10 pt-6">
                                        <h4 className="text-lg font-semibold text-white mb-3">Bulk Move</h4>
                                        <div className="space-y-3">
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">From Tier</label>
                                                    <select
                                                        value={bulkMoveFrom}
                                                        onChange={(e) => setBulkMoveFrom(e.target.value)}
                                                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                                                    >
                                                        <option value="">Select...</option>
                                                        {[...tierNames, 'unranked'].map(tier => (
                                                            <option key={tier} value={tier}>{tier}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">To Tier</label>
                                                    <select
                                                        value={bulkMoveTo}
                                                        onChange={(e) => setBulkMoveTo(e.target.value)}
                                                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                                                    >
                                                        <option value="">Select...</option>
                                                        {[...tierNames, 'unranked'].map(tier => (
                                                            <option key={tier} value={tier}>{tier}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                            <button
                                                onClick={bulkMoveTiers}
                                                disabled={!bulkMoveFrom || !bulkMoveTo}
                                                className="w-full px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition-colors"
                                            >
                                                Move All Items
                                            </button>
                                        </div>
                                    </div>

                                    <div className="border-t border-white/10 pt-6">
                                        <h4 className="text-lg font-semibold text-white mb-3">Keyboard Shortcuts</h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-white/5 p-3 rounded-lg">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">Ctrl/Cmd</kbd>
                                                    <span className="text-white">+</span>
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">Z</kbd>
                                                </div>
                                                <p className="text-gray-400 text-sm">Undo</p>
                                            </div>
                                            <div className="bg-white/5 p-3 rounded-lg">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">Ctrl/Cmd</kbd>
                                                    <span className="text-white">+</span>
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">Y</kbd>
                                                </div>
                                                <p className="text-gray-400 text-sm">Redo</p>
                                            </div>
                                            <div className="bg-white/5 p-3 rounded-lg">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">Ctrl/Cmd</kbd>
                                                    <span className="text-white">+</span>
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">H</kbd>
                                                </div>
                                                <p className="text-gray-400 text-sm">Toggle Search</p>
                                            </div>
                                            <div className="bg-white/5 p-3 rounded-lg">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">Ctrl/Cmd</kbd>
                                                    <span className="text-white">+</span>
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">E</kbd>
                                                </div>
                                                <p className="text-gray-400 text-sm">Export PNG</p>
                                            </div>
                                            <div className="bg-white/5 p-3 rounded-lg">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">Ctrl/Cmd</kbd>
                                                    <span className="text-white">+</span>
                                                    <kbd className="px-2 py-1 bg-white/10 rounded text-sm text-white">S</kbd>
                                                </div>
                                                <p className="text-gray-400 text-sm">Export JSON</p>
                                            </div>
                                            <div className="bg-white/5 p-3 rounded-lg">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-white text-sm">Right-click item</span>
                                                </div>
                                                <p className="text-gray-400 text-sm">Quick Rename</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border-t border-white/10 pt-6">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="text-lg font-semibold text-white">Manage Tiers</h4>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={resetGrid}
                                                    className="px-3 py-1 bg-orange-500/20 hover:bg-orange-500/30 text-white rounded-lg border border-orange-500/50 flex items-center gap-2 transition-colors text-sm"
                                                >
                                                    <RefreshCw className="w-4 h-4" />
                                                    Reset Grid
                                                </button>
                                                <button
                                                    onClick={addNewTier}
                                                    className="px-3 py-1 bg-green-500/20 hover:bg-green-500/30 text-white rounded-lg border border-green-500/50 flex items-center gap-2 transition-colors text-sm"
                                                >
                                                    <Plus className="w-4 h-4" />
                                                    Add Tier
                                                </button>
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            {tierNames.map((tierName) => (
                                                <div key={tierName} className="flex items-center gap-3 bg-white/5 p-3 rounded-lg">
                                                    {editingTierName === tierName ? (
                                                        <input
                                                            type="text"
                                                            value={tempTierName}
                                                            onChange={(e) => setTempTierName(e.target.value)}
                                                            onBlur={() => {
                                                                renameTier(tierName, tempTierName);
                                                            }}
                                                            onKeyDown={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    renameTier(tierName, tempTierName);
                                                                } else if (e.key === 'Escape') {
                                                                    setEditingTierName(null);
                                                                }
                                                            }}
                                                            className="w-16 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-center focus:outline-none focus:ring-2 focus:ring-white/50"
                                                            autoFocus
                                                        />
                                                    ) : (
                                                        <button
                                                            onClick={() => {
                                                                setEditingTierName(tierName);
                                                                setTempTierName(tierName);
                                                            }}
                                                            className="w-16 px-2 py-1 bg-white/10 hover:bg-white/20 border border-white/20 rounded text-white font-bold transition-colors"
                                                        >
                                                            {tierName}
                                                        </button>
                                                    )}
                                                    <input
                                                        type="color"
                                                        value={tierColors[tierName]}
                                                        onChange={(e) => updateTierColor(tierName, e.target.value)}
                                                        className="w-12 h-8 rounded cursor-pointer"
                                                    />
                                                    <span className="flex-1 text-white text-sm">
                                                        {tiers[tierName]?.length || 0} items
                                                    </span>
                                                    <button
                                                        onClick={() => removeTier(tierName)}
                                                        className="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-white rounded border border-red-500/50 transition-colors text-sm"
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="relative z-10">
                        <div className="flex flex-wrap justify-between items-center gap-4 pt-6 px-4 md:px-8 pb-4">
                            <a href="sic.html" className="text-2xl md:text-3xl font-bold text-white drop-shadow-lg hover:opacity-80 transition-opacity cursor-pointer">
                                sic tools
                            </a>

                            <div className="flex flex-wrap items-center gap-3">
                                {searchCollapsed && (
                                    <button
                                        onClick={() => setSearchCollapsed(false)}
                                        className="px-3 md:px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-white rounded-lg border border-purple-500/50 flex items-center gap-2 transition-colors"
                                        title="Show search (Ctrl/Cmd+H)"
                                    >
                                        <Search className="w-4 h-4" />
                                    </button>
                                )}

                                <button
                                    onClick={() => undo()}
                                    disabled={historyIndex <= 0}
                                    className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Undo (Ctrl/Cmd+Z)"
                                >
                                    <RotateCcw className="w-4 h-4" />
                                    <span className="hidden sm:inline">Undo</span>
                                </button>

                                <button
                                    onClick={() => redo()}
                                    disabled={historyIndex >= history.length - 1}
                                    className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Redo (Ctrl/Cmd+Y)"
                                >
                                    <RotateCcw className="w-4 h-4 transform scale-x-[-1]" />
                                    <span className="hidden sm:inline">Redo</span>
                                </button>

                                <div
                                    className={`mode-switch ${songsMode ? 'songs' : ''}`}
                                    onClick={toggleSongsMode}
                                >
                                    <div className="mode-switch-slider"></div>
                                    <span className="mode-label left">Albums</span>
                                    <span className="mode-label right">Songs</span>
                                </div>

                                <button
                                    onClick={() => setSettingsOpen(!settingsOpen)}
                                    className="px-4 md:px-5 py-2.5 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                >
                                    <Settings className="w-5 h-5" />
                                </button>

                                <button
                                    onClick={exportAsImage}
                                    className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                    title="Export as PNG (Ctrl/Cmd+E)"
                                >
                                    <Download className="w-4 h-4" />
                                    <span className="hidden sm:inline">PNG</span>
                                </button>

                                <div className="relative group">
                                    <button
                                        className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                    >
                                        <Upload className="w-4 h-4" />
                                        <span className="hidden sm:inline">Export</span>
                                    </button>
                                    <div className="absolute right-0 mt-2 w-48 bg-gray-900 border border-white/20 rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                                        <button
                                            onClick={exportData}
                                            className="w-full px-4 py-2 text-left text-white hover:bg-white/10 rounded-t-lg transition-colors flex items-center gap-2"
                                            title="Export as JSON (Ctrl/Cmd+S)"
                                        >
                                            <FileDown className="w-4 h-4" />
                                            Export JSON
                                        </button>
                                        <button
                                            onClick={exportToCSV}
                                            className="w-full px-4 py-2 text-left text-white hover:bg-white/10 rounded-b-lg transition-colors flex items-center gap-2"
                                        >
                                            <FileDown className="w-4 h-4" />
                                            Export CSV
                                        </button>
                                    </div>
                                </div>

                                <label className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 cursor-pointer transition-colors">
                                    <Download className="w-4 h-4 transform rotate-180" />
                                    <span className="hidden sm:inline">Import</span>
                                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                                </label>

                                <button
                                    onClick={clearAll}
                                    className="px-3 md:px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-white rounded-lg border border-red-500/50 flex items-center gap-2 transition-colors"
                                >
                                    <Trash className="w-4 h-4" />
                                    <span className="hidden sm:inline">Clear</span>
                                </button>
                            </div>
                        </div>

                        <div className="px-4 md:px-8 pb-8 max-w-7xl mx-auto">
                            <div className={`grid gap-4 md:gap-6 transition-all duration-500 ${showUnrankedInSidebar ? 'lg:grid-cols-[360px_1fr]' :
                                    !searchCollapsed ? 'lg:grid-cols-[360px_1fr]' :
                                        'grid-cols-1'
                                }`}>
                                {showUnrankedInSidebar && (
                                    <div className="sticky-sidebar bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                        <h3 className="text-white text-base font-semibold mb-2">Unranked</h3>
                                        <div
                                            onDragOver={(e) => handleDragOver(e, 'unranked')}
                                            onDragLeave={handleDragLeave}
                                            onDrop={(e) => handleDrop(e, 'unranked')}
                                            className={`tier-slot rounded-lg bg-white/5 p-3 flex flex-wrap gap-2 ${dragOverTier === 'unranked' ? 'drag-over' : ''}`}
                                            style={{ minHeight: '120px' }}
                                        >
                                            <div
                                                onClick={() => setCreateTileModalOpen(true)}
                                                className="w-16 h-16 md:w-20 md:h-20 rounded bg-purple-500/20 border-2 border-dashed border-purple-500/50 flex items-center justify-center cursor-pointer hover:bg-purple-500/30 transition-all"
                                            >
                                                <Plus className="w-8 h-8 text-purple-400" />
                                            </div>
                                            {tiers.unranked.length === 0 && (
                                                <span className="text-white/30 text-sm ml-2 self-center">Add custom tiles or drag items here</span>
                                            )}
                                            {tiers.unranked.map((item) => renderTile(item, 'unranked'))}
                                        </div>
                                    </div>
                                )}

                                {!searchCollapsed && (
                                    <div className="sticky-sidebar bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-bold text-white">Search Panel</h3>
                                            <button
                                                onClick={() => setSearchCollapsed(true)}
                                                className="px-3 py-1 bg-white/10 hover:bg-white/20 text-white rounded-lg text-sm transition-colors"
                                            >
                                                Hide
                                            </button>
                                        </div>
                                        <div className="space-y-4">
                                            <div className="border-t border-white/10 pt-4">
                                                <h3 className="text-lg font-bold text-white mb-3">
                                                    {selectedAlbum ? 'Album Songs' : advancedSearchMode ? 'Search by Artist' : 'Search Albums'}
                                                </h3>

                                                {selectedAlbum ? (
                                                    <div className="space-y-3">
                                                        <button
                                                            onClick={() => {
                                                                setSelectedAlbum(null);
                                                                setAlbumSongs([]);
                                                            }}
                                                            className="w-full px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 transition-colors text-sm flex items-center gap-2"
                                                        >
                                                            <ChevronLeft className="w-4 h-4" />
                                                            Back to Albums
                                                        </button>

                                                        <div className="bg-white/10 rounded-lg p-3 border border-white/20">
                                                            <div className="flex gap-3">
                                                                <img src={selectedAlbum.image} alt={selectedAlbum.title} className="w-16 h-16 rounded object-cover" />
                                                                <div className="flex-1 min-w-0">
                                                                    <p className="text-white text-sm font-medium truncate">{selectedAlbum.title}</p>
                                                                    <p className="text-gray-400 text-xs truncate">{selectedAlbum.artist}</p>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {loadingSongs ? (
                                                            <div className="flex items-center justify-center py-8">
                                                                <Loader2 className="w-6 h-6 text-white" />
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                                                {albumSongs.map((song) => (
                                                                    <div
                                                                        key={song.id}
                                                                        draggable
                                                                        onDragStart={(e) => handleDragStart(e, song, null)}
                                                                        onDragEnd={handleDragEnd}
                                                                        className="draggable-item bg-white/10 rounded-lg p-2 flex items-center gap-3 hover:bg-white/20 transition-all border border-white/10"
                                                                    >
                                                                        <div className="w-12 h-12 rounded overflow-hidden relative shrink-0">
                                                                            <img src={song.image} alt={song.title} className="song-bg" />
                                                                            <div className="relative w-full h-full flex items-center justify-center">
                                                                                <span className="text-white text-xs font-bold bg-black/70 px-2 py-1 rounded">
                                                                                    {song.trackNumber}
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <p className="text-white text-sm font-medium truncate">{song.title}</p>
                                                                            <p className="text-gray-400 text-xs truncate">{song.artist}</p>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : !advancedSearchMode ? (
                                                    <div className="space-y-3">
                                                        <div className="flex gap-2">
                                                            <input
                                                                type="text"
                                                                value={searchQuery}
                                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                                onKeyPress={(e) => e.key === 'Enter' && searchAlbums()}
                                                                placeholder="Search albums..."
                                                                className="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                            />
                                                            <button
                                                                onClick={searchAlbums}
                                                                disabled={loading}
                                                                className="px-4 py-2 bg-white text-black hover:bg-gray-100 disabled:bg-gray-600 rounded-lg font-semibold transition-colors"
                                                            >
                                                                {loading ? <Loader2 className="w-5 h-5" /> : <Search className="w-5 h-5" />}
                                                            </button>
                                                        </div>

                                                        <button
                                                            onClick={() => setAdvancedSearchMode(true)}
                                                            className="w-full px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-white rounded-lg border border-purple-500/50 flex items-center justify-center gap-2 transition-colors"
                                                        >
                                                            <Music className="w-5 h-5" />
                                                            Search by Artist
                                                        </button>

                                                        <div className="max-h-[400px] overflow-y-auto space-y-2">
                                                            {searchResults.map((album) => (
                                                                <div
                                                                    key={album.id}
                                                                    className="bg-white/10 rounded-lg p-2 border border-white/10 hover:bg-white/20 transition-all"
                                                                >
                                                                    <div
                                                                        draggable={!songsMode}
                                                                        onDragStart={(e) => !songsMode && handleDragStart(e, album, null)}
                                                                        onDragEnd={handleDragEnd}
                                                                        onClick={() => songsMode && album.collectionId && selectAlbumAndLoadSongs(album)}
                                                                        className={`flex items-center gap-3 ${songsMode && album.collectionId ? 'cursor-pointer' : 'draggable-item'}`}
                                                                    >
                                                                        <img src={album.image} alt={album.title} className="w-12 h-12 rounded object-cover" />
                                                                        <div className="flex-1 min-w-0">
                                                                            <p className="text-white text-sm font-medium truncate">{album.title}</p>
                                                                            <p className="text-gray-400 text-xs truncate">{album.artist} {album.year && `(${album.year})`}</p>
                                                                        </div>
                                                                        {songsMode && album.collectionId && (
                                                                            <ChevronLeft className="w-5 h-5 text-white transform rotate-180" />
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-3">
                                                        <div className="flex gap-2">
                                                            <input
                                                                type="text"
                                                                value={artistSearchQuery}
                                                                onChange={(e) => setArtistSearchQuery(e.target.value)}
                                                                onKeyPress={(e) => e.key === 'Enter' && searchArtistForAlbums()}
                                                                placeholder="Search artists..."
                                                                className="flex-1 px-4 py-2 bg-purple-500/10 border border-purple-500/30 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500/50"
                                                            />
                                                            <button
                                                                onClick={searchArtistForAlbums}
                                                                disabled={loadingArtist}
                                                                className="px-4 py-2 bg-purple-500 text-white hover:bg-purple-600 disabled:bg-gray-600 rounded-lg font-semibold transition-colors"
                                                            >
                                                                {loadingArtist ? <Loader2 className="w-5 h-5" /> : <Search className="w-5 h-5" />}
                                                            </button>
                                                        </div>

                                                        <button
                                                            onClick={() => {
                                                                setAdvancedSearchMode(false);
                                                                setSelectedArtist(null);
                                                                setArtistAlbums([]);
                                                                setArtistSuggestions([]);
                                                            }}
                                                            className="w-full px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 transition-colors text-sm flex items-center gap-2"
                                                        >
                                                            <ChevronLeft className="w-4 h-4" />
                                                            Back to Album Search
                                                        </button>

                                                        {selectedArtist ? (
                                                            <div className="space-y-2">
                                                                <div className="flex items-center justify-between bg-white/10 rounded-lg p-3 border border-white/20">
                                                                    <span className="text-white text-sm font-medium">{selectedArtist.artistName}</span>
                                                                    <button
                                                                        onClick={() => {
                                                                            setSelectedArtist(null);
                                                                            setArtistAlbums([]);
                                                                        }}
                                                                        className="text-gray-400 hover:text-white text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded transition-colors"
                                                                    >
                                                                        Change
                                                                    </button>
                                                                </div>
                                                                {loadingArtist ? (
                                                                    <div className="flex items-center justify-center py-4">
                                                                        <Loader2 className="w-6 h-6 text-white" />
                                                                    </div>
                                                                ) : (
                                                                    <div className="grid grid-cols-2 gap-2 max-h-[400px] overflow-y-auto">
                                                                        {artistAlbums.map((album) => (
                                                                            <div
                                                                                key={album.id}
                                                                                className="bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all border border-white/10"
                                                                            >
                                                                                <div
                                                                                    draggable={!songsMode}
                                                                                    onDragStart={(e) => !songsMode && handleDragStart(e, album, null)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onClick={() => songsMode && selectAlbumAndLoadSongs(album)}
                                                                                    className={songsMode ? 'cursor-pointer' : 'draggable-item'}
                                                                                >
                                                                                    <img src={album.image} alt={album.title} className="w-full aspect-square rounded object-cover mb-1" />
                                                                                    <p className="text-white text-xs font-medium truncate">{album.title}</p>
                                                                                    <p className="text-gray-400 text-[10px] truncate">{album.year}</p>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ) : artistSuggestions.length > 0 && (
                                                            <div className="space-y-1 max-h-[400px] overflow-y-auto">
                                                                {artistSuggestions.map((artist) => (
                                                                    <button
                                                                        key={artist.artistId}
                                                                        onClick={() => selectArtistAndLoadAlbums(artist)}
                                                                        className="w-full text-left px-3 py-2 bg-purple-500/10 hover:bg-purple-500/20 rounded-lg text-white text-sm transition-colors border border-purple-500/20"
                                                                    >
                                                                        {artist.artistName}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                    <div ref={tierListRef} style={{ backgroundColor: '#1a1a1a' }} className="p-4 md:p-6 rounded-xl">
                                        {editingTitle ? (
                                            <input
                                                ref={titleInputRef}
                                                type="text"
                                                value={tempTitle}
                                                onChange={(e) => setTempTitle(e.target.value)}
                                                onBlur={handleTitleBlur}
                                                onKeyDown={handleTitleKeyPress}
                                                className="text-xl md:text-2xl font-bold text-white text-center mb-4 bg-white/10 border border-white/20 rounded-lg px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-white/50"
                                            />
                                        ) : (
                                            <h2
                                                onClick={handleTitleClick}
                                                className="editable-title text-xl md:text-2xl font-bold text-white mb-4"
                                            >
                                                {title}
                                            </h2>
                                        )}

                                        {tierNames.map((tierName) => (
                                            <div key={tierName} className="flex mb-2">
                                                <div
                                                    className="w-14 md:w-16 flex items-center justify-center text-xl md:text-2xl font-bold text-black rounded-l-lg shrink-0"
                                                    style={{ backgroundColor: tierColors[tierName] }}
                                                >
                                                    {tierName}
                                                </div>
                                                <div
                                                    onDragOver={(e) => handleDragOver(e, tierName)}
                                                    onDragLeave={handleDragLeave}
                                                    onDrop={(e) => handleDrop(e, tierName)}
                                                    className={`flex-1 tier-slot rounded-r-lg bg-white/5 p-2 flex flex-wrap gap-2 items-center ${dragOverTier === tierName ? 'drag-over' : ''}`}
                                                >
                                                    {tiers[tierName]?.length === 0 && (
                                                        <span className="text-white/30 text-sm">Drag items here</span>
                                                    )}
                                                    {(tiers[tierName] || []).map((item) => renderTile(item, tierName))}
                                                </div>
                                            </div>
                                        ))}

                                        {!showUnrankedInSidebar && renderUnrankedSection()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TierListApp />, document.getElementById('root'));
    </script>
    <!-- Help Button -->
    <button id="helpBtn"
        onclick="document.getElementById('helpModal').classList.remove('hidden'); document.body.style.overflow='hidden';"
        class="fixed bottom-6 right-6 w-12 h-12 flex items-center justify-center rounded-full z-40 transition-all duration-300 hover:scale-110 active:scale-95"
        style="background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(20px); box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
        style="background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);"
        onclick="if(event.target===this){this.classList.add('hidden');document.body.style.overflow='auto';}">
        <div class="w-full max-w-2xl" onclick="event.stopPropagation()">
            <div class="rounded-3xl p-8 shadow-2xl"
                style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(40px);">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-3xl font-bold text-white">Tier List</h3>
                    <button
                        onclick="document.getElementById('helpModal').classList.add('hidden');document.body.style.overflow='auto';"
                        class="w-10 h-10 flex items-center justify-center rounded-full transition-all"
                        style="background: rgba(255,255,255,0.1);">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="text-gray-200 space-y-4 overflow-y-auto pr-2" style="max-height: 60vh;">
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-xl font-semibold text-white mb-2">What is This?</h4>
                            <p class="text-gray-300">A drag-and-drop tier list maker for music. Place albums or songs
                                into tiers (S, A, B, C) yourself. Unlike the Ranker there's no algorithm  you decide
                                everything.</p>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold text-white mb-2">Getting Started</h4>
                            <ul class="space-y-2 text-gray-300">
                                <li><strong>Album mode:</strong> search and add albums, then drag them into tiers</li>
                                <li><strong>Song mode:</strong> toggle the Album/Song switch at the top to rank
                                    individual tracks instead</li>
                                <li>Items start in the Unranked section  drag them into tiers when you're ready</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold text-white mb-2">Tips & Tricks</h4>
                            <ul class="space-y-2 text-gray-300">
                                <li><strong>Right-click to rename:</strong> right-click any tile to rename it</li>
                                <li><strong>Settings panel:</strong> rename tiers, change tier colours, add/remove
                                    tiers, bulk-move items</li>
                                <li><strong>Custom tiles:</strong> create your own tile with custom text and colour</li>
                                <li><strong>Collapse search:</strong> hide the search sidebar once you're done adding
                                    items</li>
                                <li><strong>Auto-save:</strong> your tier list saves automatically to the browser</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold text-white mb-2">Exporting</h4>
                            <ul class="space-y-2 text-gray-300">
                                <li><strong>Export as image:</strong> downloads a PNG screenshot of your tier list</li>
                                <li><strong>Save as JSON:</strong> exports the raw data  useful for sharing or resuming
                                    later</li>
                            </ul>
                        </div>
                        <div class="rounded-xl p-4"
                            style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                            <h4 class="text-base font-semibold text-white mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                </svg>
                                Keyboard Shortcuts
                            </h4>
                            <div class="space-y-2 text-sm text-gray-300">
                                <div class="flex items-center justify-between"><span>Undo</span><kbd
                                        class="px-2 py-0.5 rounded text-xs"
                                        style="background:rgba(255,255,255,0.1);">/Ctrl Z</kbd></div>
                                <div class="flex items-center justify-between"><span>Redo</span><span
                                        class="flex gap-1"><kbd class="px-2 py-0.5 rounded text-xs"
                                            style="background:rgba(255,255,255,0.1);">/Ctrl  Z</kbd><span
                                            class="text-gray-500 text-xs mx-1">or</span><kbd
                                            class="px-2 py-0.5 rounded text-xs"
                                            style="background:rgba(255,255,255,0.1);">/Ctrl Y</kbd></span></div>
                                <div class="flex items-center justify-between"><span>Toggle search sidebar</span><kbd
                                        class="px-2 py-0.5 rounded text-xs"
                                        style="background:rgba(255,255,255,0.1);">/Ctrl H</kbd></div>
                                <div class="flex items-center justify-between"><span>Export as image</span><kbd
                                        class="px-2 py-0.5 rounded text-xs"
                                        style="background:rgba(255,255,255,0.1);">/Ctrl E</kbd></div>
                                <div class="flex items-center justify-between"><span>Save as JSON</span><kbd
                                        class="px-2 py-0.5 rounded text-xs"
                                        style="background:rgba(255,255,255,0.1);">/Ctrl S</kbd></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('helpModal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        });
    </script>
</body>

</html>
