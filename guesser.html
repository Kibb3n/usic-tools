<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guesser - Î¼sic tools</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        html, body { background: #000; }
        @keyframes blob1 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(150px, 100px) scale(1.2);
            }

            66% {
                transform: translate(-100px, 150px) scale(0.9);
            }
        }

        @keyframes blob2 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(-150px, -100px) scale(0.9);
            }

            66% {
                transform: translate(100px, -150px) scale(1.2);
            }
        }

        .grain {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='3.5' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.3'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        .dropdown-selected {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            color: #000000 !important;
        }

        .dropdown-not-selected {
            background: rgba(255, 255, 255, 0.5);
            color: #6b7280 !important;
        }

        .horizontal-scroll {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scroll-snap-type: x mandatory;
        }
        .horizontal-scroll::-webkit-scrollbar {
            height: 4px;
        }
        .horizontal-scroll::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 2px;
        }
        .horizontal-scroll::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }
        .horizontal-scroll > * {
            flex: 0 0 260px;
            scroll-snap-align: start;
        }
    </style>
</head>

<body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // Constants
        const MAX_GUESSES = 6;
        const MAX_PINNED = 8;
        const MAX_RECENT = 6;
        const ITEMS_PER_PAGE = 10;

        // --- Icons ---
        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const ArrowLeft = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        );

        const ChevronRight = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
        );

        const ChevronDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
            </svg>
        );

        const Plus = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const Copy = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );

        const TrendingUp = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
        );

        const TrendingDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
            </svg>
        );

        const Pin = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
            </svg>
        );

        const PinFilled = ({ className }) => (
            <svg className={className} fill="currentColor" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
            </svg>
        );

        // --- Utility functions ---
        const jsonpRequest = (url) => {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                const script = document.createElement('script');
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                document.body.appendChild(script);
            });
        };

        const extractDominantColor = async (imageUrl) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 50;
                        canvas.height = 50;
                        ctx.drawImage(img, 0, 0, 50, 50);
                        const data = ctx.getImageData(10, 10, 30, 30).data;

                        let r = 0, g = 0, b = 0;
                        for (let i = 0; i < data.length; i += 4) {
                            r += data[i];
                            g += data[i + 1];
                            b += data[i + 2];
                        }
                        const pixels = data.length / 4;
                        resolve(`rgb(${Math.floor(r / pixels)}, ${Math.floor(g / pixels)}, ${Math.floor(b / pixels)})`);
                    } catch (e) {
                        resolve('#ff0080');
                    }
                };
                img.onerror = () => resolve('#ff0080');
                img.src = imageUrl;
            });
        };

        const getRandomColor = () => {
            const colors = ['#ff0080', '#7928ca', '#00dfd8', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'];
            return colors[Math.floor(Math.random() * colors.length)];
        };

        // LocalStorage helper with quota handling
        const storage = {
            get: (key, defaultValue) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch {
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                    try {
                        const recentGames = JSON.parse(localStorage.getItem('guesser_recent_games') || '[]');
                        if (recentGames.length > 3) {
                            localStorage.setItem('guesser_recent_games', JSON.stringify(recentGames.slice(0, 3)));
                            localStorage.setItem(key, JSON.stringify(value));
                            return true;
                        }
                    } catch { }
                    return false;
                }
            }
        };

        // Debounce utility
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // --- Reusable Components ---
        const ConfirmDialog = ({ isOpen, onConfirm, onCancel, title, message }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white/10 backdrop-blur-2xl rounded-2xl p-6 max-w-md w-full border border-white/20">
                        <h3 className="text-xl font-bold text-white mb-3">{title}</h3>
                        <p className="text-gray-300 mb-6">{message}</p>
                        <div className="flex gap-3">
                            <button
                                onClick={onCancel}
                                className="flex-1 px-4 py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl font-semibold border border-white/20"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                className="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-semibold"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Background component ---
        function AnimatedBackground({ colors }) {
            return (
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                    <div
                        className="absolute w-[1000px] h-[1000px] rounded-full blur-3xl"
                        style={{
                            background: `radial-gradient(circle, ${colors[0]} 0%, transparent 60%)`,
                            opacity: 0.85,
                            animation: `blob1 12s ease-in-out infinite`,
                            top: '50%',
                            left: '33.333%',
                            transform: 'translate(-50%, -50%)',
                            transition: 'background 1s ease-in-out'
                        }}
                    />
                    <div
                        className="absolute w-[1000px] h-[1000px] rounded-full blur-3xl"
                        style={{
                            background: `radial-gradient(circle, ${colors[1]} 0%, transparent 60%)`,
                            opacity: 0.85,
                            animation: `blob2 12s ease-in-out infinite`,
                            top: '50%',
                            right: '33.333%',
                            transform: 'translate(50%, -50%)',
                            transition: 'background 1s ease-in-out'
                        }}
                    />
                </div>
            );
        }

        // --- Main Guesser Component ---
        function GuesserMode() {
            const [gameState, setGameState] = useState({
                stage: 'recentGames',
                selectedArtists: [],
                selectedAlbums: [],
                artistAlbums: {},
                allSongs: [],
                targetSong: null,
                guesses: [],
                gameOver: false,
                won: false
            });

            const [searchState, setSearchState] = useState({
                artistName: '',
                suggestions: [],
                page: 0,
                loading: false,
                loadingSongs: false,
                error: ''
            });

            const [currentGuess, setCurrentGuess] = useState('');
            const [selectedSongIndex, setSelectedSongIndex] = useState(0);
            const [bgColors, setBgColors] = useState([getRandomColor(), getRandomColor()]);
            const [recentGames, setRecentGames] = useState([]);
            const [pinnedGames, setPinnedGames] = useState([]);
            const [expandedGame, setExpandedGame] = useState(null);
            const [showAnswer, setShowAnswer] = useState(false);
            const [copied, setCopied] = useState(false);
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, type: null, data: null });
            const [pinnedCollapsed, setPinnedCollapsed] = useState(() => storage.get('guesser_pinned_collapsed', false));
            const [recentCollapsed, setRecentCollapsed] = useState(() => storage.get('guesser_recent_collapsed', false));
            const [showAllPinned, setShowAllPinned] = useState(false);
            const [selectedArtistTab, setSelectedArtistTab] = useState(0);
            const [isSubmittingGuess, setIsSubmittingGuess] = useState(false);
            const [editingGame, setEditingGame] = useState(null);
            const dropdownRef = useRef(null);
            const colorCache = useRef({});

            // Load stats from localStorage (memoized)
            const [stats, setStats] = useState(() => storage.get('guesser_stats', {
                gamesPlayed: 0,
                gamesWon: 0,
                currentStreak: 0,
                maxStreak: 0,
                guessDistribution: [0, 0, 0, 0, 0, 0],
                favoriteArtist: null,
                artistCounts: {}
            }));

            // Load games once on mount
            const [initialLoad, setInitialLoad] = useState(true);
            useEffect(() => {
                if (initialLoad) {
                    setRecentGames(storage.get('guesser_recent_games', []));
                    setPinnedGames(storage.get('guesser_pinned_games', []));
                    setInitialLoad(false);
                }
            }, [initialLoad]);

            // Update background colors based on last two selected albums (not guesses)
            useEffect(() => {
                if (gameState.stage === 'selectAlbums' && gameState.selectedAlbums.length >= 2) {
                    const lastTwo = gameState.selectedAlbums.slice(-2);
                    const getAlbumColor = async (album) => {
                        if (colorCache.current[album.artworkUrl100]) {
                            return colorCache.current[album.artworkUrl100];
                        }
                        const color = await extractDominantColor(album.artworkUrl100);
                        colorCache.current[album.artworkUrl100] = color;
                        return color;
                    };

                    Promise.all([getAlbumColor(lastTwo[0]), getAlbumColor(lastTwo[1])]).then(colors => {
                        setBgColors(colors);
                    });
                } else if (gameState.stage === 'selectAlbums' && gameState.selectedAlbums.length === 1) {
                    const getAlbumColor = async (album) => {
                        if (colorCache.current[album.artworkUrl100]) {
                            return colorCache.current[album.artworkUrl100];
                        }
                        const color = await extractDominantColor(album.artworkUrl100);
                        colorCache.current[album.artworkUrl100] = color;
                        return color;
                    };

                    getAlbumColor(gameState.selectedAlbums[0]).then(color => {
                        setBgColors([color, getRandomColor()]);
                    });
                }
            }, [gameState.selectedAlbums, gameState.stage]);

            // Filter songs based on current guess - optimized with useMemo
            const filteredSongs = useMemo(() => {
                if (!currentGuess.trim() || gameState.stage !== 'playing') return [];

                return gameState.allSongs.filter(song =>
                    song.name.toLowerCase().includes(currentGuess.toLowerCase()) &&
                    !gameState.guesses.find(g => g.song.name === song.name)
                ).slice(0, 10);
            }, [currentGuess, gameState.allSongs, gameState.guesses, gameState.stage]);

            // Keyboard navigation for dropdown
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (filteredSongs.length === 0 || isSubmittingGuess) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        setSelectedSongIndex(prev => (prev + 1) % filteredSongs.length);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        setSelectedSongIndex(prev => (prev - 1 + filteredSongs.length) % filteredSongs.length);
                    } else if (e.key === 'Enter' && filteredSongs.length > 0) {
                        e.preventDefault();
                        makeGuess(filteredSongs[selectedSongIndex]);
                    } else if (e.key === 'Escape') {
                        setCurrentGuess('');
                    }
                };

                if (gameState.stage === 'playing' && filteredSongs.length > 0) {
                    window.addEventListener('keydown', handleKeyDown);
                    return () => window.removeEventListener('keydown', handleKeyDown);
                }
            }, [filteredSongs, selectedSongIndex, gameState.stage, isSubmittingGuess]);

            // Reset selected index when filtered songs change
            useEffect(() => {
                setSelectedSongIndex(0);
            }, [filteredSongs]);

            // Cleanup for unmounted JSONP requests
            useEffect(() => {
                return () => {
                    Object.keys(window).forEach(key => {
                        if (key.startsWith('jsonp_callback_')) {
                            delete window[key];
                        }
                    });
                };
            }, []);

            const saveStats = useCallback((newStats) => {
                storage.set('guesser_stats', newStats);
                setStats(newStats);
            }, []);

            const saveRecentGame = useCallback((config) => {
                const randomAlbumArt = config.albums[Math.floor(Math.random() * config.albums.length)]?.artworkUrl100;

                // Create a fingerprint for deduplication: sorted artist IDs + sorted album IDs
                const fingerprint = [
                    ...config.artists.map(a => a.artistId).sort(),
                    ...config.albums.map(a => a.collectionId).sort()
                ].join('|');

                const newGame = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    artists: config.artists,
                    albums: config.albums,
                    artistNames: config.artists.map(a => a.artistName).join(', '),
                    albumArt: randomAlbumArt,
                    isPinned: false,
                    fingerprint
                };

                // Don't add to recent if it's already a pinned game
                if (pinnedGames.find(g => g.fingerprint === fingerprint)) {
                    saveStats({ ...stats });
                    return;
                }

                // Deduplicate: remove any existing recent game with the same fingerprint
                const deduped = recentGames.filter(g => g.fingerprint !== fingerprint);
                const updated = [newGame, ...deduped].slice(0, MAX_RECENT);
                setRecentGames(updated);
                storage.set('guesser_recent_games', updated);

                const newStats = { ...stats };
                config.artists.forEach(artist => {
                    newStats.artistCounts = newStats.artistCounts || {};
                    newStats.artistCounts[artist.artistName] = (newStats.artistCounts[artist.artistName] || 0) + 1;
                });

                const mostPlayed = Object.entries(newStats.artistCounts).sort((a, b) => b[1] - a[1])[0];
                if (mostPlayed) {
                    newStats.favoriteArtist = mostPlayed[0];
                }

                saveStats(newStats);
            }, [recentGames, pinnedGames, stats, saveStats]);

            const togglePin = useCallback((game) => {
                const isPinned = pinnedGames.find(g => g.id === game.id);

                if (isPinned) {
                    const updated = pinnedGames.filter(g => g.id !== game.id);
                    setPinnedGames(updated);
                    storage.set('guesser_pinned_games', updated);

                    const updatedRecent = [{ ...game, isPinned: false }, ...recentGames].slice(0, MAX_RECENT);
                    setRecentGames(updatedRecent);
                    storage.set('guesser_recent_games', updatedRecent);
                } else {
                    if (pinnedGames.length >= MAX_PINNED) {
                        setSearchState(s => ({ ...s, error: 'You can only pin up to 8 games' }));
                        setTimeout(() => setSearchState(s => ({ ...s, error: '' })), 3000);
                        return;
                    }

                    const updated = [...pinnedGames, { ...game, isPinned: true }];
                    setPinnedGames(updated);
                    storage.set('guesser_pinned_games', updated);

                    const updatedRecent = recentGames.filter(g => g.id !== game.id);
                    setRecentGames(updatedRecent);
                    storage.set('guesser_recent_games', updatedRecent);
                }
            }, [pinnedGames, recentGames]);

            const deleteRecentGame = useCallback((game) => {
                const updated = recentGames.filter(g => g.id !== game.id);
                setRecentGames(updated);
                storage.set('guesser_recent_games', updated);
            }, [recentGames]);

            const togglePinnedCollapsed = () => {
                const newValue = !pinnedCollapsed;
                setPinnedCollapsed(newValue);
                storage.set('guesser_pinned_collapsed', newValue);
            };

            const toggleRecentCollapsed = () => {
                const newValue = !recentCollapsed;
                setRecentCollapsed(newValue);
                storage.set('guesser_recent_collapsed', newValue);
            };

            const editGame = (game) => {
                setEditingGame(game.id);

                // Fetch album data for each artist
                const fetchArtistAlbums = async () => {
                    const artistAlbumsMap = {};

                    for (const artist of game.artists) {
                        try {
                            const albumsData = await jsonpRequest(
                                `https://itunes.apple.com/lookup?id=${artist.artistId}&entity=album&limit=200`
                            );

                            if (albumsData.results && albumsData.results.length > 1) {
                                const artistAlbumsData = albumsData.results
                                    .slice(1)
                                    .filter(item => item.wrapperType === 'collection')
                                    .sort((a, b) => {
                                        const typeOrder = { 'Album': 0, 'EP': 1, 'Single': 2 };
                                        const typeA = a.collectionType || 'Album';
                                        const typeB = b.collectionType || 'Album';
                                        const orderA = typeOrder[typeA] !== undefined ? typeOrder[typeA] : 3;
                                        const orderB = typeOrder[typeB] !== undefined ? typeOrder[typeB] : 3;

                                        if (orderA !== orderB) return orderA - orderB;
                                        return new Date(b.releaseDate) - new Date(a.releaseDate);
                                    });

                                artistAlbumsMap[artist.artistId] = artistAlbumsData;
                            }
                        } catch (err) {
                            console.error('Failed to fetch albums for artist:', artist.artistName);
                        }
                    }

                    setGameState(s => ({
                        ...s,
                        selectedArtists: game.artists,
                        selectedAlbums: game.albums,
                        artistAlbums: artistAlbumsMap,
                        stage: 'selectAlbums'
                    }));

                    setSelectedArtistTab(-1); // Set to "All" tab
                };

                fetchArtistAlbums();
            };

            const loadRecentGame = async (game) => {
                setGameState(s => ({
                    ...s,
                    selectedArtists: game.artists,
                    selectedAlbums: game.albums
                }));
                await loadGameConfig(game.artists, game.albums);
            };

            const searchArtist = async () => {
                if (!searchState.artistName.trim()) {
                    setSearchState(s => ({ ...s, error: 'Please enter an artist name' }));
                    setTimeout(() => setSearchState(s => ({ ...s, error: '' })), 3000);
                    return;
                }

                setSearchState(s => ({ ...s, loading: true, error: '', suggestions: [], page: 0 }));

                try {
                    const searchData = await jsonpRequest(
                        `https://itunes.apple.com/search?term=${encodeURIComponent(searchState.artistName)}&entity=musicArtist&limit=50`
                    );

                    if (!searchData.results || searchData.results.length === 0) {
                        setSearchState(s => ({ ...s, error: 'Artist not found. Try a different name.', loading: false }));
                        return;
                    }

                    const artists = searchData.results
                        .filter(item => item.wrapperType === 'artist')
                        .reduce((acc, artist) => {
                            if (!acc.find(a => a.artistName.toLowerCase() === artist.artistName.toLowerCase())) {
                                acc.push(artist);
                            }
                            return acc;
                        }, []);

                    setSearchState(s => ({ ...s, suggestions: artists, loading: false }));
                } catch (err) {
                    setSearchState(s => ({ ...s, error: 'Failed to fetch artist data. Please try again.', loading: false }));
                }
            };

            const selectArtist = async (artist) => {
                if (gameState.selectedArtists.find(a => a.artistId === artist.artistId)) {
                    setSearchState(s => ({ ...s, error: 'Artist already selected' }));
                    setTimeout(() => setSearchState(s => ({ ...s, error: '' })), 3000);
                    return;
                }

                setSearchState(s => ({ ...s, loadingSongs: true, error: '' }));

                try {
                    const albumsData = await jsonpRequest(
                        `https://itunes.apple.com/lookup?id=${artist.artistId}&entity=album&limit=200`
                    );

                    if (!albumsData.results || albumsData.results.length <= 1) {
                        setSearchState(s => ({ ...s, error: 'No albums found for this artist.', loadingSongs: false }));
                        return;
                    }

                    const artistAlbumsData = albumsData.results
                        .slice(1)
                        .filter(item => item.wrapperType === 'collection')
                        .sort((a, b) => {
                            // Sort by type: Albums first, then EPs, then Singles
                            const typeOrder = { 'Album': 0, 'EP': 1, 'Single': 2 };
                            const typeA = a.collectionType || 'Album';
                            const typeB = b.collectionType || 'Album';
                            const orderA = typeOrder[typeA] !== undefined ? typeOrder[typeA] : 3;
                            const orderB = typeOrder[typeB] !== undefined ? typeOrder[typeB] : 3;

                            if (orderA !== orderB) return orderA - orderB;

                            // Within same type, sort by release date (newest first)
                            return new Date(b.releaseDate) - new Date(a.releaseDate);
                        });

                    setGameState(s => ({
                        ...s,
                        artistAlbums: { ...s.artistAlbums, [artist.artistId]: artistAlbumsData },
                        selectedArtists: [...s.selectedArtists, artist],
                        stage: 'selectAlbums'
                    }));

                    setSelectedArtistTab(gameState.selectedArtists.length);
                    setSearchState(s => ({ ...s, artistName: '', suggestions: [], loadingSongs: false }));
                } catch (err) {
                    setSearchState(s => ({ ...s, error: 'Failed to fetch albums. Please try again.', loadingSongs: false }));
                }
            };

            const toggleAlbumSelection = (album) => {
                const isSelected = gameState.selectedAlbums.find(a => a.collectionId === album.collectionId);
                if (isSelected) {
                    setGameState(s => ({
                        ...s,
                        selectedAlbums: s.selectedAlbums.filter(a => a.collectionId !== album.collectionId)
                    }));
                } else {
                    setGameState(s => ({
                        ...s,
                        selectedAlbums: [...s.selectedAlbums, album]
                    }));
                }
            };

            const selectAllAlbumsForTab = () => {
                if (selectedArtistTab === -1) {
                    // Select all albums from all artists
                    const allAlbums = [];
                    gameState.selectedArtists.forEach(artist => {
                        const albums = gameState.artistAlbums[artist.artistId] || [];
                        albums.forEach(album => {
                            if (!allAlbums.find(a => a.collectionId === album.collectionId)) {
                                allAlbums.push(album);
                            }
                        });
                    });
                    setGameState(s => ({ ...s, selectedAlbums: allAlbums }));
                } else {
                    // Select all albums for current artist
                    if (!gameState.selectedArtists[selectedArtistTab]) return;
                    const artist = gameState.selectedArtists[selectedArtistTab];
                    const albums = gameState.artistAlbums[artist.artistId] || [];

                    const newSelected = [...gameState.selectedAlbums];
                    albums.forEach(album => {
                        if (!newSelected.find(a => a.collectionId === album.collectionId)) {
                            newSelected.push(album);
                        }
                    });

                    setGameState(s => ({ ...s, selectedAlbums: newSelected }));
                }
            };

            const deselectAllAlbumsForTab = () => {
                if (selectedArtistTab === -1) {
                    // Deselect all albums
                    setGameState(s => ({ ...s, selectedAlbums: [] }));
                } else {
                    // Deselect albums for current artist
                    if (!gameState.selectedArtists[selectedArtistTab]) return;
                    const artist = gameState.selectedArtists[selectedArtistTab];
                    const albums = gameState.artistAlbums[artist.artistId] || [];

                    setGameState(s => ({
                        ...s,
                        selectedAlbums: s.selectedAlbums.filter(selected =>
                            !albums.find(album => album.collectionId === selected.collectionId)
                        )
                    }));
                }
            };

            const removeArtist = (artistId) => {
                setConfirmDialog({
                    isOpen: true,
                    type: 'removeArtist',
                    data: artistId,
                    title: 'Remove Artist?',
                    message: 'This will remove the artist and all their albums from your selection.'
                });
            };

            const confirmRemoveArtist = () => {
                const artistId = confirmDialog.data;
                setGameState(s => {
                    const albums = s.artistAlbums[artistId] || [];
                    const newArtistAlbums = { ...s.artistAlbums };
                    delete newArtistAlbums[artistId];

                    const newSelectedArtists = s.selectedArtists.filter(a => a.artistId !== artistId);

                    return {
                        ...s,
                        selectedArtists: newSelectedArtists,
                        selectedAlbums: s.selectedAlbums.filter(album =>
                            !albums.find(a => a.collectionId === album.collectionId)
                        ),
                        artistAlbums: newArtistAlbums,
                        stage: newSelectedArtists.length === 0 ? 'recentGames' : 'selectAlbums'
                    };
                });

                setSelectedArtistTab(0);
                setConfirmDialog({ isOpen: false, type: null, data: null });
            };

            const loadGameConfig = async (artists, albums) => {
                setSearchState(s => ({ ...s, loadingSongs: true, error: '' }));

                try {
                    const songs = [];
                    const seenSongs = new Set();

                    for (const album of albums) {
                        const songsData = await jsonpRequest(
                            `https://itunes.apple.com/lookup?id=${album.collectionId}&entity=song&limit=200`
                        );

                        if (songsData.results && songsData.results.length > 1) {
                            const tracks = songsData.results
                                .slice(1)
                                .filter(item => item.wrapperType === 'track' && item.kind === 'song');

                            for (const track of tracks) {
                                const songKey = track.trackName.toLowerCase().trim();
                                if (!seenSongs.has(songKey)) {
                                    seenSongs.add(songKey);
                                    songs.push({
                                        name: track.trackName,
                                        duration: track.trackTimeMillis,
                                        trackNumber: track.trackNumber,
                                        albumName: track.collectionName,
                                        albumId: track.collectionId,
                                        artistName: track.artistName,
                                        releaseDate: track.releaseDate,
                                        artwork: track.artworkUrl100
                                    });
                                }
                            }
                        }
                    }

                    if (songs.length === 0) {
                        setSearchState(s => ({ ...s, error: 'No songs found in selected albums.', loadingSongs: false }));
                        return;
                    }

                    const randomSong = songs[Math.floor(Math.random() * songs.length)];
                    setGameState(s => ({
                        ...s,
                        allSongs: songs,
                        targetSong: randomSong,
                        guesses: [],
                        stage: 'playing',
                        gameOver: false,
                        won: false
                    }));

                    setBgColors([getRandomColor(), getRandomColor()]);
                    setShowAnswer(false);

                    saveRecentGame({ artists, albums });
                    setSearchState(s => ({ ...s, loadingSongs: false }));
                } catch (err) {
                    setSearchState(s => ({ ...s, error: 'Failed to load songs. Please try again.', loadingSongs: false }));
                }
            };

            const startGame = async () => {
                if (gameState.selectedAlbums.length === 0) {
                    setSearchState(s => ({ ...s, error: 'Please select at least one album.' }));
                    setTimeout(() => setSearchState(s => ({ ...s, error: '' })), 3000);
                    return;
                }

                await loadGameConfig(gameState.selectedArtists, gameState.selectedAlbums);
            };

            const getHintLevel = () => {
                const guessCount = gameState.guesses.length;
                if (guessCount >= 5) return 3;
                if (guessCount >= 3) return 2;
                if (guessCount >= 2) return 1;
                return 0;
            };

            const makeGuess = async (song) => {
                if (gameState.guesses.find(g => g.song.name === song.name)) return;
                if (gameState.gameOver || isSubmittingGuess) return;

                setIsSubmittingGuess(true);

                let albumColor = colorCache.current[song.artwork];
                if (!albumColor) {
                    albumColor = await extractDominantColor(song.artwork);
                    colorCache.current[song.artwork] = albumColor;
                }

                const durationDiff = song.duration - gameState.targetSong.duration;
                const dateDiff = new Date(song.releaseDate) - new Date(gameState.targetSong.releaseDate);
                const trackDiff = song.trackNumber - gameState.targetSong.trackNumber;

                const guess = {
                    song: song,
                    isCorrect: song.name === gameState.targetSong.name,
                    durationMatch: song.duration === gameState.targetSong.duration ? 'correct' :
                        Math.abs(durationDiff) < 30000 ? 'close' : 'far',
                    durationDirection: durationDiff > 0 ? 'down' : durationDiff < 0 ? 'up' : 'exact',
                    dateMatch: song.releaseDate === gameState.targetSong.releaseDate ? 'correct' :
                        Math.abs(dateDiff) < 31536000000 ? 'close' : 'far',
                    dateDirection: dateDiff > 0 ? 'down' : dateDiff < 0 ? 'up' : 'exact',
                    trackMatch: song.trackNumber === gameState.targetSong.trackNumber ? 'correct' :
                        Math.abs(trackDiff) <= 2 ? 'close' : 'far',
                    trackDirection: trackDiff > 0 ? 'down' : trackDiff < 0 ? 'up' : 'exact',
                    artistMatch: gameState.selectedArtists.length > 1
                        ? (song.artistName === gameState.targetSong.artistName ? 'correct' : 'far')
                        : null,
                    albumMatch: song.albumId === gameState.targetSong.albumId ? 'correct' : 'far',
                    albumColor: albumColor
                };

                const newGuesses = [...gameState.guesses, guess];
                const won = guess.isCorrect;
                const gameOver = won || newGuesses.length >= MAX_GUESSES;

                setGameState(s => ({
                    ...s,
                    guesses: newGuesses,
                    gameOver: gameOver,
                    won: won
                }));

                setCurrentGuess('');
                setIsSubmittingGuess(false);

                if (gameOver) {
                    const newStats = { ...stats };
                    newStats.gamesPlayed++;

                    if (won) {
                        newStats.gamesWon++;
                        newStats.currentStreak++;
                        newStats.maxStreak = Math.max(newStats.maxStreak, newStats.currentStreak);
                        newStats.guessDistribution[newGuesses.length - 1]++;
                    } else {
                        newStats.currentStreak = 0;
                    }

                    saveStats(newStats);
                }
            };

            const playAgain = () => {
                if (gameState.allSongs.length === 0) return;
                const randomSong = gameState.allSongs[Math.floor(Math.random() * gameState.allSongs.length)];
                setGameState(s => ({
                    ...s,
                    targetSong: randomSong,
                    guesses: [],
                    gameOver: false,
                    won: false
                }));
                setBgColors([getRandomColor(), getRandomColor()]);
                setShowAnswer(false);
                colorCache.current = {};
            };

            const startOver = () => {
                setGameState({
                    stage: 'recentGames',
                    selectedArtists: [],
                    selectedAlbums: [],
                    artistAlbums: {},
                    allSongs: [],
                    targetSong: null,
                    guesses: [],
                    gameOver: false,
                    won: false
                });
                setBgColors([getRandomColor(), getRandomColor()]);
                setShowAnswer(false);
                setSelectedArtistTab(0);
                colorCache.current = {};
            };

            const giveUp = () => {
                setConfirmDialog({
                    isOpen: true,
                    type: 'giveUp',
                    title: 'Give Up?',
                    message: 'Are you sure you want to give up? This will count as a loss.'
                });
            };

            const confirmGiveUp = () => {
                setShowAnswer(true);
                setGameState(s => ({ ...s, gameOver: true }));

                const newStats = { ...stats };
                newStats.gamesPlayed++;
                newStats.currentStreak = 0;
                saveStats(newStats);

                setConfirmDialog({ isOpen: false, type: null, data: null });
            };

            const formatDuration = (ms) => {
                const seconds = Math.floor(ms / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            };

            const getColorClass = (match) => {
                if (match === 'correct') return 'bg-green-500/80';
                if (match === 'close') return 'bg-yellow-500/80';
                return 'bg-red-500/40';
            };

            const generateShareText = () => {
                const guessCount = gameState.won ? gameState.guesses.length : 'X';
                let text = `ðŸŽµ Guesser ${guessCount}/${MAX_GUESSES}\n\n`;

                gameState.guesses.forEach(guess => {
                    const duration = guess.durationMatch === 'correct' ? 'ðŸŸ©' : guess.durationMatch === 'close' ? 'ðŸŸ¨' : 'â¬›';
                    const date = guess.dateMatch === 'correct' ? 'ðŸŸ©' : guess.dateMatch === 'close' ? 'ðŸŸ¨' : 'â¬›';
                    const track = guess.trackMatch === 'correct' ? 'ðŸŸ©' : guess.trackMatch === 'close' ? 'ðŸŸ¨' : 'â¬›';
                    const artist = gameState.selectedArtists.length > 1
                        ? (guess.artistMatch === 'correct' ? 'ðŸŸ©' : 'â¬›')
                        : '';
                    text += `${duration}${date}${track}${artist}\n`;
                });

                if (gameState.won) {
                    text += `\nâœ… Solved!`;
                } else if (gameState.gameOver) {
                    text += `\nâŒ Failed`;
                }

                return text;
            };

            const copyToClipboard = () => {
                const text = generateShareText();
                navigator.clipboard.writeText(text).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 3000);
                }).catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 3000);
                });
            };

            const paginatedSuggestions = searchState.suggestions.slice(
                searchState.page * ITEMS_PER_PAGE,
                (searchState.page + 1) * ITEMS_PER_PAGE
            );

            const hintLevel = getHintLevel();
            const remainingGuesses = MAX_GUESSES - gameState.guesses.length;

            // Sync state to window so the external Play Game button can read it
            useEffect(() => {
                window.__guesserStartGame = startGame;
                window.__guesserStage = gameState.stage;
                window.__guesserAlbumCount = gameState.selectedAlbums.length;
                window.__guesserLoadingSongs = searchState.loadingSongs;
                const btn = document.getElementById('playGameBtn');
                const label = document.getElementById('playGameLabel');
                if (!btn) return;
                if (gameState.stage === 'selectAlbums') {
                    btn.style.display = 'flex';
                    const count = gameState.selectedAlbums.length;
                    if (label) label.textContent = count > 0 ? `Play Game Â· ${count} album${count !== 1 ? 's' : ''}` : 'Play Game Â· select albums first';
                    btn.style.opacity = (count === 0 || searchState.loadingSongs) ? '0.45' : '1';
                    btn.style.cursor = (count === 0 || searchState.loadingSongs) ? 'not-allowed' : 'pointer';
                } else {
                    btn.style.display = 'none';
                }
            });

            const displayedPinnedGames = showAllPinned ? pinnedGames : pinnedGames.slice(0, 4);

            const GameCard = useCallback(({ game, isPinned, onPin, onLoad, onEdit, onExpand, isExpanded, onDelete }) => (
                <div className="bg-white/10 rounded-xl border border-white/20 hover:bg-white/15 transition-all">
                    <div className="p-4">
                        <div className="flex items-center gap-3 mb-3">
                            {game.albumArt && (
                                <img src={game.albumArt} alt="" className="w-12 h-12 rounded-lg object-cover" loading="lazy" />
                            )}
                            <div className="flex-1 min-w-0">
                                <p className="text-white font-semibold truncate">{game.artistNames}</p>
                                <p className="text-gray-400 text-sm">{game.albums.length} album{game.albums.length !== 1 ? 's' : ''}</p>
                            </div>
                            <div className="flex items-center gap-1">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        onPin(game);
                                    }}
                                    className="p-2 hover:bg-white/10 rounded-lg transition-colors"
                                    title={isPinned ? 'Unsave' : 'Save'}
                                >
                                    {isPinned ? <PinFilled className="w-5 h-5 text-yellow-400" /> : <Pin className="w-5 h-5 text-white" />}
                                </button>
                                {!isPinned && onDelete && (
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            onDelete(game);
                                        }}
                                        className="p-2 hover:bg-red-500/20 rounded-lg transition-colors"
                                        title="Delete"
                                    >
                                        <X className="w-4 h-4 text-gray-400 hover:text-red-400" />
                                    </button>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button
                                onClick={() => onLoad(game)}
                                className="flex-1 px-3 py-2 bg-white/10 hover:bg-white/20 text-white text-sm rounded-lg transition-all"
                            >
                                Play
                            </button>
                            <button
                                onClick={() => onEdit(game)}
                                className="px-3 py-2 bg-white/10 hover:bg-white/20 text-white text-sm rounded-lg"
                            >
                                Edit
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onExpand();
                                }}
                                className="px-3 py-2 bg-white/10 hover:bg-white/20 text-white text-sm rounded-lg"
                            >
                                {isExpanded ? 'Hide' : 'Show'}
                            </button>
                        </div>
                    </div>
                    {isExpanded && (
                        <div className="px-4 pb-4 pt-2 space-y-1 border-t border-white/10 max-h-60 overflow-y-auto">
                            {game.albums.slice(0, 50).map((album, idx) => (
                                <p key={idx} className="text-gray-300 text-sm">â€¢ {album.collectionName}</p>
                            ))}
                            {game.albums.length > 50 && (
                                <p className="text-gray-400 text-xs italic">...and {game.albums.length - 50} more</p>
                            )}
                        </div>
                    )}
                </div>
            ), []);

            return (
                <div className="min-h-screen bg-black relative overflow-hidden">
                    <AnimatedBackground colors={bgColors} />

                    <ConfirmDialog
                        isOpen={confirmDialog.isOpen}
                        onConfirm={confirmDialog.type === 'giveUp' ? confirmGiveUp : confirmRemoveArtist}
                        onCancel={() => setConfirmDialog({ isOpen: false, type: null, data: null })}
                        title={confirmDialog.title}
                        message={confirmDialog.message}
                    />

                    {searchState.loadingSongs && gameState.stage === 'selectAlbums' && (
                        <div className="fixed inset-0 z-50 flex flex-col items-center justify-center gap-6"
                            style={{ background: 'rgba(0,0,0,0.75)', backdropFilter: 'blur(12px)' }}>
                            <div className="relative w-20 h-20">
                                <svg className="animate-spin w-20 h-20 text-white/20" fill="none" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/>
                                </svg>
                                <svg className="animate-spin w-20 h-20 text-white absolute inset-0" fill="none" viewBox="0 0 24 24" style={{animationDuration:'0.8s'}}>
                                    <path stroke="currentColor" strokeWidth="2" strokeLinecap="round" d="M12 2a10 10 0 0 1 10 10"/>
                                </svg>
                            </div>
                            <div className="text-center">
                                <p className="text-white text-2xl font-bold mb-1">Loading songsâ€¦</p>
                                <p className="text-gray-400 text-sm">Fetching tracks from {gameState.selectedAlbums.length} album{gameState.selectedAlbums.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                    )}

                    <div className="relative z-10">
                        <div className="flex justify-between items-center pt-8 px-8">
                            <a href="Âµsic.html" className="text-center hover:opacity-80 transition-opacity">
                                <h1 className="text-3xl font-bold text-white drop-shadow-lg">Î¼sic tools</h1>
                            </a>

                            {(gameState.stage === 'playing' || gameState.gameOver) && (
                                <button
                                    onClick={startOver}
                                    className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20"
                                >
                                    Start Over
                                </button>
                            )}
                        </div>

                        <div className="p-8 max-w-7xl mx-auto">
                            {gameState.stage === 'recentGames' && (
                                <div className="mt-2">
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        {/* Left Column - Stats */}
                                        <div className="lg:col-span-1">
                                            <div className="bg-white/5 backdrop-blur-2xl rounded-3xl p-6 shadow-2xl border border-white/10 sticky top-8">
                                                <div className="text-center mb-6">
                                                    <h2 className="text-3xl font-bold text-white mb-2">Guesser Game</h2>
                                                    <p className="text-gray-300">Guess the song in {MAX_GUESSES} tries!</p>
                                                </div>

                                                {stats.gamesPlayed > 0 && (
                                                    <div className="space-y-4">
                                                        <h3 className="text-lg font-bold text-white text-center">Your Stats</h3>
                                                        <div className="grid grid-cols-2 gap-3 text-center">
                                                            <div className="bg-white/10 rounded-lg p-3">
                                                                <div className="text-2xl font-bold text-white">{stats.gamesPlayed}</div>
                                                                <div className="text-xs text-gray-300">Played</div>
                                                            </div>
                                                            <div className="bg-white/10 rounded-lg p-3">
                                                                <div className="text-2xl font-bold text-white">
                                                                    {stats.gamesPlayed > 0 ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) : 0}%
                                                                </div>
                                                                <div className="text-xs text-gray-300">Win Rate</div>
                                                            </div>
                                                            <div className="bg-white/10 rounded-lg p-3">
                                                                <div className="text-2xl font-bold text-white">{stats.currentStreak}</div>
                                                                <div className="text-xs text-gray-300">Current</div>
                                                            </div>
                                                            <div className="bg-white/10 rounded-lg p-3">
                                                                <div className="text-2xl font-bold text-white">{stats.maxStreak}</div>
                                                                <div className="text-xs text-gray-300">Max Streak</div>
                                                            </div>
                                                        </div>

                                                        {stats.favoriteArtist && (
                                                            <div className="text-center p-3 bg-white/10 rounded-lg">
                                                                <p className="text-xs text-gray-300">Favorite Artist</p>
                                                                <p className="text-sm font-semibold text-white">{stats.favoriteArtist}</p>
                                                                <p className="text-xs text-gray-400">{stats.artistCounts[stats.favoriteArtist]} games</p>
                                                            </div>
                                                        )}

                                                        <div>
                                                            <h4 className="text-sm font-semibold text-white mb-2">Guess Distribution</h4>
                                                            {(() => {
                                                                const maxCount = Math.max(...stats.guessDistribution, 1);
                                                                return stats.guessDistribution.map((count, idx) => (
                                                                    <div key={idx} className="flex items-center gap-2 mb-1">
                                                                        <span className="text-white w-4 text-sm">{idx + 1}</span>
                                                                        <div className="flex-1 bg-white/20 rounded h-5 overflow-hidden">
                                                                            <div
                                                                                className="bg-green-500 h-full flex items-center justify-end pr-2 transition-all"
                                                                                style={{
                                                                                    width: `${count > 0 ? Math.max((count / maxCount) * 100, 8) : 0}%`
                                                                                }}
                                                                            >
                                                                                {count > 0 && <span className="text-white text-xs font-bold">{count}</span>}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                ));
                                                            })()}
                                                        </div>
                                                    </div>
                                                )}

                                                {stats.gamesPlayed === 0 && (
                                                    <p className="text-gray-400 text-center text-sm">Play your first game to see stats!</p>
                                                )}
                                            </div>
                                        </div>

                                        {/* Right Column - Games & Search */}
                                        <div className="lg:col-span-2">
                                            <div className="bg-white/5 backdrop-blur-2xl rounded-3xl p-6 shadow-2xl border border-white/10">
                                                {pinnedGames.length > 0 && (
                                                    <div className="mb-6">
                                                        <button
                                                            onClick={togglePinnedCollapsed}
                                                            className="flex items-center justify-between w-full mb-3 hover:opacity-80 transition-opacity"
                                                        >
                                                            <h3 className="text-lg font-bold text-white">Saved Games ({pinnedGames.length})</h3>
                                                            <ChevronDown className={`w-5 h-5 text-white transition-transform ${pinnedCollapsed ? '' : 'rotate-180'}`} />
                                                        </button>

                                                        {!pinnedCollapsed && (
                                                            <>
                                                                <div className="horizontal-scroll">
                                                                    {pinnedGames.map((game) => (
                                                                        <GameCard
                                                                            key={game.id}
                                                                            game={game}
                                                                            isPinned={true}
                                                                            onPin={togglePin}
                                                                            onLoad={loadRecentGame}
                                                                            onEdit={editGame}
                                                                            onExpand={() => setExpandedGame(expandedGame === game.id ? null : game.id)}
                                                                            isExpanded={expandedGame === game.id}
                                                                        />
                                                                    ))}
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                )}

                                                {recentGames.length > 0 && (
                                                    <div className="mb-6">
                                                        <button
                                                            onClick={toggleRecentCollapsed}
                                                            className="flex items-center justify-between w-full mb-3 hover:opacity-80 transition-opacity"
                                                        >
                                                            <h3 className="text-lg font-bold text-white">Recent Games</h3>
                                                            <ChevronDown className={`w-5 h-5 text-white transition-transform ${recentCollapsed ? '' : 'rotate-180'}`} />
                                                        </button>

                                                        {!recentCollapsed && (
                                                            <div className="horizontal-scroll">
                                                                {recentGames.map((game) => (
                                                                    <GameCard
                                                                        key={game.id}
                                                                        game={game}
                                                                        isPinned={false}
                                                                        onPin={togglePin}
                                                                        onLoad={loadRecentGame}
                                                                        onEdit={editGame}
                                                                        onExpand={() => setExpandedGame(expandedGame === game.id ? null : game.id)}
                                                                        isExpanded={expandedGame === game.id}
                                                                        onDelete={deleteRecentGame}
                                                                    />
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}

                                                <div className="space-y-4">
                                                    <label className="block text-white text-lg font-medium">Search for an Artist</label>
                                                    <div className="flex gap-3">
                                                        <input
                                                            type="text"
                                                            value={searchState.artistName}
                                                            onChange={(e) => setSearchState(s => ({ ...s, artistName: e.target.value }))}
                                                            onKeyPress={(e) => e.key === 'Enter' && searchArtist()}
                                                            placeholder="The Beatles, Kanye West..."
                                                            className="flex-1 px-5 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-base placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                            disabled={searchState.loading}
                                                        />
                                                        <button
                                                            onClick={searchArtist}
                                                            disabled={searchState.loading}
                                                            className="px-6 py-3 bg-white text-black hover:bg-gray-100 disabled:bg-gray-600 rounded-xl font-semibold flex items-center gap-2"
                                                        >
                                                            {searchState.loading ? <Loader2 className="w-5 h-5" /> : <Search className="w-5 h-5" />}
                                                            {searchState.loading ? 'Searching...' : 'Search'}
                                                        </button>
                                                    </div>
                                                </div>

                                                {searchState.error && (
                                                    <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 mt-4">
                                                        <p className="text-red-200">{searchState.error}</p>
                                                    </div>
                                                )}

                                                {searchState.suggestions.length > 0 && (
                                                    <div className="space-y-3 mt-6">
                                                        <h3 className="text-white font-semibold text-lg">Select an artist ({searchState.suggestions.length} results):</h3>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                            {paginatedSuggestions.map((artist) => (
                                                                <button
                                                                    key={artist.artistId}
                                                                    onClick={() => selectArtist(artist)}
                                                                    className="w-full bg-white/10 hover:bg-white/20 rounded-xl p-4 text-left transition-all border border-white/20"
                                                                >
                                                                    <div className="flex items-center justify-between gap-3">
                                                                        <div className="flex-1">
                                                                            <p className="text-white font-semibold text-base">{artist.artistName}</p>
                                                                            {artist.primaryGenreName && (
                                                                                <p className="text-gray-300 text-sm mt-1">{artist.primaryGenreName}</p>
                                                                            )}
                                                                        </div>
                                                                        <ChevronRight className="w-5 h-5 text-gray-300" />
                                                                    </div>
                                                                </button>
                                                            ))}
                                                        </div>

                                                        {searchState.suggestions.length > ITEMS_PER_PAGE && (
                                                            <div className="flex justify-center gap-3 mt-4">
                                                                <button
                                                                    onClick={() => setSearchState(s => ({ ...s, page: Math.max(0, s.page - 1) }))}
                                                                    disabled={searchState.page === 0}
                                                                    className="px-4 py-2 bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white rounded-lg"
                                                                >
                                                                    Previous
                                                                </button>
                                                                <span className="px-4 py-2 text-white">
                                                                    Page {searchState.page + 1} of {Math.ceil(searchState.suggestions.length / ITEMS_PER_PAGE)}
                                                                </span>
                                                                <button
                                                                    onClick={() => setSearchState(s => ({ ...s, page: Math.min(Math.ceil(s.suggestions.length / ITEMS_PER_PAGE) - 1, s.page + 1) }))}
                                                                    disabled={searchState.page >= Math.ceil(searchState.suggestions.length / ITEMS_PER_PAGE) - 1}
                                                                    className="px-4 py-2 bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white rounded-lg"
                                                                >
                                                                    Next
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}

                                                {searchState.loadingSongs && (
                                                    <div className="flex items-center justify-center gap-3 py-8">
                                                        <Loader2 className="w-8 h-8 text-white" />
                                                        <p className="text-white text-lg">Loading albums...</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {gameState.stage === 'selectAlbums' && (
                                <div className="bg-white/5 backdrop-blur-2xl rounded-3xl p-8 pb-24 shadow-2xl border border-white/10 mt-4">

                                    {/* Header row: back + title */}
                                    <div className="flex items-center gap-3 mb-6">
                                        <button onClick={() => {
                                            setEditingGame(null);
                                            setSearchState(s => ({ ...s, artistName: '', suggestions: [], error: '', page: 0 }));
                                            setGameState(s => ({ ...s, stage: 'recentGames', selectedArtists: [], selectedAlbums: [], artistAlbums: {} }));
                                        }} className="p-2 hover:bg-white/10 rounded-lg transition-colors flex-shrink-0">
                                            <ArrowLeft className="w-6 h-6 text-white" />
                                        </button>
                                        <div className="flex-1">
                                            <h2 className="text-2xl font-bold text-white">Select Albums</h2>
                                            <p className="text-gray-400 text-sm mt-0.5">Choose which albums to include in the game</p>
                                        </div>
                                    </div>

                                    {searchState.error && (
                                        <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 mb-4">
                                            <p className="text-red-200">{searchState.error}</p>
                                        </div>
                                    )}

                                    <div className="mb-6">
                                        <div className="flex gap-2 mb-4 flex-wrap">
                                            <button
                                                onClick={() => setSelectedArtistTab(-1)}
                                                className={`px-4 py-2 rounded-lg transition-all ${selectedArtistTab === -1
                                                        ? 'bg-white/20 border-2 border-white/50 text-white'
                                                        : 'bg-white/10 border-2 border-white/20 text-gray-300 hover:bg-white/15'
                                                    }`}
                                            >
                                                All
                                            </button>
                                            {gameState.selectedArtists.map((artist, idx) => (
                                                <button
                                                    key={artist.artistId}
                                                    onClick={() => setSelectedArtistTab(idx)}
                                                    className={`px-4 py-2 rounded-lg flex items-center gap-2 transition-all ${selectedArtistTab === idx
                                                            ? 'bg-white/20 border-2 border-white/50 text-white'
                                                            : 'bg-white/10 border-2 border-white/20 text-gray-300 hover:bg-white/15'
                                                        }`}
                                                >
                                                    <span className="truncate max-w-[150px]">{artist.artistName}</span>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            removeArtist(artist.artistId);
                                                        }}
                                                        className="hover:bg-white/20 rounded p-1"
                                                    >
                                                        <X className="w-4 h-4" />
                                                    </button>
                                                </button>
                                            ))}
                                            <button
                                                onClick={() => { setSearchState(s => ({ ...s, artistName: '', suggestions: [], error: '', page: 0 })); setGameState(s => ({ ...s, stage: 'addArtist' })); }}
                                                className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg flex items-center gap-2 border-2 border-white/20 text-white"
                                            >
                                                <Plus className="w-4 h-4" />
                                                Add Artist
                                            </button>
                                        </div>
                                    </div>

                                    {(() => {
                                        let albums = [];
                                        let tabTitle = '';

                                        if (selectedArtistTab === -1) {
                                            // "All" tab - show all albums from all artists
                                            tabTitle = 'All Artists';
                                            gameState.selectedArtists.forEach(artist => {
                                                const artistAlbums = gameState.artistAlbums[artist.artistId] || [];
                                                albums = [...albums, ...artistAlbums];
                                            });
                                        } else if (gameState.selectedArtists[selectedArtistTab]) {
                                            // Individual artist tab
                                            const artist = gameState.selectedArtists[selectedArtistTab];
                                            tabTitle = artist.artistName;
                                            albums = gameState.artistAlbums[artist.artistId] || [];
                                        }

                                        const selectedFromThisTab = albums.filter(album =>
                                            gameState.selectedAlbums.find(a => a.collectionId === album.collectionId)
                                        );
                                        const allSelected = selectedFromThisTab.length === albums.length && albums.length > 0;

                                        return (
                                            <div className="mb-20">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="text-white font-semibold text-lg">{tabTitle}</h3>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={selectAllAlbumsForTab}
                                                            disabled={allSelected}
                                                            className="px-3 py-1 bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white text-sm rounded-lg transition-all"
                                                        >
                                                            Select All
                                                        </button>
                                                        <button
                                                            onClick={deselectAllAlbumsForTab}
                                                            disabled={selectedFromThisTab.length === 0}
                                                            className="px-3 py-1 bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white text-sm rounded-lg transition-all"
                                                        >
                                                            Deselect All
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                                    {albums.map((album) => {
                                                        const isSelected = gameState.selectedAlbums.find(a => a.collectionId === album.collectionId);
                                                        return (
                                                            <button
                                                                key={album.collectionId}
                                                                onClick={() => toggleAlbumSelection(album)}
                                                                className={`p-3 rounded-xl transition-all border-2 ${isSelected
                                                                        ? 'bg-white/20 border-white/50 scale-95'
                                                                        : 'bg-white/5 border-white/10 hover:bg-white/10'
                                                                    }`}
                                                            >
                                                                <img src={album.artworkUrl100} alt={album.collectionName} className="w-full aspect-square rounded-lg mb-2 object-cover" loading="lazy" />
                                                                <p className="text-white font-medium text-sm text-center line-clamp-2">{album.collectionName}</p>
                                                                {album.collectionType && (
                                                                    <p className="text-gray-400 text-xs text-center mt-1">{album.collectionType}</p>
                                                                )}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}

                            {gameState.stage === 'addArtist' && (
                                <div className="mt-4">
                                    <div className="bg-white/5 backdrop-blur-2xl rounded-3xl p-8 shadow-2xl border border-white/10">
                                        {/* Header */}
                                        <div className="flex items-center gap-3 mb-6">
                                            <button onClick={() => setGameState(s => ({ ...s, stage: 'selectAlbums' }))} className="p-2 hover:bg-white/10 rounded-lg transition-colors">
                                                <ArrowLeft className="w-6 h-6 text-white" />
                                            </button>
                                            <div className="flex-1">
                                                <h2 className="text-2xl font-bold text-white">Add Another Artist</h2>
                                                <p className="text-gray-300 text-sm mt-1">Search for an artist to add to your game</p>
                                            </div>
                                        </div>

                                        {/* Currently added artists chips */}
                                        <div className="mb-6">
                                            <p className="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3">Already added</p>
                                            <div className="flex flex-wrap gap-2">
                                                {gameState.selectedArtists.map((artist, idx) => (
                                                    <div key={artist.artistId} className="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium"
                                                        style={{ background: 'rgba(255,255,255,0.15)', border: '1.5px solid rgba(255,255,255,0.3)' }}>
                                                        <span className="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-xs font-bold text-white">{idx + 1}</span>
                                                        <span className="text-white">{artist.artistName}</span>
                                                    </div>
                                                ))}
                                                <div className="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium border-2 border-dashed border-white/30 text-gray-400">
                                                    <Plus className="w-4 h-4" />
                                                    <span>Adding new artist</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Search */}
                                        <div className="space-y-4">
                                            <div className="flex gap-3">
                                                <input
                                                    type="text"
                                                    value={searchState.artistName}
                                                    onChange={(e) => setSearchState(s => ({ ...s, artistName: e.target.value }))}
                                                    onKeyPress={(e) => e.key === 'Enter' && searchArtist()}
                                                    placeholder="Search for an artist..."
                                                    className="flex-1 px-5 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-base placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                    disabled={searchState.loading}
                                                    autoFocus
                                                />
                                                <button
                                                    onClick={searchArtist}
                                                    disabled={searchState.loading}
                                                    className="px-6 py-3 bg-white text-black hover:bg-gray-100 disabled:bg-gray-600 rounded-xl font-semibold flex items-center gap-2"
                                                >
                                                    {searchState.loading ? <Loader2 className="w-5 h-5" /> : <Search className="w-5 h-5" />}
                                                    {searchState.loading ? 'Searching...' : 'Search'}
                                                </button>
                                            </div>
                                        </div>

                                        {searchState.error && (
                                            <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 mt-4">
                                                <p className="text-red-200">{searchState.error}</p>
                                            </div>
                                        )}

                                        {searchState.suggestions.length > 0 && (
                                            <div className="space-y-3 mt-6">
                                                <h3 className="text-white font-semibold text-lg">Select an artist ({searchState.suggestions.length} results):</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                    {paginatedSuggestions.map((artist) => (
                                                        <button
                                                            key={artist.artistId}
                                                            onClick={() => selectArtist(artist)}
                                                            disabled={!!gameState.selectedArtists.find(a => a.artistId === artist.artistId)}
                                                            className="w-full bg-white/10 hover:bg-white/20 disabled:opacity-40 disabled:cursor-not-allowed rounded-xl p-4 text-left transition-all border border-white/20"
                                                        >
                                                            <div className="flex items-center justify-between gap-3">
                                                                <div className="flex-1">
                                                                    <p className="text-white font-semibold text-base">{artist.artistName}</p>
                                                                    {artist.primaryGenreName && (
                                                                        <p className="text-gray-300 text-sm mt-1">{artist.primaryGenreName}</p>
                                                                    )}
                                                                    {gameState.selectedArtists.find(a => a.artistId === artist.artistId) && (
                                                                        <p className="text-green-400 text-xs mt-1">Already added</p>
                                                                    )}
                                                                </div>
                                                                <ChevronRight className="w-5 h-5 text-gray-300" />
                                                            </div>
                                                        </button>
                                                    ))}
                                                </div>

                                                {searchState.suggestions.length > ITEMS_PER_PAGE && (
                                                    <div className="flex justify-center gap-3 mt-4">
                                                        <button
                                                            onClick={() => setSearchState(s => ({ ...s, page: Math.max(0, s.page - 1) }))}
                                                            disabled={searchState.page === 0}
                                                            className="px-4 py-2 bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white rounded-lg"
                                                        >
                                                            Previous
                                                        </button>
                                                        <span className="px-4 py-2 text-white">
                                                            Page {searchState.page + 1} of {Math.ceil(searchState.suggestions.length / ITEMS_PER_PAGE)}
                                                        </span>
                                                        <button
                                                            onClick={() => setSearchState(s => ({ ...s, page: Math.min(Math.ceil(s.suggestions.length / ITEMS_PER_PAGE) - 1, s.page + 1) }))}
                                                            disabled={searchState.page >= Math.ceil(searchState.suggestions.length / ITEMS_PER_PAGE) - 1}
                                                            className="px-4 py-2 bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white rounded-lg"
                                                        >
                                                            Next
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {searchState.loadingSongs && (
                                            <div className="flex items-center justify-center gap-3 py-8">
                                                <Loader2 className="w-8 h-8 text-white" />
                                                <p className="text-white text-lg">Loading albums...</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {gameState.stage === 'playing' && gameState.targetSong && (
                                <div className="space-y-6 mt-8">
                                    <div className="bg-white/5 backdrop-blur-2xl rounded-3xl p-8 shadow-2xl border border-white/10">
                                        <h2 className="text-3xl font-bold text-white text-center mb-2">Guess the Song!</h2>
                                        <div className="flex flex-wrap justify-center items-center gap-3 mb-6">
                                            <p className="text-gray-300 text-center">
                                                {gameState.selectedArtists.map(a => a.artistName).join(', ')} â€¢ {gameState.allSongs.length} songs
                                            </p>
                                            <div className="px-3 py-1 bg-white/20 rounded-lg">
                                                <p className="text-white font-semibold">{remainingGuesses}/{MAX_GUESSES} left</p>
                                            </div>
                                        </div>

                                        {!gameState.gameOver && hintLevel > 0 && (
                                            <div className="bg-yellow-500/20 border border-yellow-500/50 rounded-xl p-4 mb-6">
                                                <p className="text-yellow-200 text-center">
                                                    <span className="font-semibold">Hint:</span>{' '}
                                                    {hintLevel >= 1 && `First letter: ${gameState.targetSong.name[0]}`}
                                                    {hintLevel >= 2 && ` â€¢ Length: ${gameState.targetSong.name.length} characters`}
                                                    {hintLevel >= 3 && ` â€¢ Album: ${gameState.targetSong.albumName}`}
                                                </p>
                                            </div>
                                        )}

                                        {!gameState.gameOver ? (
                                            <>
                                                <div className="max-w-md mx-auto">
                                                <div className="relative mb-4">
                                                    <input
                                                        type="text"
                                                        value={currentGuess}
                                                        onChange={(e) => setCurrentGuess(e.target.value)}
                                                        placeholder="Type a song name..."
                                                        className="w-full px-6 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-base placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                        autoFocus
                                                        disabled={isSubmittingGuess}
                                                    />

                                                    {filteredSongs.length > 0 && (
                                                        <div ref={dropdownRef} className="absolute top-full left-0 right-0 mt-2 bg-white/90 backdrop-blur-xl border border-white/30 rounded-xl overflow-hidden z-10 shadow-xl max-h-96 overflow-y-auto">
                                                            {filteredSongs.map((song, idx) => (
                                                                <button
                                                                    key={song.name}
                                                                    onClick={() => makeGuess(song)}
                                                                    disabled={isSubmittingGuess}
                                                                    className={`w-full px-6 py-3 text-left transition-colors border-b border-gray-200 last:border-b-0 disabled:opacity-50 ${idx === selectedSongIndex ? 'dropdown-selected' : 'dropdown-not-selected'
                                                                        }`}
                                                                >
                                                                    <p className="font-medium">{song.name}</p>
                                                                    <p className="text-sm">{song.albumName} - {song.artistName}</p>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}

                                                    {isSubmittingGuess && (
                                                        <div className="absolute top-full left-0 right-0 mt-2 bg-white/90 backdrop-blur-xl border border-white/30 rounded-xl p-4 flex items-center justify-center gap-2">
                                                            <Loader2 className="w-5 h-5 text-gray-900" />
                                                            <span className="text-gray-900">Processing guess...</span>
                                                        </div>
                                                    )}
                                                </div>

                                                <button
                                                    onClick={giveUp}
                                                    disabled={isSubmittingGuess}
                                                    className="w-full px-6 py-3 bg-red-500/20 hover:bg-red-500/30 disabled:opacity-50 text-white rounded-xl font-semibold border border-red-500/50"
                                                >
                                                    Give Up & Show Answer
                                                </button>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="text-center space-y-4">
                                                {gameState.won ? (
                                                    <div className="bg-green-500/20 border border-green-500/50 rounded-xl p-6">
                                                        <h3 className="text-3xl font-bold text-white mb-2">ðŸŽ‰ You Won!</h3>
                                                        <p className="text-green-200 text-lg">
                                                            You guessed it in {gameState.guesses.length} {gameState.guesses.length === 1 ? 'try' : 'tries'}!
                                                        </p>
                                                    </div>
                                                ) : showAnswer ? (
                                                    <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-6">
                                                        <h3 className="text-3xl font-bold text-white mb-2">ðŸ˜” Game Over</h3>
                                                        <p className="text-red-200 text-lg">Better luck next time!</p>
                                                    </div>
                                                ) : (
                                                    <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-6">
                                                        <h3 className="text-3xl font-bold text-white mb-2">ðŸ˜” Out of Guesses</h3>
                                                        <p className="text-red-200 text-lg">You've used all {MAX_GUESSES} guesses!</p>
                                                    </div>
                                                )}

                                                {(gameState.gameOver && (gameState.won || showAnswer)) && (
                                                    <div className="bg-white/10 rounded-xl p-6 border border-white/20">
                                                        <div className="flex items-center gap-4 justify-center mb-4">
                                                            <img src={gameState.targetSong.artwork} alt="" className="w-24 h-24 rounded-lg" />
                                                            <div className="text-left">
                                                                <p className="text-2xl font-bold text-white">{gameState.targetSong.name}</p>
                                                                <p className="text-lg text-gray-300">{gameState.targetSong.albumName}</p>
                                                                <p className="text-base text-gray-400">{gameState.targetSong.artistName}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="flex gap-3">
                                                    <button
                                                        onClick={copyToClipboard}
                                                        className={`flex-1 px-6 py-4 ${copied ? 'bg-green-500/30' : 'bg-blue-500/20'} hover:bg-blue-500/30 text-white rounded-xl font-semibold border ${copied ? 'border-green-500/50' : 'border-blue-500/50'} flex items-center justify-center gap-2 transition-all`}
                                                    >
                                                        <Copy className="w-5 h-5" />
                                                        {copied ? 'âœ“ Copied!' : 'Share Result'}
                                                    </button>
                                                    <button
                                                        onClick={playAgain}
                                                        className="flex-1 px-6 py-4 bg-white text-black hover:bg-gray-100 rounded-xl font-semibold"
                                                    >
                                                        Play Again
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        {gameState.guesses.length > 0 && (
                                            <div className="mt-8">
                                                <h3 className="text-white font-semibold text-lg mb-4">Your Guesses:</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                                                {gameState.guesses.map((guess, idx) => (
                                                    <div key={idx} className="bg-white/10 rounded-xl p-4 border border-white/20">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <img src={guess.song.artwork} alt="" className="w-12 h-12 rounded-lg object-cover flex-shrink-0" />
                                                            <div className="flex-1 min-w-0">
                                                                <p className="text-white font-semibold text-sm truncate">{guess.song.name}</p>
                                                                <p className="text-gray-300 text-xs truncate">{guess.song.albumName}</p>
                                                            </div>
                                                        </div>
                                                        <div className={`grid ${gameState.selectedArtists.length > 1 ? 'grid-cols-5' : 'grid-cols-4'} gap-2`}>
                                                            <div className={`p-3 rounded-lg ${getColorClass(guess.durationMatch)} relative`}>
                                                                <p className="text-white text-xs font-medium mb-1">Duration</p>
                                                                <div className="flex items-center justify-between">
                                                                    <p className="text-white text-sm">{formatDuration(guess.song.duration)}</p>
                                                                    {guess.durationDirection === 'up' && <TrendingUp className="w-4 h-4 text-white" />}
                                                                    {guess.durationDirection === 'down' && <TrendingDown className="w-4 h-4 text-white" />}
                                                                </div>
                                                            </div>
                                                            <div className={`p-3 rounded-lg ${getColorClass(guess.dateMatch)} relative`}>
                                                                <p className="text-white text-xs font-medium mb-1">Release</p>
                                                                <div className="flex items-center justify-between">
                                                                    <p className="text-white text-sm">{formatDate(guess.song.releaseDate)}</p>
                                                                    {guess.dateDirection === 'up' && <TrendingUp className="w-4 h-4 text-white" />}
                                                                    {guess.dateDirection === 'down' && <TrendingDown className="w-4 h-4 text-white" />}
                                                                </div>
                                                            </div>
                                                            <div className={`p-3 rounded-lg ${getColorClass(guess.trackMatch)} relative`}>
                                                                <p className="text-white text-xs font-medium mb-1">Track #</p>
                                                                <div className="flex items-center justify-between">
                                                                    <p className="text-white text-sm">#{guess.song.trackNumber}</p>
                                                                    {guess.trackDirection === 'up' && <TrendingUp className="w-4 h-4 text-white" />}
                                                                    {guess.trackDirection === 'down' && <TrendingDown className="w-4 h-4 text-white" />}
                                                                </div>
                                                            </div>
                                                            <div className={`p-3 rounded-lg ${getColorClass(guess.albumMatch)}`}>
                                                                <p className="text-white text-xs font-medium mb-1">Album</p>
                                                                <p className="text-white text-sm truncate">
                                                                    {guess.albumMatch === 'correct' ? 'âœ“' : 'âœ—'}
                                                                </p>
                                                            </div>
                                                            {gameState.selectedArtists.length > 1 && guess.artistMatch && (
                                                                <div className={`p-3 rounded-lg ${getColorClass(guess.artistMatch)}`}>
                                                                    <p className="text-white text-xs font-medium mb-1">Artist</p>
                                                                    <p className="text-white text-sm truncate">{guess.song.artistName.split(' ')[0]}</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GuesserMode />, document.getElementById('root'));
    </script>
    <!-- Play Game Button (shown only on selectAlbums stage, truly fixed to viewport) -->
    <button id="playGameBtn"
        onclick="if(window.__guesserAlbumCount > 0 && !window.__guesserLoadingSongs) window.__guesserStartGame();"
        style="display:none; position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%); z-index:40;
               background:rgba(255,255,255,0.95); color:#000; border:1px solid rgba(255,255,255,0.3);
               backdrop-filter:blur(20px); box-shadow:0 8px 32px rgba(0,0,0,0.5);
               padding:1rem 3.5rem; border-radius:1rem; font-size:1.125rem; font-weight:700;
               align-items:center; gap:0.75rem; white-space:nowrap;
               transition:transform 0.2s, opacity 0.2s;">
        <span id="playGameLabel">Play Game</span>
        <svg style="width:1.5rem;height:1.5rem;flex-shrink:0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
    </button>

    <!-- Help Button -->
    <button id="helpBtn"
        onclick="document.getElementById('helpModal').classList.remove('hidden'); document.body.style.overflow='hidden'; window.openHelpInit('helpModal','helpSearch');"
        class="fixed bottom-6 right-6 w-12 h-12 flex items-center justify-center rounded-full z-40 transition-all duration-300 hover:scale-110 active:scale-95"
        style="background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(20px); box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
        style="background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);"
        onclick="if(event.target===this){this.classList.add('hidden');document.body.style.overflow='auto';}">
        <div class="w-full max-w-2xl" onclick="event.stopPropagation()">
            <div class="rounded-3xl p-6 shadow-2xl"
                style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(40px);">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-white">Guesser â€” Help</h3>
                    <button
                        onclick="document.getElementById('helpModal').classList.add('hidden');document.body.style.overflow='auto';"
                        class="w-10 h-10 flex items-center justify-center rounded-full transition-all flex-shrink-0"
                        style="background: rgba(255,255,255,0.1);">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="relative mb-5">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 105 11a6 6 0 0012 0z"/></svg>
                    <input id="helpSearch" type="text" placeholder="Search help topicsâ€¦" class="w-full pl-9 pr-4 py-2 rounded-xl text-sm text-white placeholder-white/30 focus:outline-none focus:ring-1 focus:ring-white/30" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);">
                </div>
                <div class="space-y-3 overflow-y-auto pr-1" style="max-height: 62vh;">


                        <div data-help-section="overview" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    What is Guesser?
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <p data-help-text="Guesser is a music Wordle. A random song is chosen from whatever artist and albums you pick, and you have 6 tries to identify it. After each wrong guess you get colour-coded clues telling you how close you were across five different attributes of the song.">Guesser is a music Wordle. A random song is chosen from whatever artist and albums you pick, and you have 6 tries to identify it. After each wrong guess you get colour-coded clues telling you how close you were across five different attributes of the song.</p><p data-help-text="The more artists and albums you include, the larger the song pool â€” making the game harder and more replayable. Artists with bigger discographies are the most fun.">The more artists and albums you include, the larger the song pool â€” making the game harder and more replayable. Artists with bigger discographies are the most fun.</p>
                            </div>
                        </div>
                        <div data-help-section="setup" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/></svg>
                                    Setting Up a Game
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <p data-help-text="<strong>Search for an artist</strong> â€” Type an artist name in the search box and hit Search (or press Enter). A list of matching artists appears â€” select the one you want. Their discography loads automatically."><strong>Search for an artist</strong> â€” Type an artist name in the search box and hit Search (or press Enter). A list of matching artists appears â€” select the one you want. Their discography loads automatically.</p><p data-help-text="<strong>Adding multiple artists</strong> â€” You can add more than one artist to create a combined song pool from all of them. After adding the first artist, use the search box again to find and add another. The album selection screen shows each artist's albums in separate tabs."><strong>Adding multiple artists</strong> â€” You can add more than one artist to create a combined song pool from all of them. After adding the first artist, use the search box again to find and add another. The album selection screen shows each artist's albums in separate tabs.</p><p data-help-text="<strong>Selecting albums</strong> â€” A grid of the artist's albums appears. Click individual albums to include or exclude them, or use Select All / Deselect All for convenience. Albums are sorted by type (Albums first, then EPs, then Singles) and then by release date newest-first."><strong>Selecting albums</strong> â€” A grid of the artist's albums appears. Click individual albums to include or exclude them, or use Select All / Deselect All for convenience. Albums are sorted by type (Albums first, then EPs, then Singles) and then by release date newest-first.</p><p data-help-text="<strong>Song pool size</strong> â€” A count of selected songs updates as you toggle albums. More songs = harder game. You need at least one album selected to start."><strong>Song pool size</strong> â€” A count of selected songs updates as you toggle albums. More songs = harder game. You need at least one album selected to start.</p><p data-help-text="<strong>Start the game</strong> â€” Once you're happy with the selection, hit the Play Game button (fixed at the bottom of the screen). A random song is chosen from your pool and the game begins."><strong>Start the game</strong> â€” Once you're happy with the selection, hit the Play Game button (fixed at the bottom of the screen). A random song is chosen from your pool and the game begins.</p><p data-help-text="<strong>Recent & pinned games</strong> â€” Previously played configurations are saved automatically in a Recent Games list on the home screen. You can pin up to 8 favourite configurations so they stay permanently available at the top of the list without getting pushed out by new recent games."><strong>Recent & pinned games</strong> â€” Previously played configurations are saved automatically in a Recent Games list on the home screen. You can pin up to 8 favourite configurations so they stay permanently available at the top of the list without getting pushed out by new recent games.</p><p data-help-text="<strong>Edit a saved game</strong> â€” Click the edit (pencil) icon on any saved game card to go back to the album selection screen for that configuration and tweak which albums are included before playing again."><strong>Edit a saved game</strong> â€” Click the edit (pencil) icon on any saved game card to go back to the album selection screen for that configuration and tweak which albums are included before playing again.</p>
                            </div>
                        </div>
                        <div data-help-section="playing" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Playing the Game
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <p data-help-text="<strong>Making a guess</strong> â€” Start typing a song name in the guess box. A dropdown appears with up to 10 matching songs from your pool â€” filtered in real time as you type. Songs you have already guessed are excluded from the list."><strong>Making a guess</strong> â€” Start typing a song name in the guess box. A dropdown appears with up to 10 matching songs from your pool â€” filtered in real time as you type. Songs you have already guessed are excluded from the list.</p><p data-help-text="<strong>Selecting a song</strong> â€” Click a song in the dropdown, or use the arrow keys to navigate it and press Enter to confirm. The guess is submitted immediately."><strong>Selecting a song</strong> â€” Click a song in the dropdown, or use the arrow keys to navigate it and press Enter to confirm. The guess is submitted immediately.</p><p data-help-text="<strong>Already guessed</strong> â€” Songs you have already guessed are greyed out and won't appear in the dropdown, so you can't accidentally repeat yourself."><strong>Already guessed</strong> â€” Songs you have already guessed are greyed out and won't appear in the dropdown, so you can't accidentally repeat yourself.</p><p data-help-text="<strong>6 guesses</strong> â€” You have 6 attempts total. Each wrong guess is added to the guess history below with its clue row visible. If you run out of guesses the answer is revealed."><strong>6 guesses</strong> â€” You have 6 attempts total. Each wrong guess is added to the guess history below with its clue row visible. If you run out of guesses the answer is revealed.</p>
                            </div>
                        </div>
                        <div data-help-section="clues" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                                    Reading the Clues
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <p data-help-text="Each guess shows a row of coloured tiles, one for each of the five attributes:">Each guess shows a row of coloured tiles, one for each of the five attributes:</p><p data-help-text="<strong>Duration</strong> â€” The length of the song in minutes:seconds. Green = exact match. Yellow = within 30 seconds. Red = more than 30 seconds away. An arrow points up if the target song is longer than your guess, down if it is shorter."><strong>Duration</strong> â€” The length of the song in minutes:seconds. Green = exact match. Yellow = within 30 seconds. Red = more than 30 seconds away. An arrow points up if the target song is longer than your guess, down if it is shorter.</p><p data-help-text="<strong>Release date</strong> â€” The release date of the song (usually matching its album release). Green = same date. Yellow = within roughly one year. Red = further away. Arrow indicates direction (earlier/later)."><strong>Release date</strong> â€” The release date of the song (usually matching its album release). Green = same date. Yellow = within roughly one year. Red = further away. Arrow indicates direction (earlier/later).</p><p data-help-text="<strong>Track number</strong> â€” The track's position on its album. Green = exact match. Yellow = within 2 tracks. Red = further away. Arrow indicates higher/lower."><strong>Track number</strong> â€” The track's position on its album. Green = exact match. Yellow = within 2 tracks. Red = further away. Arrow indicates higher/lower.</p><p data-help-text="<strong>Album</strong> â€” Whether the guessed song is on the same album as the target. Green tick = same album. Red cross = different album. No arrow â€” it's binary."><strong>Album</strong> â€” Whether the guessed song is on the same album as the target. Green tick = same album. Red cross = different album. No arrow â€” it's binary.</p><p data-help-text="<strong>Artist (multi-artist mode only)</strong> â€” Shown only when you have multiple artists in the pool. Green = same artist. Red = different artist. Helps you narrow down which artist the target song belongs to."><strong>Artist (multi-artist mode only)</strong> â€” Shown only when you have multiple artists in the pool. Green = same artist. Red = different artist. Helps you narrow down which artist the target song belongs to.</p>
                            </div>
                        </div>
                        <div data-help-section="hints" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                    Progressive Hints
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <p data-help-text="Additional hints unlock automatically as the game progresses to help you if you're stuck:">Additional hints unlock automatically as the game progresses to help you if you're stuck:</p><p data-help-text="<strong>After guess 2</strong> â€” The first letter of the song title is revealed."><strong>After guess 2</strong> â€” The first letter of the song title is revealed.</p><p data-help-text="<strong>After guess 3</strong> â€” The total character count of the song title is shown (including spaces)."><strong>After guess 3</strong> â€” The total character count of the song title is shown (including spaces).</p><p data-help-text="<strong>After guess 5</strong> â€” The name of the album the target song is from is revealed. This is the last hint before your final guess."><strong>After guess 5</strong> â€” The name of the album the target song is from is revealed. This is the last hint before your final guess.</p>
                            </div>
                        </div>
                        <div data-help-section="endgame" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                                    End of Game
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <p data-help-text="<strong>Win</strong> â€” If you guess correctly you see a win screen showing how many guesses it took. Your win/loss stats update automatically."><strong>Win</strong> â€” If you guess correctly you see a win screen showing how many guesses it took. Your win/loss stats update automatically.</p><p data-help-text="<strong>Lose</strong> â€” After 6 failed guesses the answer is revealed â€” song name, artist, album, and all clue details."><strong>Lose</strong> â€” After 6 failed guesses the answer is revealed â€” song name, artist, album, and all clue details.</p><p data-help-text="<strong>Share</strong> â€” After any game (win or lose) you can copy your result as an emoji grid â€” the same colour-coded format used in Wordle shares â€” to post on social media."><strong>Share</strong> â€” After any game (win or lose) you can copy your result as an emoji grid â€” the same colour-coded format used in Wordle shares â€” to post on social media.</p><p data-help-text="<strong>Play again</strong> â€” Click Play Again to immediately start a new game using the same artist and album configuration. A different song is picked at random from the same pool."><strong>Play again</strong> â€” Click Play Again to immediately start a new game using the same artist and album configuration. A different song is picked at random from the same pool.</p><p data-help-text="<strong>Change setup</strong> â€” Click Change Setup to go back to the album selection screen and adjust which artists or albums are in the pool before starting a new game."><strong>Change setup</strong> â€” Click Change Setup to go back to the album selection screen and adjust which artists or albums are in the pool before starting a new game.</p>
                            </div>
                        </div>
                        <div data-help-section="stats" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                    Stats & History
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <p data-help-text="<strong>Win/loss tracking</strong> â€” Your overall win count, loss count, current win streak, and best win streak are tracked and saved locally to your browser."><strong>Win/loss tracking</strong> â€” Your overall win count, loss count, current win streak, and best win streak are tracked and saved locally to your browser.</p><p data-help-text="<strong>Favourite artist</strong> â€” The stats panel shows which artist you have played against the most."><strong>Favourite artist</strong> â€” The stats panel shows which artist you have played against the most.</p><p data-help-text="<strong>Recent games</strong> â€” The home screen shows your last several game configurations in a scrollable Recent Games row, so you can quickly replay a past setup without searching again. Up to a fixed number of recent games are stored."><strong>Recent games</strong> â€” The home screen shows your last several game configurations in a scrollable Recent Games row, so you can quickly replay a past setup without searching again. Up to a fixed number of recent games are stored.</p><p data-help-text="<strong>Pinned games</strong> â€” Any game configuration you pin stays at the top of the home screen permanently â€” great for your go-to artist. You can pin up to 8 configurations. Pinned games won't be displaced by new recent games."><strong>Pinned games</strong> â€” Any game configuration you pin stays at the top of the home screen permanently â€” great for your go-to artist. You can pin up to 8 configurations. Pinned games won't be displaced by new recent games.</p>
                            </div>
                        </div>
                        <div data-help-section="shortcuts" class="rounded-xl overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                            <div class="help-section-header flex items-center justify-between px-4 py-3" style="background:rgba(255,255,255,0.05);">
                                <h4 class="help-section-title text-base font-semibold text-white flex items-center gap-2">
                                    <svg class="w-4 h-4 opacity-60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
                                    Keyboard Shortcuts
                                </h4>
                                <svg class="help-chevron w-4 h-4 text-white/40 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="help-section-body px-4 py-3 space-y-2 text-sm text-gray-300">
                                <div class="flex items-center justify-between"><span data-help-text="Navigate song dropdown">Navigate song dropdown</span><kbd class="px-2 py-0.5 rounded text-xs ml-2 flex-shrink-0" style="background:rgba(255,255,255,0.1);">â†‘ / â†“ arrow keys</kbd></div><div class="flex items-center justify-between"><span data-help-text="Submit highlighted guess">Submit highlighted guess</span><kbd class="px-2 py-0.5 rounded text-xs ml-2 flex-shrink-0" style="background:rgba(255,255,255,0.1);">Enter</kbd></div><div class="flex items-center justify-between"><span data-help-text="Clear search / close dropdown">Clear search / close dropdown</span><kbd class="px-2 py-0.5 rounded text-xs ml-2 flex-shrink-0" style="background:rgba(255,255,255,0.1);">Escape</kbd></div><div class="flex items-center justify-between"><span data-help-text="Close this modal">Close this modal</span><kbd class="px-2 py-0.5 rounded text-xs ml-2 flex-shrink-0" style="background:rgba(255,255,255,0.1);">Escape</kbd></div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>


<style>
.help-section { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }
.help-section-header { cursor: pointer; user-select: none; }
.help-section-header:hover { opacity: 0.85; }
.help-search-highlight { background: rgba(255,255,255,0.18); border-radius: 2px; }
.help-section.hidden-section { display: none; }
</style>
<script>
(function(){
  function initHelp(modalId, searchId) {
    var modal = document.getElementById(modalId);
    if (!modal) return;
    var searchInput = document.getElementById(searchId);
    var sections = modal.querySelectorAll('[data-help-section]');

    // Collapse/expand toggle
    sections.forEach(function(sec) {
      var header = sec.querySelector('.help-section-header');
      var body   = sec.querySelector('.help-section-body');
      var chevron = sec.querySelector('.help-chevron');
      if (!header || !body) return;
      var open = true;
      header.addEventListener('click', function() {
        open = !open;
        body.style.maxHeight = open ? body.scrollHeight + 'px' : '0px';
        body.style.opacity   = open ? '1' : '0';
        if (chevron) chevron.style.transform = open ? 'rotate(0deg)' : 'rotate(-90deg)';
      });
      // set initial open state
      body.style.maxHeight = body.scrollHeight + 'px';
      body.style.opacity = '1';
      body.style.overflow = 'hidden';
      body.style.transition = 'max-height 0.3s ease, opacity 0.25s ease';
    });

    if (!searchInput) return;

    searchInput.addEventListener('input', function() {
      var q = this.value.trim().toLowerCase();
      sections.forEach(function(sec) {
        if (!q) {
          sec.classList.remove('hidden-section');
          // restore highlight
          sec.querySelectorAll('[data-help-text]').forEach(function(el) {
            el.innerHTML = el.getAttribute('data-help-text');
          });
          return;
        }
        var title = (sec.querySelector('.help-section-title') || {}).textContent || '';
        var texts = Array.from(sec.querySelectorAll('[data-help-text]'));
        var allText = title + ' ' + texts.map(function(e){ return e.getAttribute('data-help-text'); }).join(' ');
        var match = allText.toLowerCase().indexOf(q) !== -1;
        sec.classList.toggle('hidden-section', !match);
        if (match) {
          texts.forEach(function(el) {
            var raw = el.getAttribute('data-help-text');
            var re = new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi');
            el.innerHTML = raw.replace(re, '<mark class="help-search-highlight">$1</mark>');
          });
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    initHelp('helpModal', 'helpSearch');
  });
  // Also init when modal is opened (in case DOMContentLoaded already fired)
  var _orig = window.openHelp;
  window.openHelpInit = function(modalId, searchId){ initHelp(modalId, searchId); };
})();
</script>

</body>

</html>
