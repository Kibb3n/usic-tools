<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topsters - Music Grid Creator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @keyframes blob1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(150px, 100px) scale(1.2); }
            66% { transform: translate(-100px, 150px) scale(0.9); }
        }
        @keyframes blob2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(-150px, -100px) scale(0.9); }
            66% { transform: translate(100px, -150px) scale(1.2); }
        }
        .grain {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='3.5' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.3'/%3E%3C/svg%3E");
            pointer-events: none;
        }
        .grid-slot {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
        }
        .grid-slot.hidden-guides {
            border-color: rgba(255, 255, 255, 0.1);
        }
        .grid-slot.drag-over {
            border-color: #60a5fa !important;
            background: rgba(96, 165, 250, 0.2);
            transform: scale(1.05);
        }
        .classic-slot {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
        }
        .classic-slot.hidden-guides {
            border-color: transparent;
        }
        .classic-slot.drag-over {
            border-color: #60a5fa !important;
            background: rgba(96, 165, 250, 0.2);
            transform: scale(1.05);
        }
        .album-cover {
            cursor: grab;
            user-select: none;
            transition: transform 0.2s;
        }
        .album-cover:active {
            cursor: grabbing;
        }
        .album-cover.dragging {
            opacity: 0.4;
            transform: scale(0.9);
        }
        .about-you-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .editable-label {
            outline: none;
            text-align: center;
            cursor: text;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px dashed transparent;
        }
        .editable-label:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }
        .editable-label:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.875rem;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const Trash = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const Pencil = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
            </svg>
        );

        const Undo = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );

        // Helper for iTunes API
        const jsonpRequest = (url) => {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                const script = document.createElement('script');
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                document.body.appendChild(script);
            });
        };

        const extractColorsFromImage = async (imageUrl) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        const colorMap = {};
                        for (let i = 0; i < data.length; i += 4) {
                            const r = Math.floor(data[i] / 30) * 30;
                            const g = Math.floor(data[i + 1] / 30) * 30;
                            const b = Math.floor(data[i + 2] / 30) * 30;
                            const brightness = (r + g + b) / 3;
                            if (brightness > 30 && brightness < 230) {
                                const key = `${r},${g},${b}`;
                                colorMap[key] = (colorMap[key] || 0) + 1;
                            }
                        }
                        const sortedColors = Object.entries(colorMap)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3)
                            .map(([color]) => {
                                const [r, g, b] = color.split(',').map(Number);
                                return `rgb(${r}, ${g}, ${b})`;
                            });
                        resolve(sortedColors.length > 0 ? sortedColors : ['#ff0080', '#7928ca']);
                    } catch (e) {
                        resolve(['#ff0080', '#7928ca']);
                    }
                };
                img.onerror = () => resolve(['#ff0080', '#7928ca']);
                img.src = imageUrl;
            });
        };

        function AnimatedBackground({ colors }) {
            return (
                <div className="fixed inset-0 overflow-hidden pointer-events-none">
                    <div
                        className="absolute w-[900px] h-[900px] rounded-full opacity-70 blur-3xl will-change-transform"
                        style={{
                            background: `radial-gradient(circle, ${colors[0]} 0%, transparent 70%)`,
                            animation: `blob1 12s ease-in-out infinite`,
                            top: '50%',
                            left: '33.333%',
                            transform: 'translate(-50%, -50%)',
                        }}
                    />
                    <div
                        className="absolute w-[900px] h-[900px] rounded-full opacity-70 blur-3xl will-change-transform"
                        style={{
                            background: `radial-gradient(circle, ${colors[1]} 0%, transparent 70%)`,
                            animation: `blob2 12s ease-in-out infinite`,
                            top: '50%',
                            right: '33.333%',
                            transform: 'translate(50%, -50%)',
                        }}
                    />
                    <div className="absolute inset-0 grain opacity-30" />
                </div>
            );
        }

        const aboutYouLabels = [
            'Favourite Album', 'Best Narrative', 'Favourite Cover', "I'll Listen Someday", 'Personal Impact', 'Bad Day Cure',
            'You enjoy but most don\'t', 'You don\'t enjoy but most do', 'Underrated', 'Overrated', 'Not usually my thing but...', 'Best Instrumental',
            'Best Vocals', 'Simple but fun', 'Best Mixtape', 'Consistent Discography', 'Biggest Letdown', 'Biggest Surprise',
            'Best Soundtrack', 'Most Unique', 'Favourite Band', 'Favourite Solo Artist', 'Best EP', 'Most Depressing'
        ];

        function TopstersMode() {
            const [layout, setLayout] = useState('standard');
            const [gridWidth, setGridWidth] = useState(5);
            const [gridHeight, setGridHeight] = useState(5);
            const [title, setTitle] = useState('My Top Albums');
            const [titleColor, setTitleColor] = useState('#ffffff');
            const [bgColor, setBgColor] = useState('#000000');
            const [showTitles, setShowTitles] = useState(false);
            const [showGuidelines, setShowGuidelines] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [grid, setGrid] = useState([]);
            const [aboutYouGrid, setAboutYouGrid] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null);
            const [draggedFrom, setDraggedFrom] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);
            const [bgColors, setBgColors] = useState(['#ff0080', '#7928ca']);
            const [history, setHistory] = useState([]);
            const [showConfirm, setShowConfirm] = useState(false);
            const [uploadedImages, setUploadedImages] = useState([]);
            const [searchPage, setSearchPage] = useState(0);
            const [showImageModal, setShowImageModal] = useState(false);
            const [pendingImage, setPendingImage] = useState(null);
            const [customTitle, setCustomTitle] = useState('');
            const [customArtist, setCustomArtist] = useState('');
            const [performanceMode, setPerformanceMode] = useState(false);
            const [renameModalOpen, setRenameModalOpen] = useState(false);
            const [renameIndex, setRenameIndex] = useState(null);
            const [renameTitle, setRenameTitle] = useState('');
            const [renameArtist, setRenameArtist] = useState('');
            
            const gridRef = useRef(null);
            const fileInputRef = useRef(null);
            const scrollIntervalRef = useRef(null);

            const itemsPerPage = 20;
            const totalPages = Math.ceil(searchResults.length / itemsPerPage);
            const paginatedResults = searchResults.slice(
                searchPage * itemsPerPage,
                (searchPage + 1) * itemsPerPage
            );

            // Initialize grids
            useEffect(() => {
                if (layout === 'standard') {
                    const newGrid = Array(gridHeight * gridWidth).fill(null);
                    setGrid(prevGrid => {
                        for (let i = 0; i < Math.min(prevGrid.length, newGrid.length); i++) {
                            newGrid[i] = prevGrid[i];
                        }
                        return newGrid;
                    });
                } else if (layout === 'aboutYou') {
                    setAboutYouGrid(prevGrid => {
                        const newGrid = aboutYouLabels.map((label, i) => 
                            prevGrid[i] || { album: null, label }
                        );
                        return newGrid;
                    });
                } else if (layout === 'classic') {
                    // Ensure classic always has exactly 42 slots
                    setGrid(prevGrid => {
                        const newGrid = Array(42).fill(null);
                        for (let i = 0; i < Math.min(prevGrid.length, 42); i++) {
                            newGrid[i] = prevGrid[i];
                        }
                        return newGrid;
                    });
                }
            }, [gridWidth, gridHeight, layout]);

            // Update background colors based on albums
            useEffect(() => {
                const filledAlbums = layout === 'aboutYou' 
                    ? aboutYouGrid.filter(cell => cell?.album).map(cell => cell.album)
                    : grid.filter(album => album);
                
                if (filledAlbums.length >= 2) {
                    const lastTwo = filledAlbums.slice(-2);
                    Promise.all([
                        extractColorsFromImage(lastTwo[0].image),
                        extractColorsFromImage(lastTwo[1].image)
                    ]).then(([colors1, colors2]) => {
                        setBgColors([colors1[0], colors2[0]]);
                    });
                }
            }, [grid, aboutYouGrid, layout]);

            const saveToHistory = () => {
                setHistory(prev => [...prev.slice(-9), { grid: [...grid], aboutYouGrid: [...aboutYouGrid] }]);
            };

            const undo = () => {
                if (history.length === 0) return;
                const prev = history[history.length - 1];
                setGrid(prev.grid);
                setAboutYouGrid(prev.aboutYouGrid);
                setHistory(h => h.slice(0, -1));
            };

            const normalizeString = (str) => {
                return str.toLowerCase().replace(/[^a-z0-9]/g, '');
            };








            const searchAlbums = async () => {
                if (!searchQuery.trim()) return;

                setLoading(true);
                setSearchResults([]);
                setSearchPage(0);

                // Create promises for all searches to run in parallel
                
                // 1. iTunes Search - Most reliable for music
                const itunesPromise = jsonpRequest(
                    `https://itunes.apple.com/search?term=${encodeURIComponent(searchQuery)}&entity=album&limit=40`
                ).then(data => {
                    if (data.results && data.results.length > 0) {
                        return data.results
                            .filter(item => item.wrapperType === 'collection')
                            .map(album => ({
                                id: `itunes-${album.collectionId}`,
                                title: album.collectionName,
                                artist: album.artistName,
                                image: album.artworkUrl100.replace('100x100', '600x600'),
                                year: album.releaseDate ? new Date(album.releaseDate).getFullYear() : '',
                                source: 'iTunes'
                            }));
                    }
                    return [];
                }).catch(error => {
                    console.error('iTunes Search error:', error);
                    return [];
                });

                // 2. Last.fm API - Will work on Neocities!
                const lastfmPromise = (async () => {
                    try {
                        const lastfmUrl = `https://ws.audioscrobbler.com/2.0/?method=album.search&album=${encodeURIComponent(searchQuery)}&api_key=33866e12a02528e0bb9211bd2f351c28&format=json&limit=30`;
                        const lastfmResponse = await fetch(lastfmUrl);
                        const lastfmData = await lastfmResponse.json();

                        if (lastfmData.results?.albummatches?.album) {
                            const albums = Array.isArray(lastfmData.results.albummatches.album) 
                                ? lastfmData.results.albummatches.album 
                                : [lastfmData.results.albummatches.album];
                            
                            return albums
                                .filter(album => album.image && album.image.length > 0)
                                .map(album => {
                                    // Get the largest image available
                                    const image = album.image.find(img => img.size === 'extralarge') || 
                                                album.image.find(img => img.size === 'large') ||
                                                album.image.find(img => img.size === 'medium');
                                    const imageUrl = image?.['#text'] || '';
                                    
                                    return {
                                        id: `lastfm-${album.mbid || Math.random()}-${album.name}`,
                                        title: album.name,
                                        artist: album.artist,
                                        image: imageUrl,
                                        year: '',
                                        source: 'Last.fm'
                                    };
                                })
                                .filter(album => 
                                    album.image && 
                                    album.image.length > 20 && 
                                    !album.image.includes('2a96cbd8b46e442fc41c2b86b821562f') &&
                                    !album.image.includes('c6f59c1e5e7240a4c0d427abd71f3dbb')
                                ); // Filter out Last.fm placeholder images
                        }
                        return [];
                    } catch (error) {
                        console.error('Last.fm search error:', error);
                        return [];
                    }
                })();

                // 3. MusicBrainz Cover Art Archive - Should work on Neocities
                const musicBrainzPromise = (async () => {
                    try {
                        const mbUrl = `https://musicbrainz.org/ws/2/release-group/?query=${encodeURIComponent(searchQuery)}&limit=15&fmt=json`;
                        const mbResponse = await fetch(mbUrl, {
                            headers: {
                                'User-Agent': 'TopstersClone/1.0 (https://neocities.org)'
                            }
                        });
                        const mbData = await mbResponse.json();

                        if (mbData['release-groups']) {
                            const results = await Promise.all(
                                mbData['release-groups']
                                    .filter(rg => rg['primary-type'] === 'Album')
                                    .slice(0, 10)
                                    .map(async (rg) => {
                                        try {
                                            // Try to get cover art
                                            const coverUrl = `https://coverartarchive.org/release-group/${rg.id}`;
                                            const coverResponse = await fetch(coverUrl);
                                            if (coverResponse.ok) {
                                                const coverData = await coverResponse.json();
                                                const image = coverData.images?.[0]?.thumbnails?.large || 
                                                            coverData.images?.[0]?.image;
                                                
                                                if (image) {
                                                    return {
                                                        id: `mb-${rg.id}`,
                                                        title: rg.title,
                                                        artist: rg['artist-credit']?.[0]?.name || 'Unknown Artist',
                                                        image: image,
                                                        year: rg['first-release-date'] ? rg['first-release-date'].substring(0, 4) : '',
                                                        source: 'MusicBrainz'
                                                    };
                                                }
                                            }
                                        } catch (e) {
                                            return null;
                                        }
                                        return null;
                                    })
                            );
                            return results.filter(r => r !== null);
                        }
                        return [];
                    } catch (error) {
                        console.error('MusicBrainz search error:', error);
                        return [];
                    }
                })();

                // Wait for all searches to complete with timeout
                const timeoutPromise = new Promise((resolve) => 
                    setTimeout(() => resolve([[], [], []]), 8000)
                );
                
                const [itunesResults, lastfmResults, musicBrainzResults] = await Promise.race([
                    Promise.all([itunesPromise, lastfmPromise, musicBrainzPromise]),
                    timeoutPromise
                ]);
                
                // Combine and deduplicate results with less harsh matching
                const allResults = [...itunesResults, ...lastfmResults, ...musicBrainzResults];
                
                // More lenient duplicate detection - only match if title is very similar
                const seen = new Map();
                const uniqueResults = allResults.filter(album => {
                    const titleKey = normalizeString(album.title);
                    const artistKey = normalizeString(album.artist);
                    
                    // Check if we have a very similar entry
                    for (const [key, value] of seen.entries()) {
                        const [seenTitle, seenArtist] = key.split('|||');
                        // Only consider duplicate if both title AND artist match closely
                        if (seenTitle === titleKey && seenArtist === artistKey) {
                            return false;
                        }
                    }
                    
                    seen.set(`${titleKey}|||${artistKey}`, album);
                    return true;
                });
                
                setSearchResults(uniqueResults);
                setLoading(false);
            };
            
            
            
            
            
            
            
            
            const handleDragStart = (e, album, fromIndex) => {
                setDraggedItem(album);
                setDraggedFrom(fromIndex);
                e.dataTransfer.effectAllowed = 'move';
                e.currentTarget.classList.add('dragging');
            };

            const handleDragEnd = (e) => {
                e.currentTarget.classList.remove('dragging');
                setDragOverIndex(null);
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverIndex(index);

                // Auto-scroll when dragging near edges
                const y = e.clientY;
                const scrollThreshold = 100;
                const scrollSpeed = 10;

                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }

                if (y < scrollThreshold) {
                    scrollIntervalRef.current = setInterval(() => {
                        window.scrollBy(0, -scrollSpeed);
                    }, 16);
                } else if (y > window.innerHeight - scrollThreshold) {
                    scrollIntervalRef.current = setInterval(() => {
                        window.scrollBy(0, scrollSpeed);
                    }, 16);
                }
            };

            const handleDragLeave = () => {
                setDragOverIndex(null);
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
            };

            const handleDrop = (e, toIndex) => {
                e.preventDefault();
                setDragOverIndex(null);
                
                if (draggedItem) {
                    saveToHistory();
                    
                    if (layout === 'aboutYou') {
                        const newGrid = [...aboutYouGrid];
                        if (draggedFrom !== null && draggedFrom >= 0) {
                            newGrid[draggedFrom] = { ...newGrid[draggedFrom], album: null };
                        }
                        newGrid[toIndex] = { ...newGrid[toIndex], album: draggedItem };
                        setAboutYouGrid(newGrid);
                    } else {
                        const newGrid = [...grid];
                        if (draggedFrom !== null && draggedFrom >= 0) {
                            newGrid[draggedFrom] = null;
                        }
                        newGrid[toIndex] = draggedItem;
                        setGrid(newGrid);
                    }
                    setDraggedItem(null);
                    setDraggedFrom(null);
                }
            };

            const removeFromGrid = (index) => {
                saveToHistory();
                if (layout === 'aboutYou') {
                    const newGrid = [...aboutYouGrid];
                    newGrid[index] = { ...newGrid[index], album: null };
                    setAboutYouGrid(newGrid);
                } else {
                    const newGrid = [...grid];
                    newGrid[index] = null;
                    setGrid(newGrid);
                }
            };

            const updateLabel = (index, newLabel) => {
                const newGrid = [...aboutYouGrid];
                newGrid[index] = { ...newGrid[index], label: newLabel };
                setAboutYouGrid(newGrid);
            };

            const openRenameModal = (index) => {
                if (layout === 'aboutYou') return; // Don't allow renaming in About You mode
                
                const album = grid[index];
                if (album) {
                    setRenameIndex(index);
                    setRenameTitle(album.title);
                    setRenameArtist(album.artist);
                    setRenameModalOpen(true);
                }
            };

            const confirmRename = () => {
                if (renameIndex !== null) {
                    saveToHistory();
                    const newGrid = [...grid];
                    newGrid[renameIndex] = {
                        ...newGrid[renameIndex],
                        title: renameTitle,
                        artist: renameArtist
                    };
                    setGrid(newGrid);
                }
                setRenameModalOpen(false);
                setRenameIndex(null);
                setRenameTitle('');
                setRenameArtist('');
            };

            const switchLayout = (newLayout) => {
                setLayout(newLayout);
                if (newLayout === 'aboutYou') {
                    setGridWidth(6);
                    setGridHeight(4);
                }
            };

            const exportAsImage = async () => {
                if (!gridRef.current) return;

                try {
                    const canvas = await html2canvas(gridRef.current, {
                        backgroundColor: bgColor,
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    const link = document.createElement('a');
                    link.download = `topsters-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Failed to export image. Try again or check your browser settings.');
                }
            };

            const exportData = () => {
                const data = {
                    layout,
                    gridWidth,
                    gridHeight,
                    title,
                    titleColor,
                    bgColor,
                    showTitles,
                    showGuidelines,
                    grid,
                    aboutYouGrid
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `topsters-data-${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.grid && !data.aboutYouGrid) {
                            alert('Invalid data file');
                            return;
                        }
                        setLayout(data.layout || 'standard');
                        setGridWidth(data.gridWidth || 5);
                        setGridHeight(data.gridHeight || 5);
                        setTitle(data.title || 'My Top Albums');
                        setTitleColor(data.titleColor || '#ffffff');
                        setBgColor(data.bgColor || '#000000');
                        setShowTitles(data.showTitles || false);
                        setShowGuidelines(data.showGuidelines !== undefined ? data.showGuidelines : true);
                        setGrid(data.grid || []);
                        setAboutYouGrid(data.aboutYouGrid || []);
                    } catch (err) {
                        alert('Failed to import data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };

            const clearGrid = () => {
                setShowConfirm(false);
                saveToHistory();
                if (layout === 'aboutYou') {
                    setAboutYouGrid(aboutYouLabels.map(label => ({ album: null, label })));
                } else if (layout === 'classic') {
                    setGrid(Array(42).fill(null));
                } else {
                    setGrid(Array(gridHeight * gridWidth).fill(null));
                }
            };

            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setPendingImage(event.target.result);
                        setCustomTitle(file.name.replace(/\.[^/.]+$/, ""));
                        setCustomArtist('');
                        setShowImageModal(true);
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = '';
            };

            const confirmImageUpload = () => {
                if (pendingImage) {
                    const newImage = {
                        id: `uploaded-${Date.now()}-${Math.random()}`,
                        title: customTitle || 'Untitled',
                        artist: customArtist || 'Unknown Artist',
                        image: pendingImage,
                        year: ''
                    };
                    setUploadedImages(prev => [...prev, newImage]);
                }
                setShowImageModal(false);
                setPendingImage(null);
                setCustomTitle('');
                setCustomArtist('');
            };

            const hasAlbums = layout === 'aboutYou' 
                ? aboutYouGrid.some(cell => cell?.album)
                : grid.some(album => album);

            const filledAlbums = layout === 'aboutYou'
                ? aboutYouGrid.filter(cell => cell?.album).map(cell => cell.album)
                : grid.filter(album => album);

            return (
                <div className="min-h-screen bg-black relative overflow-hidden">
                    {!performanceMode && <AnimatedBackground colors={bgColors} />}

                    {/* Rename Modal */}
                    {renameModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-4">Rename Album</h3>
                                <div className="space-y-3 mb-6">
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Album Title</label>
                                        <input
                                            type="text"
                                            value={renameTitle}
                                            onChange={(e) => setRenameTitle(e.target.value)}
                                            placeholder="Enter album title"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Artist Name</label>
                                        <input
                                            type="text"
                                            value={renameArtist}
                                            onChange={(e) => setRenameArtist(e.target.value)}
                                            placeholder="Enter artist name"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setRenameModalOpen(false);
                                            setRenameIndex(null);
                                            setRenameTitle('');
                                            setRenameArtist('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmRename}
                                        className="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Rename
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirmation Modal */}
                    {showConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-3">Clear entire grid?</h3>
                                <p className="text-gray-400 mb-6">This will remove all albums. This action cannot be undone.</p>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowConfirm(false)}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={clearGrid}
                                        className="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Clear Grid
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Image Upload Modal */}
                    {showImageModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-4">Add Custom Album</h3>
                                {pendingImage && (
                                    <img src={pendingImage} alt="Preview" className="w-32 h-32 rounded-lg mx-auto mb-4 object-cover" />
                                )}
                                <div className="space-y-3 mb-6">
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Album Title</label>
                                        <input
                                            type="text"
                                            value={customTitle}
                                            onChange={(e) => setCustomTitle(e.target.value)}
                                            placeholder="Enter album title"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Artist Name</label>
                                        <input
                                            type="text"
                                            value={customArtist}
                                            onChange={(e) => setCustomArtist(e.target.value)}
                                            placeholder="Enter artist name"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowImageModal(false);
                                            setPendingImage(null);
                                            setCustomTitle('');
                                            setCustomArtist('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmImageUpload}
                                        className="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Add to Library
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="relative z-10">
                        <div className="flex flex-wrap justify-between items-center gap-4 pt-8 px-4 md:px-8">
                            <a href="µsic.html" className="hover:opacity-80 transition-opacity">
                                <h1 className="text-2xl md:text-3xl font-bold text-white drop-shadow-lg">µsic tools</h1>
                            </a>
                            
                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={undo}
                                    disabled={history.length === 0}
                                    className="px-3 py-2 bg-white/10 hover:bg-white/20 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                    title="Undo last change"
                                >
                                    <Undo className="w-4 h-4" />
                                </button>
                                <button
                                    onClick={exportAsImage}
                                    className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                >
                                    <Download className="w-4 h-4" />
                                    <span className="hidden sm:inline">Image</span>
                                </button>
                                <button
                                    onClick={exportData}
                                    className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                >
                                    <Download className="w-4 h-4" />
                                    <span className="hidden sm:inline">Data</span>
                                </button>
                                <label className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 cursor-pointer transition-colors">
                                    <Download className="w-4 h-4 transform rotate-180" />
                                    <span className="hidden sm:inline">Import</span>
                                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                                </label>
                                <button
                                    onClick={() => setShowConfirm(true)}
                                    className="px-3 md:px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-white rounded-lg border border-red-500/50 flex items-center gap-2 transition-colors"
                                >
                                    <Trash className="w-4 h-4" />
                                    <span className="hidden sm:inline">Clear</span>
                                </button>
                            </div>
                        </div>

                        <div className="p-4 md:p-8 max-w-7xl mx-auto">
                            <div className="grid lg:grid-cols-[320px_1fr] gap-4 md:gap-6">
                                {/* Left Panel */}
                                <div className="space-y-4">
                                    {/* Search Bar - Moved Here */}
                                    <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                        <h3 className="text-lg md:text-xl font-bold text-white mb-4">Search Albums</h3>
                                        <div className="space-y-3">
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    onKeyPress={(e) => e.key === 'Enter' && searchAlbums()}
                                                    placeholder="Search for albums..."
                                                    className="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                />
                                                <button
                                                    onClick={searchAlbums}
                                                    disabled={loading}
                                                    className="px-4 py-2 bg-white text-black hover:bg-gray-100 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-semibold transition-colors flex items-center gap-2"
                                                >
                                                    {loading ? (
                                                        <Loader2 className="w-5 h-5" />
                                                    ) : (
                                                        <Search className="w-5 h-5" />
                                                    )}
                                                </button>
                                            </div>

                                            <button
                                                onClick={() => fileInputRef.current?.click()}
                                                className="w-full px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-white rounded-lg border border-blue-500/50 flex items-center justify-center gap-2 transition-colors"
                                            >
                                                <Upload className="w-5 h-5" />
                                                Upload Custom Image
                                            </button>
                                            <input
                                                ref={fileInputRef}
                                                type="file"
                                                accept="image/*"
                                                onChange={handleImageUpload}
                                                className="hidden"
                                            />

                                            <div className="max-h-[500px] overflow-y-auto space-y-2">
                                                {/* Uploaded Images */}
                                                {uploadedImages.length > 0 && (
                                                    <>
                                                        <p className="text-sm font-semibold text-white/70 mt-2">Uploaded Images</p>
                                                        {uploadedImages.map((album) => (
                                                            <div
                                                                key={album.id}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, album, null)}
                                                                onDragEnd={handleDragEnd}
                                                                className="album-cover bg-white/10 rounded-lg p-2 flex items-center gap-3 hover:bg-white/20 transition-all border border-white/10 cursor-grab"
                                                            >
                                                                <img
                                                                    src={album.image}
                                                                    alt={album.title}
                                                                    className="w-12 h-12 rounded object-cover"
                                                                />
                                                                <div className="flex-1 min-w-0">
                                                                    <p className="text-white text-sm font-medium truncate">{album.title}</p>
                                                                    <p className="text-gray-400 text-xs truncate">{album.artist}</p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {searchResults.length > 0 && <hr className="border-white/10 my-2" />}
                                                    </>
                                                )}

                                                {/* Search Results */}
                                                {searchResults.length === 0 && !loading && uploadedImages.length === 0 && (
                                                    <p className="text-gray-400 text-sm text-center py-8">
                                                        {searchQuery ? 'No results found' : 'Search or upload to add albums'}
                                                    </p>
                                                )}
                                                {paginatedResults.map((album) => (
                                                    <div
                                                        key={album.id}
                                                        draggable
                                                        onDragStart={(e) => handleDragStart(e, album, null)}
                                                        onDragEnd={handleDragEnd}
                                                        className="album-cover bg-white/10 rounded-lg p-2 flex items-center gap-3 hover:bg-white/20 transition-all border border-white/10 cursor-grab"
                                                    >
                                                        <img
                                                            src={album.image}
                                                            alt={album.title}
                                                            className="w-12 h-12 rounded object-cover"
                                                            loading="lazy"
                                                        />
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-white text-sm font-medium truncate">{album.title}</p>
                                                            <p className="text-gray-400 text-xs truncate">{album.artist} {album.year && `(${album.year})`}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Pagination */}
                                            {searchResults.length > itemsPerPage && (
                                                <div className="flex items-center justify-between pt-3 border-t border-white/10">
                                                    <button
                                                        onClick={() => setSearchPage(p => Math.max(0, p - 1))}
                                                        disabled={searchPage === 0}
                                                        className="px-3 py-1.5 bg-white/10 hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed text-white text-sm rounded transition-colors"
                                                    >
                                                        Previous
                                                    </button>
                                                    <span className="text-white/70 text-sm">
                                                        Page {searchPage + 1} of {totalPages}
                                                    </span>
                                                    <button
                                                        onClick={() => setSearchPage(p => Math.min(totalPages - 1, p + 1))}
                                                        disabled={searchPage >= totalPages - 1}
                                                        className="px-3 py-1.5 bg-white/10 hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed text-white text-sm rounded transition-colors"
                                                    >
                                                        Next
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Layout Selector */}
                                    <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                        <h3 className="text-lg md:text-xl font-bold text-white mb-4">Layout</h3>
                                        <div className="space-y-2">
                                            <button
                                                onClick={() => switchLayout('standard')}
                                                className={`w-full px-4 py-3 rounded-lg font-medium transition-all ${
                                                    layout === 'standard'
                                                        ? 'bg-white text-black'
                                                        : 'bg-white/10 text-white hover:bg-white/20'
                                                }`}
                                            >
                                                Standard Grid
                                            </button>
                                            <button
                                                onClick={() => switchLayout('classic')}
                                                className={`w-full px-4 py-3 rounded-lg font-medium transition-all ${
                                                    layout === 'classic'
                                                        ? 'bg-white text-black'
                                                        : 'bg-white/10 text-white hover:bg-white/20'
                                                }`}
                                            >
                                                Classic Collage
                                            </button>
                                            <button
                                                onClick={() => switchLayout('aboutYou')}
                                                className={`w-full px-4 py-3 rounded-lg font-medium transition-all ${
                                                    layout === 'aboutYou'
                                                        ? 'bg-white text-black'
                                                        : 'bg-white/10 text-white hover:bg-white/20'
                                                }`}
                                            >
                                                About You: Music
                                            </button>
                                        </div>
                                    </div>

                                    {/* Settings */}
                                    <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                        <h3 className="text-lg md:text-xl font-bold text-white mb-4 flex items-center gap-2">
                                            <Settings className="w-5 h-5" />
                                            Settings
                                        </h3>
                                        
                                        <div className="space-y-4">
                                            {layout === 'standard' && (
                                                <>
                                                    <div>
                                                        <label className="block text-white text-sm font-medium mb-2">Title</label>
                                                        <input
                                                            type="text"
                                                            value={title}
                                                            onChange={(e) => setTitle(e.target.value)}
                                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                        />
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label className="block text-white text-sm font-medium mb-2">Width</label>
                                                            <input
                                                                type="number"
                                                                min="1"
                                                                max="10"
                                                                value={gridWidth}
                                                                onChange={(e) => setGridWidth(Math.min(10, Math.max(1, parseInt(e.target.value) || 1)))}
                                                                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="block text-white text-sm font-medium mb-2">Height</label>
                                                            <input
                                                                type="number"
                                                                min="1"
                                                                max="10"
                                                                value={gridHeight}
                                                                onChange={(e) => setGridHeight(Math.min(10, Math.max(1, parseInt(e.target.value) || 1)))}
                                                                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                                                            />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {layout === 'classic' && (
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">Title</label>
                                                    <input
                                                        type="text"
                                                        value={title}
                                                        onChange={(e) => setTitle(e.target.value)}
                                                        className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                    />
                                                </div>
                                            )}

                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">Title Color</label>
                                                    <input
                                                        type="color"
                                                        value={titleColor}
                                                        onChange={(e) => setTitleColor(e.target.value)}
                                                        className="w-full h-10 bg-white/10 border border-white/20 rounded-lg cursor-pointer"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">BG Color</label>
                                                    <input
                                                        type="color"
                                                        value={bgColor}
                                                        onChange={(e) => setBgColor(e.target.value)}
                                                        className="w-full h-10 bg-white/10 border border-white/20 rounded-lg cursor-pointer"
                                                    />
                                                </div>
                                            </div>

                                            {layout === 'standard' && (
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        type="checkbox"
                                                        id="showTitles"
                                                        checked={showTitles}
                                                        onChange={(e) => setShowTitles(e.target.checked)}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <label htmlFor="showTitles" className="text-white text-sm">Show album list</label>
                                                </div>
                                            )}

                                            {(layout === 'standard' || layout === 'classic') && (
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        type="checkbox"
                                                        id="showGuidelines"
                                                        checked={showGuidelines}
                                                        onChange={(e) => setShowGuidelines(e.target.checked)}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <label htmlFor="showGuidelines" className="text-white text-sm">
                                                        {layout === 'classic' ? 'Show grid lines' : 'Show grid guides'}
                                                    </label>
                                                </div>
                                            )}

                                            {layout === 'classic' && (
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        type="checkbox"
                                                        id="showTitlesClassic"
                                                        checked={showTitles}
                                                        onChange={(e) => setShowTitles(e.target.checked)}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <label htmlFor="showTitlesClassic" className="text-white text-sm">Show album list</label>
                                                </div>
                                            )}

                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="checkbox"
                                                    id="performanceMode"
                                                    checked={performanceMode}
                                                    onChange={(e) => setPerformanceMode(e.target.checked)}
                                                    className="w-4 h-4 rounded"
                                                />
                                                <label htmlFor="performanceMode" className="text-white text-sm">Performance mode</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Right Panel - Grid */}
                                <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                    <div
                                        ref={gridRef}
                                        style={{ backgroundColor: bgColor }}
                                        className="p-6 md:p-8 rounded-xl"
                                    >
                                        {layout === 'standard' && (
                                            <h2
                                                style={{ color: titleColor }}
                                                className="text-2xl md:text-3xl font-bold text-center mb-6"
                                            >
                                                {title}
                                            </h2>
                                        )}

                                        <div className="flex gap-6">
                                            {layout === 'standard' && (
                                                <>
                                                    <div
                                                        className="grid gap-2 flex-1"
                                                        style={{
                                                            gridTemplateColumns: `repeat(${gridWidth}, minmax(0, 1fr))`,
                                                        }}
                                                    >
                                                        {grid.map((album, index) => (
                                                            <div
                                                                key={index}
                                                                onDragOver={(e) => handleDragOver(e, index)}
                                                                onDragLeave={handleDragLeave}
                                                                onDrop={(e) => handleDrop(e, index)}
                                                                className={`aspect-square relative group transition-all ${
                                                                    showGuidelines ? 'grid-slot' : ''
                                                                } ${dragOverIndex === index ? 'drag-over' : ''}`}
                                                                style={{
                                                                    minWidth: '60px',
                                                                    minHeight: '60px',
                                                                    borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.2)' : undefined
                                                                }}
                                                            >
                                                                {album ? (
                                                                    <>
                                                                        <img
                                                                            src={album.image}
                                                                            alt={album.title}
                                                                            draggable
                                                                            onDragStart={(e) => handleDragStart(e, album, index)}
                                                                            onDragEnd={handleDragEnd}
                                                                            onContextMenu={(e) => {
                                                                                e.preventDefault();
                                                                                openRenameModal(index);
                                                                            }}
                                                                            className="album-cover w-full h-full object-cover rounded"
                                                                        />
                                                                        {/* Edit/Delete Overlay */}
                                                                        <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                            <button
                                                                                onClick={() => openRenameModal(index)}
                                                                                className="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded"
                                                                                title="Edit Info"
                                                                            >
                                                                                <Pencil className="w-3 h-3" />
                                                                            </button>
                                                                            <button
                                                                                onClick={() => removeFromGrid(index)}
                                                                                className="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded"
                                                                                title="Remove"
                                                                            >
                                                                                <Trash className="w-3 h-3" />
                                                                            </button>
                                                                        </div>
                                                                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent text-white text-xs p-2 opacity-0 group-hover:opacity-100 transition-opacity rounded-b">
                                                                            <p className="font-medium truncate">{album.title}</p>
                                                                            <p className="text-gray-300 truncate">{album.artist}</p>
                                                                        </div>
                                                                    </>
                                                                ) : (
                                                                    <div className="empty-state">
                                                                        {!hasAlbums && index === 0 ? 'Drag albums here' : index + 1}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>

                                                    {showTitles && (
                                                        <div className="w-64 hidden lg:block">
                                                            <div className="space-y-2">
                                                                {grid.map((album, index) => (
                                                                    album && (
                                                                        <div
                                                                            key={index}
                                                                            style={{ color: titleColor }}
                                                                            className="text-sm cursor-pointer hover:opacity-70 transition-opacity"
                                                                            onClick={() => openRenameModal(index)}
                                                                            title="Click to rename"
                                                                        >
                                                                            <span className="font-bold">{index + 1}.</span> {album.title} <span className="text-gray-400">— {album.artist}</span>
                                                                        </div>
                                                                    )
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </>
                                            )}

                                            {layout === 'classic' && (
                                                <div className="w-full flex gap-6">
                                                    <div className="flex-1">
                                                        {title && (
                                                            <h2
                                                                style={{ color: titleColor }}
                                                                className="text-2xl md:text-3xl font-bold text-center mb-4"
                                                            >
                                                                {title}
                                                            </h2>
                                                        )}
                                                        
                                                        {/* Row 1: 5 albums (indices 0-4) */}
                                                        <div className="grid grid-cols-5 gap-0 mb-0">
                                                            {grid.slice(0, 5).map((album, i) => (
                                                                <div
                                                                    key={i}
                                                                    onDragOver={(e) => handleDragOver(e, i)}
                                                                    onDragLeave={handleDragLeave}
                                                                    onDrop={(e) => handleDrop(e, i)}
                                                                    className={`aspect-square relative group transition-all ${
                                                                        showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'
                                                                    } ${dragOverIndex === i ? 'drag-over' : ''}`}
                                                                    style={{
                                                                        borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.2)' : undefined
                                                                    }}
                                                                >
                                                                    {album ? (
                                                                        <>
                                                                            <img
                                                                                src={album.image}
                                                                                alt={album.title}
                                                                                draggable
                                                                                onDragStart={(e) => handleDragStart(e, album, i)}
                                                                                onDragEnd={handleDragEnd}
                                                                                onContextMenu={(e) => {
                                                                                    e.preventDefault();
                                                                                    openRenameModal(i);
                                                                                }}
                                                                                className="album-cover w-full h-full object-cover rounded"
                                                                            />
                                                                            <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                                <button
                                                                                    onClick={() => openRenameModal(i)}
                                                                                    className="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded"
                                                                                >
                                                                                    <Pencil className="w-3 h-3" />
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => removeFromGrid(i)}
                                                                                    className="bg-red-500 hover:bg-red-600 text-white p-1 rounded"
                                                                                >
                                                                                    <Trash className="w-3 h-3" />
                                                                                </button>
                                                                            </div>
                                                                        </>
                                                                    ) : (
                                                                        <div className="empty-state">
                                                                            {!hasAlbums && i === 0 ? 'Drag albums here' : i + 1}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Row 2: 5 albums (indices 5-9) */}
                                                        <div className="grid grid-cols-5 gap-0 mb-0">
                                                            {grid.slice(5, 10).map((album, i) => {
                                                                const idx = i + 5;
                                                                return (
                                                                    <div
                                                                        key={idx}
                                                                        onDragOver={(e) => handleDragOver(e, idx)}
                                                                        onDragLeave={handleDragLeave}
                                                                        onDrop={(e) => handleDrop(e, idx)}
                                                                        className={`aspect-square relative group transition-all ${
                                                                            showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'
                                                                        } ${dragOverIndex === idx ? 'drag-over' : ''}`}
                                                                        style={{
                                                                            borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.1)' : undefined
                                                                        }}
                                                                    >
                                                                        {album ? (
                                                                            <>
                                                                                <img
                                                                                    src={album.image}
                                                                                    alt={album.title}
                                                                                    draggable
                                                                                    onDragStart={(e) => handleDragStart(e, album, idx)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onContextMenu={(e) => {
                                                                                        e.preventDefault();
                                                                                        openRenameModal(idx);
                                                                                    }}
                                                                                    className="album-cover w-full h-full object-cover"
                                                                                />
                                                                                <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                                    <button
                                                                                        onClick={() => openRenameModal(idx)}
                                                                                        className="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded"
                                                                                    >
                                                                                        <Pencil className="w-3 h-3" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => removeFromGrid(idx)}
                                                                                        className="bg-red-500 hover:bg-red-600 text-white p-1 rounded"
                                                                                    >
                                                                                        <Trash className="w-3 h-3" />
                                                                                    </button>
                                                                                </div>
                                                                            </>
                                                                        ) : showGuidelines ? (
                                                                            <div className="w-full h-full flex items-center justify-center text-white/10 text-xs">
                                                                                {idx + 1}
                                                                            </div>
                                                                        ) : null}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        {/* Row 3: 6 albums (indices 10-15) */}
                                                        <div className="grid grid-cols-6 gap-0 mb-0">
                                                            {grid.slice(10, 16).map((album, i) => {
                                                                const idx = i + 10;
                                                                return (
                                                                    <div
                                                                        key={idx}
                                                                        onDragOver={(e) => handleDragOver(e, idx)}
                                                                        onDragLeave={handleDragLeave}
                                                                        onDrop={(e) => handleDrop(e, idx)}
                                                                        className={`aspect-square relative group transition-all ${
                                                                            showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'
                                                                        } ${dragOverIndex === idx ? 'drag-over' : ''}`}
                                                                        style={{
                                                                            borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.2)' : undefined
                                                                        }}
                                                                    >
                                                                        {album ? (
                                                                            <>
                                                                                <img
                                                                                    src={album.image}
                                                                                    alt={album.title}
                                                                                    draggable
                                                                                    onDragStart={(e) => handleDragStart(e, album, idx)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onContextMenu={(e) => {
                                                                                        e.preventDefault();
                                                                                        openRenameModal(idx);
                                                                                    }}
                                                                                    className="album-cover w-full h-full object-cover rounded"
                                                                                />
                                                                                <div className="absolute top-0.5 right-0.5 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                                    <button
                                                                                        onClick={() => openRenameModal(idx)}
                                                                                        className="bg-blue-500 hover:bg-blue-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Pencil className="w-2.5 h-2.5" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => removeFromGrid(idx)}
                                                                                        className="bg-red-500 hover:bg-red-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Trash className="w-2.5 h-2.5" />
                                                                                    </button>
                                                                                </div>
                                                                            </>
                                                                        ) : (
                                                                            <div className="empty-state text-[10px]">
                                                                                {idx + 1}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        {/* Row 4: 6 albums (indices 16-21) */}
                                                        <div className="grid grid-cols-6 gap-0 mb-0">
                                                            {grid.slice(16, 22).map((album, i) => {
                                                                const idx = i + 16;
                                                                return (
                                                                    <div
                                                                        key={idx}
                                                                        onDragOver={(e) => handleDragOver(e, idx)}
                                                                        onDragLeave={handleDragLeave}
                                                                        onDrop={(e) => handleDrop(e, idx)}
                                                                        className={`aspect-square relative group transition-all ${
                                                                            showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'
                                                                        } ${dragOverIndex === idx ? 'drag-over' : ''}`}
                                                                        style={{
                                                                            borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.1)' : undefined
                                                                        }}
                                                                    >
                                                                        {album ? (
                                                                            <>
                                                                                <img
                                                                                    src={album.image}
                                                                                    alt={album.title}
                                                                                    draggable
                                                                                    onDragStart={(e) => handleDragStart(e, album, idx)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onContextMenu={(e) => {
                                                                                        e.preventDefault();
                                                                                        openRenameModal(idx);
                                                                                    }}
                                                                                    className="album-cover w-full h-full object-cover"
                                                                                />
                                                                                <div className="absolute top-0.5 right-0.5 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                                    <button
                                                                                        onClick={() => openRenameModal(idx)}
                                                                                        className="bg-blue-500 hover:bg-blue-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Pencil className="w-2.5 h-2.5" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => removeFromGrid(idx)}
                                                                                        className="bg-red-500 hover:bg-red-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Trash className="w-2.5 h-2.5" />
                                                                                    </button>
                                                                                </div>
                                                                            </>
                                                                        ) : showGuidelines ? (
                                                                            <div className="w-full h-full flex items-center justify-center text-white/10 text-[10px]">
                                                                                {idx + 1}
                                                                            </div>
                                                                        ) : null}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        {/* Row 5: 10 albums (indices 22-31) */}
                                                        <div className="grid grid-cols-10 gap-0 mb-0">
                                                            {grid.slice(22, 32).map((album, i) => {
                                                                const idx = i + 22;
                                                                return (
                                                                    <div
                                                                        key={idx}
                                                                        onDragOver={(e) => handleDragOver(e, idx)}
                                                                        onDragLeave={handleDragLeave}
                                                                        onDrop={(e) => handleDrop(e, idx)}
                                                                        className={`aspect-square relative group transition-all ${
                                                                            showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'
                                                                        } ${dragOverIndex === idx ? 'drag-over' : ''}`}
                                                                        style={{
                                                                            borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.1)' : undefined
                                                                        }}
                                                                    >
                                                                        {album ? (
                                                                            <>
                                                                                <img
                                                                                    src={album.image}
                                                                                    alt={album.title}
                                                                                    draggable
                                                                                    onDragStart={(e) => handleDragStart(e, album, idx)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onContextMenu={(e) => {
                                                                                        e.preventDefault();
                                                                                        openRenameModal(idx);
                                                                                    }}
                                                                                    className="album-cover w-full h-full object-cover"
                                                                                />
                                                                                <div className="absolute top-0.5 right-0.5 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                                    <button
                                                                                        onClick={() => openRenameModal(idx)}
                                                                                        className="bg-blue-500 hover:bg-blue-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Pencil className="w-2 h-2" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => removeFromGrid(idx)}
                                                                                        className="bg-red-500 hover:bg-red-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Trash className="w-2 h-2" />
                                                                                    </button>
                                                                                </div>
                                                                            </>
                                                                        ) : showGuidelines ? (
                                                                            <div className="w-full h-full flex items-center justify-center text-white/10 text-[8px]">
                                                                                {idx + 1}
                                                                            </div>
                                                                        ) : null}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        {/* Row 6: 10 albums (indices 32-41) */}
                                                        <div className="grid grid-cols-10 gap-0">
                                                            {grid.slice(32, 42).map((album, i) => {
                                                                const idx = i + 32;
                                                                return (
                                                                    <div
                                                                        key={idx}
                                                                        onDragOver={(e) => handleDragOver(e, idx)}
                                                                        onDragLeave={handleDragLeave}
                                                                        onDrop={(e) => handleDrop(e, idx)}
                                                                        className={`aspect-square relative group transition-all ${
                                                                            showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'
                                                                        } ${dragOverIndex === idx ? 'drag-over' : ''}`}
                                                                        style={{
                                                                            borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.1)' : undefined
                                                                        }}
                                                                    >
                                                                        {album ? (
                                                                            <>
                                                                                <img
                                                                                    src={album.image}
                                                                                    alt={album.title}
                                                                                    draggable
                                                                                    onDragStart={(e) => handleDragStart(e, album, idx)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onContextMenu={(e) => {
                                                                                        e.preventDefault();
                                                                                        openRenameModal(idx);
                                                                                    }}
                                                                                    className="album-cover w-full h-full object-cover"
                                                                                />
                                                                                <div className="absolute top-0.5 right-0.5 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                                    <button
                                                                                        onClick={() => openRenameModal(idx)}
                                                                                        className="bg-blue-500 hover:bg-blue-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Pencil className="w-2 h-2" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => removeFromGrid(idx)}
                                                                                        className="bg-red-500 hover:bg-red-600 text-white p-0.5 rounded"
                                                                                    >
                                                                                        <Trash className="w-2 h-2" />
                                                                                    </button>
                                                                                </div>
                                                                            </>
                                                                        ) : showGuidelines ? (
                                                                            <div className="w-full h-full flex items-center justify-center text-white/10 text-[8px]">
                                                                                {idx + 1}
                                                                            </div>
                                                                        ) : null}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>

                                                    {/* Album List Sidebar */}
                                                    {showTitles && filledAlbums.length > 0 && (
                                                        <div className="w-64 hidden lg:block">
                                                            <div className="space-y-1 text-xs">
                                                                {filledAlbums.map((album, idx) => {
                                                                    const gridIndex = grid.findIndex(a => a && a.id === album.id);
                                                                    return (
                                                                        <div
                                                                            key={idx}
                                                                            style={{ color: titleColor }}
                                                                            className="leading-tight cursor-pointer hover:opacity-70 transition-opacity"
                                                                            onClick={() => openRenameModal(gridIndex)}
                                                                            title="Click to rename"
                                                                        >
                                                                            <span className="font-bold">{idx + 1}.</span> {album.title} <span className="opacity-70">— {album.artist}</span>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {layout === 'aboutYou' && (
                                                <div
                                                    className="grid gap-2 w-full"
                                                    style={{
                                                        gridTemplateColumns: `repeat(${gridWidth}, minmax(0, 1fr))`,
                                                    }}
                                                >
                                                    {aboutYouGrid.map((cell, index) => (
                                                        <div
                                                            key={index}
                                                            onDragOver={(e) => handleDragOver(e, index)}
                                                            onDragLeave={handleDragLeave}
                                                            onDrop={(e) => handleDrop(e, index)}
                                                            className={`grid-slot relative group transition-all ${
                                                                !showGuidelines ? 'hidden-guides' : ''
                                                            } ${dragOverIndex === index ? 'drag-over' : ''}`}
                                                            style={{
                                                                minWidth: '80px',
                                                                minHeight: '120px',
                                                                borderColor: bgColor === '#ffffff' && showGuidelines ? 'rgba(0, 0, 0, 0.2)' : undefined
                                                            }}
                                                        >
                                                            <div className="about-you-cell w-full h-full p-2">
                                                                {cell?.album ? (
                                                                    <>
                                                                        <img
                                                                            src={cell.album.image}
                                                                            alt={cell.album.title}
                                                                            draggable
                                                                            onDragStart={(e) => handleDragStart(e, cell.album, index)}
                                                                            onDragEnd={handleDragEnd}
                                                                            className="album-cover w-full aspect-square object-cover rounded"
                                                                        />
                                                                        <button
                                                                            onClick={() => removeFromGrid(index)}
                                                                            className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-all z-10"
                                                                        >
                                                                            <Trash className="w-3 h-3" />
                                                                        </button>
                                                                        </>
                                                                ) : (
                                                                    <div className="w-full aspect-square bg-white/5 rounded flex items-center justify-center text-white/20 text-xs">
                                                                        Drag here
                                                                    </div>
                                                                )}
                                                                <div
                                                                    contentEditable
                                                                    suppressContentEditableWarning
                                                                    onBlur={(e) => updateLabel(index, e.target.textContent)}
                                                                    className="editable-label text-xs font-medium w-full"
                                                                    style={{ color: titleColor }}
                                                                    title="Click to edit label"
                                                                >
                                                                    {cell?.label || ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TopstersMode />, document.getElementById('root'));
    </script>
</body>
</html>