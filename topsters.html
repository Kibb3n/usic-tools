<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topsters - Music Grid Creator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @keyframes blob1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(150px, 100px) scale(1.2); }
            66% { transform: translate(-100px, 150px) scale(0.9); }
        }
        @keyframes blob2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(-150px, -100px) scale(0.9); }
            66% { transform: translate(100px, -150px) scale(1.2); }
        }
        .grain {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='3.5' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.3'/%3E%3C/svg%3E");
            pointer-events: none;
        }
        .grid-slot {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
        }
        .grid-slot.hidden-guides {
            border-color: rgba(255, 255, 255, 0.1);
        }
        .grid-slot.drag-over {
            border-color: #60a5fa !important;
            background: rgba(96, 165, 250, 0.2);
            transform: scale(1.05);
        }
        .classic-slot {
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
        }
        .classic-slot.hidden-guides {
            border-color: transparent;
        }
        .classic-slot.drag-over {
            border-color: #60a5fa !important;
            background: rgba(96, 165, 250, 0.2);
            transform: scale(1.05);
        }
        .album-cover {
            cursor: grab;
            user-select: none;
            transition: transform 0.2s;
        }
        .album-cover:active {
            cursor: grabbing;
        }
        .album-cover.dragging {
            opacity: 0.4;
            transform: scale(0.9);
        }
        .about-you-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .editable-label {
            outline: none;
            text-align: center;
            cursor: text;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px dashed transparent;
        }
        .editable-label:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }
        .editable-label:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.875rem;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // Icons
        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const Trash = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const Pencil = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={className + " animate-spin"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
            </svg>
        );

        const Undo = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
        );

        const Image = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const Layers = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z" />
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );

        // Helper for iTunes API
        const jsonpRequest = (url) => {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                const script = document.createElement('script');
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                document.body.appendChild(script);
            });
        };

        function AnimatedBackground({ colors }) {
            return (
                <div className="fixed inset-0 overflow-hidden pointer-events-none">
                    <div
                        className="absolute w-[900px] h-[900px] rounded-full opacity-70 blur-3xl will-change-transform"
                        style={{
                            background: `radial-gradient(circle, ${colors[0]} 0%, transparent 70%)`,
                            animation: `blob1 12s ease-in-out infinite`,
                            top: '50%',
                            left: '33.333%',
                            transform: 'translate(-50%, -50%)',
                        }}
                    />
                    <div
                        className="absolute w-[900px] h-[900px] rounded-full opacity-70 blur-3xl will-change-transform"
                        style={{
                            background: `radial-gradient(circle, ${colors[1]} 0%, transparent 70%)`,
                            animation: `blob2 12s ease-in-out infinite`,
                            top: '50%',
                            right: '33.333%',
                            transform: 'translate(50%, -50%)',
                        }}
                    />
                    <div className="absolute inset-0 grain opacity-30" />
                </div>
            );
        }

        const aboutYouLabels = [
            'Favourite Album', 'Best Narrative', 'Favourite Cover', "I'll Listen Someday", 'Personal Impact', 'Bad Day Cure',
            'You enjoy but most don\'t', 'You don\'t enjoy but most do', 'Underrated', 'Overrated', 'Not usually my thing but...', 'Best Instrumental',
            'Best Vocals', 'Simple but fun', 'Best Mixtape', 'Consistent Discography', 'Biggest Letdown', 'Biggest Surprise',
            'Best Soundtrack', 'Most Unique', 'Favourite Band', 'Favourite Solo Artist', 'Best EP', 'Most Depressing'
        ];

        function TopstersMode() {
            const [layout, setLayout] = useState('standard');
            const [gridWidth, setGridWidth] = useState(5);
            const [gridHeight, setGridHeight] = useState(5);
            const [title, setTitle] = useState('My Top Albums');
            const [titleColor, setTitleColor] = useState('#ffffff');
            const [bgColor, setBgColor] = useState('#000000');
            const [showTitles, setShowTitles] = useState(false);
            const [showGuidelines, setShowGuidelines] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [grid, setGrid] = useState([]);
            const [aboutYouGrid, setAboutYouGrid] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null);
            const [draggedFrom, setDraggedFrom] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);
            const [bgColors, setBgColors] = useState(['#ff0080', '#7928ca']);
            const [history, setHistory] = useState([]);
            const [showConfirm, setShowConfirm] = useState(false);
            const [uploadedImages, setUploadedImages] = useState([]);
            const [searchPage, setSearchPage] = useState(0);
            const [showImageModal, setShowImageModal] = useState(false);
            const [showAdvancedSearch, setShowAdvancedSearch] = useState(false);
            const [artistSearchQuery, setArtistSearchQuery] = useState('');
            const [artistSuggestions, setArtistSuggestions] = useState([]);
            const [selectedArtistForAlbums, setSelectedArtistForAlbums] = useState(null);
            const [artistAlbums, setArtistAlbums] = useState([]);
            const [loadingArtist, setLoadingArtist] = useState(false);
            const [pendingImage, setPendingImage] = useState(null);
            const [customTitle, setCustomTitle] = useState('');
            const [customArtist, setCustomArtist] = useState('');
            const [performanceMode, setPerformanceMode] = useState(false);
            const [renameModalOpen, setRenameModalOpen] = useState(false);
            const [renameIndex, setRenameIndex] = useState(null);
            const [renameTitle, setRenameTitle] = useState('');
            const [renameArtist, setRenameArtist] = useState('');
            const [leftPanelTab, setLeftPanelTab] = useState('search');
            const [showNumbers, setShowNumbers] = useState(true);
            
            const gridRef = useRef(null);
            const fileInputRef = useRef(null);
            const scrollIntervalRef = useRef(null);

            const itemsPerPage = 20;
            const totalPages = Math.ceil(searchResults.length / itemsPerPage);
            const paginatedResults = useMemo(() => 
                searchResults.slice(searchPage * itemsPerPage, (searchPage + 1) * itemsPerPage),
                [searchResults, searchPage]
            );

            // Initialize grids
            useEffect(() => {
                if (layout === 'standard') {
                    setGrid(prevGrid => {
                        const newGrid = Array(gridHeight * gridWidth).fill(null);
                        for (let i = 0; i < Math.min(prevGrid.length, newGrid.length); i++) {
                            newGrid[i] = prevGrid[i];
                        }
                        return newGrid;
                    });
                } else if (layout === 'aboutYou') {
                    setAboutYouGrid(prevGrid => {
                        const newGrid = aboutYouLabels.map((label, i) => 
                            prevGrid[i] || { album: null, label }
                        );
                        return newGrid;
                    });
                } else if (layout === 'classic') {
                    setGrid(prevGrid => {
                        const newGrid = Array(42).fill(null);
                        for (let i = 0; i < Math.min(prevGrid.length, 42); i++) {
                            newGrid[i] = prevGrid[i];
                        }
                        return newGrid;
                    });
                }
            }, [gridWidth, gridHeight, layout]);

            const saveToHistory = useCallback(() => {
                setHistory(prev => [...prev.slice(-9), { grid: [...grid], aboutYouGrid: [...aboutYouGrid] }]);
            }, [grid, aboutYouGrid]);

            const undo = useCallback(() => {
                if (history.length === 0) return;
                const prev = history[history.length - 1];
                setGrid(prev.grid);
                setAboutYouGrid(prev.aboutYouGrid);
                setHistory(h => h.slice(0, -1));
            }, [history]);

            const normalizeString = useCallback((str) => {
                return str.toLowerCase().replace(/[^a-z0-9]/g, '');
            }, []);

            const searchAlbums = useCallback(async () => {
                if (!searchQuery.trim()) return;

                setLoading(true);
                setSearchResults([]);
                setSearchPage(0);

                try {
                    // iTunes Search
                    const itunesData = await jsonpRequest(
                        `https://itunes.apple.com/search?term=${encodeURIComponent(searchQuery)}&entity=album&limit=40`
                    );
                    const itunesResults = itunesData.results && itunesData.results.length > 0
                        ? itunesData.results
                            .filter(item => item.wrapperType === 'collection')
                            .map(album => ({
                                id: `itunes-${album.collectionId}`,
                                title: album.collectionName,
                                artist: album.artistName,
                                image: album.artworkUrl100.replace('100x100', '600x600'),
                                year: album.releaseDate ? new Date(album.releaseDate).getFullYear() : '',
                                source: 'iTunes'
                            }))
                        : [];

                    // Last.fm Search
                    let lastfmResults = [];
                    try {
                        const lastfmUrl = `https://ws.audioscrobbler.com/2.0/?method=album.search&album=${encodeURIComponent(searchQuery)}&api_key=33866e12a02528e0bb9211bd2f351c28&format=json&limit=40`;
                        const lastfmResponse = await fetch(lastfmUrl);
                        const lastfmData = await lastfmResponse.json();

                        if (lastfmData.results?.albummatches?.album) {
                            const albums = Array.isArray(lastfmData.results.albummatches.album) 
                                ? lastfmData.results.albummatches.album 
                                : [lastfmData.results.albummatches.album];
                            
                            lastfmResults = albums
                                .filter(album => album.image && album.image.length > 0)
                                .map(album => {
                                    const image = album.image.find(img => img.size === 'extralarge') || 
                                                album.image.find(img => img.size === 'large') ||
                                                album.image.find(img => img.size === 'medium');
                                    const imageUrl = image?.['#text'] || '';
                                    
                                    return {
                                        id: `lastfm-${album.mbid || Math.random()}-${album.name}`,
                                        title: album.name,
                                        artist: album.artist,
                                        image: imageUrl,
                                        year: '',
                                        source: 'Last.fm'
                                    };
                                })
                                .filter(album => 
                                    album.image && 
                                    album.image.length > 20 && 
                                    !album.image.includes('2a96cbd8b46e442fc41c2b86b821562f') &&
                                    !album.image.includes('c6f59c1e5e7240a4c0d427abd71f3dbb')
                                );
                        }
                    } catch (error) {
                        console.error('Last.fm search error:', error);
                    }

                    const allResults = [...itunesResults, ...lastfmResults];
                    
                    const seen = new Map();
                    const uniqueResults = allResults.filter(album => {
                        const titleKey = normalizeString(album.title);
                        const artistKey = normalizeString(album.artist);
                        
                        for (const [key] of seen.entries()) {
                            const [seenTitle, seenArtist] = key.split('|||');
                            if (seenTitle === titleKey && seenArtist === artistKey) {
                                return false;
                            }
                        }
                        
                        seen.set(`${titleKey}|||${artistKey}`, album);
                        return true;
                    });
                    
                    setSearchResults(uniqueResults);
                } catch (error) {
                    console.error('Search error:', error);
                }
                
                setLoading(false);
            }, [searchQuery, normalizeString]);

            const handleDragStart = useCallback((e, album, fromIndex) => {
                setDraggedItem(album);
                setDraggedFrom(fromIndex);
                e.dataTransfer.effectAllowed = 'move';
                e.currentTarget.classList.add('dragging');
            }, []);

            const handleDragEnd = useCallback((e) => {
                e.currentTarget.classList.remove('dragging');
                setDragOverIndex(null);
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
            }, []);

            const handleDragOver = useCallback((e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverIndex(index);

                const y = e.clientY;
                const scrollThreshold = 100;
                const scrollSpeed = 10;

                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }

                if (y < scrollThreshold) {
                    scrollIntervalRef.current = setInterval(() => {
                        window.scrollBy(0, -scrollSpeed);
                    }, 16);
                } else if (y > window.innerHeight - scrollThreshold) {
                    scrollIntervalRef.current = setInterval(() => {
                        window.scrollBy(0, scrollSpeed);
                    }, 16);
                }
            }, []);

            const handleDragLeave = useCallback(() => {
                setDragOverIndex(null);
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
            }, []);

            const handleDrop = useCallback((e, toIndex) => {
                e.preventDefault();
                setDragOverIndex(null);
                
                if (draggedItem) {
                    saveToHistory();
                    
                    if (layout === 'aboutYou') {
                        const newGrid = [...aboutYouGrid];
                        if (draggedFrom !== null && draggedFrom >= 0) {
                            newGrid[draggedFrom] = { ...newGrid[draggedFrom], album: null };
                        }
                        newGrid[toIndex] = { ...newGrid[toIndex], album: draggedItem };
                        setAboutYouGrid(newGrid);
                    } else {
                        const newGrid = [...grid];
                        if (draggedFrom !== null && draggedFrom >= 0) {
                            newGrid[draggedFrom] = null;
                        }
                        newGrid[toIndex] = draggedItem;
                        setGrid(newGrid);
                    }
                    setDraggedItem(null);
                    setDraggedFrom(null);
                }
            }, [draggedItem, draggedFrom, layout, aboutYouGrid, grid, saveToHistory]);

            const removeFromGrid = useCallback((index) => {
                saveToHistory();
                if (layout === 'aboutYou') {
                    const newGrid = [...aboutYouGrid];
                    newGrid[index] = { ...newGrid[index], album: null };
                    setAboutYouGrid(newGrid);
                } else {
                    const newGrid = [...grid];
                    newGrid[index] = null;
                    setGrid(newGrid);
                }
            }, [layout, aboutYouGrid, grid, saveToHistory]);

            const updateLabel = useCallback((index, newLabel) => {
                const newGrid = [...aboutYouGrid];
                newGrid[index] = { ...newGrid[index], label: newLabel };
                setAboutYouGrid(newGrid);
            }, [aboutYouGrid]);

            const openRenameModal = useCallback((index) => {
                if (layout === 'aboutYou' || index === null || index === undefined) return;
                
                const album = grid[index];
                if (album) {
                    setRenameIndex(index);
                    setRenameTitle(album.title);
                    setRenameArtist(album.artist);
                    setRenameModalOpen(true);
                }
            }, [layout, grid]);

            const confirmRename = useCallback(() => {
                if (renameIndex !== null) {
                    saveToHistory();
                    const newGrid = [...grid];
                    newGrid[renameIndex] = {
                        ...newGrid[renameIndex],
                        title: renameTitle,
                        artist: renameArtist
                    };
                    setGrid(newGrid);
                }
                setRenameModalOpen(false);
                setRenameIndex(null);
                setRenameTitle('');
                setRenameArtist('');
            }, [renameIndex, renameTitle, renameArtist, grid, saveToHistory]);

            const switchLayout = useCallback((newLayout) => {
                if (newLayout === 'aboutYou' && (layout === 'standard' || layout === 'classic')) {
                    const filledAlbums = grid.filter(a => a);
                    const newAboutYouGrid = aboutYouLabels.map((label, i) => ({
                        album: filledAlbums[i] || null,
                        label
                    }));
                    setAboutYouGrid(newAboutYouGrid);
                    setLayout(newLayout);
                    setGridWidth(6);
                    setGridHeight(4);
                } else if (layout === 'aboutYou' && (newLayout === 'standard' || newLayout === 'classic')) {
                    const filledAlbums = aboutYouGrid.filter(cell => cell?.album).map(cell => cell.album);
                    const targetSize = newLayout === 'classic' ? 42 : (gridWidth * gridHeight);
                    const newGrid = Array(targetSize).fill(null);
                    filledAlbums.forEach((album, i) => {
                        if (i < targetSize) {
                            newGrid[i] = album;
                        }
                    });
                    setGrid(newGrid);
                    setLayout(newLayout);
                } else if (layout === 'standard' && newLayout === 'classic') {
                    const newGrid = Array(42).fill(null);
                    grid.forEach((album, i) => {
                        if (i < 42) {
                            newGrid[i] = album;
                        }
                    });
                    setGrid(newGrid);
                    setLayout(newLayout);
                } else if (layout === 'classic' && newLayout === 'standard') {
                    const newGrid = Array(gridWidth * gridHeight).fill(null);
                    grid.forEach((album, i) => {
                        if (i < newGrid.length) {
                            newGrid[i] = album;
                        }
                    });
                    setGrid(newGrid);
                    setLayout(newLayout);
                } else {
                    setLayout(newLayout);
                    if (newLayout === 'aboutYou') {
                        setGridWidth(6);
                        setGridHeight(4);
                    }
                }
            }, [layout, grid, aboutYouGrid, gridWidth, gridHeight]);

            const exportAsImage = useCallback(async () => {
                if (!gridRef.current) return;

                try {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const canvas = await html2canvas(gridRef.current, {
                        backgroundColor: bgColor,
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        foreignObjectRendering: false,
                        imageTimeout: 0
                    });
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = `topsters-${Date.now()}.png`;
                            link.href = url;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }
                    }, 'image/png');
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Failed to export image. Try disabling browser extensions or try a different browser.');
                }
            }, [bgColor]);

            const exportData = useCallback(() => {
                const data = { layout, gridWidth, gridHeight, title, titleColor, bgColor, showTitles, showGuidelines, grid, aboutYouGrid };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `topsters-data-${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }, [layout, gridWidth, gridHeight, title, titleColor, bgColor, showTitles, showGuidelines, grid, aboutYouGrid]);

            const importData = useCallback((event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.grid && !data.aboutYouGrid) {
                            alert('Invalid data file');
                            return;
                        }
                        setLayout(data.layout || 'standard');
                        setGridWidth(data.gridWidth || 5);
                        setGridHeight(data.gridHeight || 5);
                        setTitle(data.title || 'My Top Albums');
                        setTitleColor(data.titleColor || '#ffffff');
                        setBgColor(data.bgColor || '#000000');
                        setShowTitles(data.showTitles || false);
                        setShowGuidelines(data.showGuidelines !== undefined ? data.showGuidelines : true);
                        setGrid(data.grid || []);
                        setAboutYouGrid(data.aboutYouGrid || []);
                    } catch (err) {
                        alert('Failed to import data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }, []);

            const clearGrid = useCallback(() => {
                setShowConfirm(false);
                saveToHistory();
                if (layout === 'aboutYou') {
                    setAboutYouGrid(aboutYouLabels.map(label => ({ album: null, label })));
                } else if (layout === 'classic') {
                    setGrid(Array(42).fill(null));
                } else {
                    setGrid(Array(gridHeight * gridWidth).fill(null));
                }
            }, [layout, gridHeight, gridWidth, saveToHistory]);

            const handleImageUpload = useCallback((e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setPendingImage(event.target.result);
                        setCustomTitle(file.name.replace(/\.[^/.]+$/, ""));
                        setCustomArtist('');
                        setShowImageModal(true);
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = '';
            }, []);

            const confirmImageUpload = useCallback(() => {
                if (pendingImage) {
                    const newImage = {
                        id: `uploaded-${Date.now()}-${Math.random()}`,
                        title: customTitle || 'Untitled',
                        artist: customArtist || 'Unknown Artist',
                        image: pendingImage,
                        year: ''
                    };
                    setUploadedImages(prev => [...prev, newImage]);
                }
                setShowImageModal(false);
                setPendingImage(null);
                setCustomTitle('');
                setCustomArtist('');
            }, [pendingImage, customTitle, customArtist]);

            const handlePasteImage = useCallback(async () => {
                try {
                    const clipboardItems = await navigator.clipboard.read();
                    for (const item of clipboardItems) {
                        if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                            const blob = await item.getType(item.types.find(t => t.startsWith('image/')));
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                setPendingImage(e.target.result);
                                setCustomTitle('Pasted Image');
                                setCustomArtist('');
                                setShowImageModal(true);
                            };
                            reader.readAsDataURL(blob);
                            return;
                        }
                    }
                    alert('No image found in clipboard');
                } catch (err) {
                    console.error('Failed to read clipboard:', err);
                    alert('Failed to paste from clipboard. Make sure you have copied an image.');
                }
            }, []);

            const searchArtistForAlbums = useCallback(async () => {
                if (!artistSearchQuery.trim()) return;
                
                setLoadingArtist(true);
                setArtistSuggestions([]);
                
                try {
                    const data = await jsonpRequest(
                        `https://itunes.apple.com/search?term=${encodeURIComponent(artistSearchQuery)}&entity=musicArtist&limit=20`
                    );
                    
                    if (data.results && data.results.length > 0) {
                        const artists = data.results
                            .filter(item => item.wrapperType === 'artist')
                            .reduce((acc, artist) => {
                                if (!acc.find(a => a.artistName.toLowerCase() === artist.artistName.toLowerCase())) {
                                    acc.push(artist);
                                }
                                return acc;
                            }, []);
                        setArtistSuggestions(artists);
                    }
                } catch (err) {
                    console.error('Artist search error:', err);
                }
                
                setLoadingArtist(false);
            }, [artistSearchQuery]);

            const selectArtistAndLoadAlbums = useCallback(async (artist) => {
                setLoadingArtist(true);
                setSelectedArtistForAlbums(artist);
                setArtistAlbums([]);
                
                try {
                    const data = await jsonpRequest(
                        `https://itunes.apple.com/lookup?id=${artist.artistId}&entity=album&limit=200`
                    );
                    
                    if (data.results && data.results.length > 1) {
                        const albums = data.results
                            .slice(1)
                            .filter(item => item.wrapperType === 'collection')
                            .map(album => ({
                                id: `itunes-${album.collectionId}`,
                                title: album.collectionName,
                                artist: album.artistName,
                                image: album.artworkUrl100.replace('100x100', '600x600'),
                                year: album.releaseDate ? new Date(album.releaseDate).getFullYear() : '',
                                source: 'iTunes'
                            }));
                        setArtistAlbums(albums);
                    }
                } catch (err) {
                    console.error('Album loading error:', err);
                }
                
                setLoadingArtist(false);
            }, []);

            const deleteUploadedImage = useCallback((imageId) => {
                setUploadedImages(prev => prev.filter(img => img.id !== imageId));
            }, []);

            const hasAlbums = useMemo(() => 
                layout === 'aboutYou' 
                    ? aboutYouGrid.some(cell => cell?.album)
                    : grid.some(album => album),
                [layout, aboutYouGrid, grid]
            );

            const filledAlbums = useMemo(() =>
                layout === 'aboutYou'
                    ? aboutYouGrid.filter(cell => cell?.album).map(cell => cell.album)
                    : grid.filter(album => album),
                [layout, aboutYouGrid, grid]
            );

            return (
                <div className="min-h-screen bg-black relative overflow-hidden">
                    {!performanceMode && <AnimatedBackground colors={bgColors} />}

                    {renameModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-4">Rename Album</h3>
                                <div className="space-y-3 mb-6">
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Album Title</label>
                                        <input
                                            type="text"
                                            value={renameTitle}
                                            onChange={(e) => setRenameTitle(e.target.value)}
                                            placeholder="Enter album title"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Artist Name</label>
                                        <input
                                            type="text"
                                            value={renameArtist}
                                            onChange={(e) => setRenameArtist(e.target.value)}
                                            placeholder="Enter artist name"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setRenameModalOpen(false);
                                            setRenameIndex(null);
                                            setRenameTitle('');
                                            setRenameArtist('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmRename}
                                        className="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Rename
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-3">Clear entire grid?</h3>
                                <p className="text-gray-400 mb-6">This will remove all albums. This action cannot be undone.</p>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowConfirm(false)}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={clearGrid}
                                        className="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Clear Grid
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImageModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-gray-900 border border-white/20 rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-4">Add Custom Album</h3>
                                {pendingImage && (
                                    <img src={pendingImage} alt="Preview" className="w-32 h-32 rounded-lg mx-auto mb-4 object-cover" />
                                )}
                                <div className="space-y-3 mb-6">
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Album Title</label>
                                        <input
                                            type="text"
                                            value={customTitle}
                                            onChange={(e) => setCustomTitle(e.target.value)}
                                            placeholder="Enter album title"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-white text-sm font-medium mb-2">Artist Name</label>
                                        <input
                                            type="text"
                                            value={customArtist}
                                            onChange={(e) => setCustomArtist(e.target.value)}
                                            placeholder="Enter artist name"
                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowImageModal(false);
                                            setPendingImage(null);
                                            setCustomTitle('');
                                            setCustomArtist('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmImageUpload}
                                        className="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors"
                                    >
                                        Add to Library
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="relative z-10">
                        <div className="flex flex-wrap justify-between items-center gap-4 pt-8 px-4 md:px-8">
                            <a href="µsic.html" className="hover:opacity-80 transition-opacity">
                                <h1 className="text-2xl md:text-3xl font-bold text-white drop-shadow-lg">µsic tools</h1>
                            </a>
                            
                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={undo}
                                    disabled={history.length === 0}
                                    className="px-3 py-2 bg-white/10 hover:bg-white/20 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                    title="Undo last change"
                                >
                                    <Undo className="w-4 h-4" />
                                </button>
                                <button
                                    onClick={exportAsImage}
                                    className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                >
                                    <Download className="w-4 h-4" />
                                    <span className="hidden sm:inline">Image</span>
                                </button>
                                <button
                                    onClick={exportData}
                                    className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 transition-colors"
                                >
                                    <Upload className="w-4 h-4" />
                                    <span className="hidden sm:inline">Export</span>
                                </button>
                                <label className="px-3 md:px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 flex items-center gap-2 cursor-pointer transition-colors">
                                    <Download className="w-4 h-4" />
                                    <span className="hidden sm:inline">Import</span>
                                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                                </label>
                                <button
                                    onClick={() => setShowConfirm(true)}
                                    className="px-3 md:px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-white rounded-lg border border-red-500/50 flex items-center gap-2 transition-colors"
                                >
                                    <Trash className="w-4 h-4" />
                                    <span className="hidden sm:inline">Clear</span>
                                </button>
                            </div>
                        </div>

                        <div className="p-4 md:p-8 max-w-7xl mx-auto">
                            <div className="grid lg:grid-cols-[320px_1fr] gap-4 md:gap-6">
                                {/* Left Panel with Tabs */}
                                <div className="space-y-4">
                                    {/* Tab Buttons */}
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setLeftPanelTab('search')}
                                            className={`flex-1 px-4 py-2 rounded-lg font-medium transition-all ${
                                                leftPanelTab === 'search' ? 'bg-white text-black' : 'bg-white/10 text-white hover:bg-white/20'
                                            }`}
                                        >
                                            <Search className="w-4 h-4 inline mr-2" />
                                            Search
                                        </button>
                                        <button
                                            onClick={() => setLeftPanelTab('layout')}
                                            className={`flex-1 px-4 py-2 rounded-lg font-medium transition-all ${
                                                leftPanelTab === 'layout' ? 'bg-white text-black' : 'bg-white/10 text-white hover:bg-white/20'
                                            }`}
                                        >
                                            <Layers className="w-4 h-4 inline mr-2" />
                                            Layout
                                        </button>
                                        <button
                                            onClick={() => setLeftPanelTab('settings')}
                                            className={`flex-1 px-4 py-2 rounded-lg font-medium transition-all ${
                                                leftPanelTab === 'settings' ? 'bg-white text-black' : 'bg-white/10 text-white hover:bg-white/20'
                                            }`}
                                        >
                                            <Settings className="w-4 h-4 inline mr-2" />
                                            Settings
                                        </button>
                                    </div>

                                    {/* Search Panel */}
                                    {leftPanelTab === 'search' && (
                                        <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                            <h3 className="text-lg md:text-xl font-bold text-white mb-4">Search Albums</h3>
                                            <div className="space-y-3">
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={searchQuery}
                                                        onChange={(e) => setSearchQuery(e.target.value)}
                                                        onKeyPress={(e) => e.key === 'Enter' && searchAlbums()}
                                                        placeholder="Search for albums..."
                                                        className="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                    />
                                                    <button
                                                        onClick={searchAlbums}
                                                        disabled={loading}
                                                        className="px-4 py-2 bg-white text-black hover:bg-gray-100 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-semibold transition-colors flex items-center gap-2"
                                                    >
                                                        {loading ? <Loader2 className="w-5 h-5" /> : <Search className="w-5 h-5" />}
                                                    </button>
                                                </div>

                                                <button
                                                    onClick={() => setShowAdvancedSearch(!showAdvancedSearch)}
                                                    className="w-full px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-white rounded-lg border border-purple-500/50 flex items-center justify-center gap-2 transition-colors"
                                                >
                                                    <Image className="w-5 h-5" />
                                                    Advanced Search
                                                </button>

                                                {showAdvancedSearch && (
                                                    <div className="space-y-4 p-4 bg-white/5 rounded-lg border border-white/10">
                                                        <div>
                                                            <h4 className="text-white font-semibold mb-2 flex items-center gap-2">
                                                                <Upload className="w-4 h-4" />
                                                                Upload Custom Image
                                                            </h4>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => fileInputRef.current?.click()}
                                                                    className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 transition-colors text-sm"
                                                                >
                                                                    Choose File
                                                                </button>
                                                                <button
                                                                    onClick={handlePasteImage}
                                                                    className="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 transition-colors text-sm"
                                                                >
                                                                    Paste
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {uploadedImages.length > 0 && (
                                                            <div>
                                                                <h4 className="text-white font-semibold mb-2 text-sm">Recent Uploads</h4>
                                                                <div className="space-y-2 max-h-[200px] overflow-y-auto">
                                                                    {uploadedImages.slice(-5).reverse().map((album) => (
                                                                        <div
                                                                            key={album.id}
                                                                            className="bg-white/10 rounded-lg p-2 flex items-center gap-3 border border-white/10 group"
                                                                        >
                                                                            <img
                                                                                src={album.image}
                                                                                alt={album.title}
                                                                                className="w-12 h-12 rounded object-cover cursor-grab"
                                                                                draggable
                                                                                onDragStart={(e) => handleDragStart(e, album, null)}
                                                                                onDragEnd={handleDragEnd}
                                                                            />
                                                                            <div className="flex-1 min-w-0">
                                                                                <p className="text-white text-sm font-medium truncate">{album.title}</p>
                                                                                <p className="text-gray-400 text-xs truncate">{album.artist}</p>
                                                                            </div>
                                                                            <button
                                                                                onClick={() => deleteUploadedImage(album.id)}
                                                                                className="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded transition-all"
                                                                            >
                                                                                <Trash className="w-4 h-4 text-red-400" />
                                                                            </button>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        <hr className="border-white/10" />

                                                        <div>
                                                            <h4 className="text-white font-semibold mb-2 flex items-center gap-2 text-sm">
                                                                <Search className="w-4 h-4" />
                                                                Search by Artist
                                                            </h4>
                                                            {!selectedArtistForAlbums ? (
                                                                <div className="space-y-2">
                                                                    <div className="flex gap-2">
                                                                        <input
                                                                            type="text"
                                                                            value={artistSearchQuery}
                                                                            onChange={(e) => setArtistSearchQuery(e.target.value)}
                                                                            onKeyPress={(e) => e.key === 'Enter' && searchArtistForAlbums()}
                                                                            placeholder="Search for an artist..."
                                                                            className="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                                        />
                                                                        <button
                                                                            onClick={searchArtistForAlbums}
                                                                            disabled={loadingArtist}
                                                                            className="px-3 py-2 bg-white text-black hover:bg-gray-100 disabled:bg-gray-600 rounded-lg font-semibold"
                                                                        >
                                                                            {loadingArtist ? <Loader2 className="w-5 h-5" /> : <Search className="w-5 h-5" />}
                                                                        </button>
                                                                    </div>
                                                                    {artistSuggestions.length > 0 && (
                                                                        <div className="space-y-1 max-h-[150px] overflow-y-auto">
                                                                            {artistSuggestions.map((artist) => (
                                                                                <button
                                                                                    key={artist.artistId}
                                                                                    onClick={() => selectArtistAndLoadAlbums(artist)}
                                                                                    className="w-full text-left px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white text-sm transition-colors"
                                                                                >
                                                                                    {artist.artistName}
                                                                                </button>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ) : (
                                                                <div className="space-y-2">
                                                                    <div className="flex items-center justify-between">
                                                                        <span className="text-white text-sm font-medium">{selectedArtistForAlbums.artistName}</span>
                                                                        <button
                                                                            onClick={() => {
                                                                                setSelectedArtistForAlbums(null);
                                                                                setArtistAlbums([]);
                                                                                setArtistSuggestions([]);
                                                                            }}
                                                                            className="text-gray-400 hover:text-white text-xs"
                                                                        >
                                                                            Change
                                                                        </button>
                                                                    </div>
                                                                    {loadingArtist ? (
                                                                        <div className="flex items-center justify-center py-4">
                                                                            <Loader2 className="w-6 h-6 text-white" />
                                                                        </div>
                                                                    ) : artistAlbums.length > 0 ? (
                                                                        <div className="grid grid-cols-2 gap-2 max-h-[200px] overflow-y-auto">
                                                                            {artistAlbums.map((album) => (
                                                                                <div
                                                                                    key={album.id}
                                                                                    draggable
                                                                                    onDragStart={(e) => handleDragStart(e, album, null)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    className="album-cover bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all border border-white/10 cursor-grab"
                                                                                >
                                                                                    <img
                                                                                        src={album.image}
                                                                                        alt={album.title}
                                                                                        className="w-full aspect-square rounded object-cover mb-1"
                                                                                    />
                                                                                    <p className="text-white text-xs font-medium truncate">{album.title}</p>
                                                                                    <p className="text-gray-400 text-[10px] truncate">{album.year}</p>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    ) : (
                                                                        <p className="text-gray-400 text-sm text-center py-4">No albums found</p>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                                <input ref={fileInputRef} type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />

                                                <div className="max-h-[500px] overflow-y-auto space-y-2">
                                                    {searchResults.length === 0 && !loading && (
                                                        <p className="text-gray-400 text-sm text-center py-8">
                                                            {searchQuery ? 'No results found' : 'Search to add albums'}
                                                        </p>
                                                    )}
                                                    {paginatedResults.map((album) => (
                                                        <div
                                                            key={album.id}
                                                            draggable
                                                            onDragStart={(e) => handleDragStart(e, album, null)}
                                                            onDragEnd={handleDragEnd}
                                                            className="album-cover bg-white/10 rounded-lg p-2 flex items-center gap-3 hover:bg-white/20 transition-all border border-white/10 cursor-grab"
                                                        >
                                                            <img src={album.image} alt={album.title} className="w-12 h-12 rounded object-cover" loading="lazy" />
                                                            <div className="flex-1 min-w-0">
                                                                <p className="text-white text-sm font-medium truncate">{album.title}</p>
                                                                <p className="text-gray-400 text-xs truncate">{album.artist} {album.year && `(${album.year})`}</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                                {searchResults.length > itemsPerPage && (
                                                    <div className="flex items-center justify-between pt-3 border-t border-white/10">
                                                        <button
                                                            onClick={() => setSearchPage(p => Math.max(0, p - 1))}
                                                            disabled={searchPage === 0}
                                                            className="px-3 py-1.5 bg-white/10 hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed text-white text-sm rounded transition-colors"
                                                        >
                                                            Previous
                                                        </button>
                                                        <span className="text-white/70 text-sm">Page {searchPage + 1} of {totalPages}</span>
                                                        <button
                                                            onClick={() => setSearchPage(p => Math.min(totalPages - 1, p + 1))}
                                                            disabled={searchPage >= totalPages - 1}
                                                            className="px-3 py-1.5 bg-white/10 hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed text-white text-sm rounded transition-colors"
                                                        >
                                                            Next
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* Layout Panel */}
                                    {leftPanelTab === 'layout' && (
                                        <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                            <h3 className="text-lg md:text-xl font-bold text-white mb-4">Layout</h3>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={() => switchLayout('standard')}
                                                    className={`w-full px-4 py-3 rounded-lg font-medium transition-all ${
                                                        layout === 'standard' ? 'bg-white text-black' : 'bg-white/10 text-white hover:bg-white/20'
                                                    }`}
                                                >
                                                    Standard Grid
                                                </button>
                                                <button
                                                    onClick={() => switchLayout('classic')}
                                                    className={`w-full px-4 py-3 rounded-lg font-medium transition-all ${
                                                        layout === 'classic' ? 'bg-white text-black' : 'bg-white/10 text-white hover:bg-white/20'
                                                    }`}
                                                >
                                                    Classic Collage
                                                </button>
                                                <button
                                                    onClick={() => switchLayout('aboutYou')}
                                                    className={`w-full px-4 py-3 rounded-lg font-medium transition-all ${
                                                        layout === 'aboutYou' ? 'bg-white text-black' : 'bg-white/10 text-white hover:bg-white/20'
                                                    }`}
                                                >
                                                    About You: Music
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {/* Settings Panel */}
                                    {leftPanelTab === 'settings' && (
                                        <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                            <h3 className="text-lg md:text-xl font-bold text-white mb-4 flex items-center gap-2">
                                                <Settings className="w-5 h-5" />
                                                Settings
                                            </h3>
                                            
                                            <div className="space-y-4">
                                                {layout === 'standard' && (
                                                    <>
                                                        <div>
                                                            <label className="block text-white text-sm font-medium mb-2">Title</label>
                                                            <input
                                                                type="text"
                                                                value={title}
                                                                onChange={(e) => setTitle(e.target.value)}
                                                                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                            />
                                                        </div>

                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label className="block text-white text-sm font-medium mb-2">Width</label>
                                                                <input
                                                                    type="number"
                                                                    min="1"
                                                                    max="10"
                                                                    value={gridWidth}
                                                                    onChange={(e) => setGridWidth(Math.min(10, Math.max(1, parseInt(e.target.value) || 1)))}
                                                                    className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-white text-sm font-medium mb-2">Height</label>
                                                                <input
                                                                    type="number"
                                                                    min="1"
                                                                    max="10"
                                                                    value={gridHeight}
                                                                    onChange={(e) => setGridHeight(Math.min(10, Math.max(1, parseInt(e.target.value) || 1)))}
                                                                    className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                                                                />
                                                            </div>
                                                        </div>
                                                    </>
                                                )}

                                                {layout === 'classic' && (
                                                    <div>
                                                        <label className="block text-white text-sm font-medium mb-2">Title</label>
                                                        <input
                                                            type="text"
                                                            value={title}
                                                            onChange={(e) => setTitle(e.target.value)}
                                                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                                                        />
                                                    </div>
                                                )}

                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="block text-white text-sm font-medium mb-2">Title Color</label>
                                                        <input
                                                            type="color"
                                                            value={titleColor}
                                                            onChange={(e) => setTitleColor(e.target.value)}
                                                            className="w-full h-10 bg-white/10 border border-white/20 rounded-lg cursor-pointer"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-white text-sm font-medium mb-2">BG Color</label>
                                                        <input
                                                            type="color"
                                                            value={bgColor}
                                                            onChange={(e) => setBgColor(e.target.value)}
                                                            className="w-full h-10 bg-white/10 border border-white/20 rounded-lg cursor-pointer"
                                                        />
                                                    </div>
                                                </div>

                                                {layout === 'standard' && (
                                                    <div className="flex items-center gap-2">
                                                        <input
                                                            type="checkbox"
                                                            id="showTitles"
                                                            checked={showTitles}
                                                            onChange={(e) => setShowTitles(e.target.checked)}
                                                            className="w-4 h-4 rounded"
                                                        />
                                                        <label htmlFor="showTitles" className="text-white text-sm">Show album list</label>
                                                    </div>
                                                )}

                                                {(layout === 'standard' || layout === 'classic') && (
                                                    <div className="flex items-center gap-2">
                                                        <input
                                                            type="checkbox"
                                                            id="showGuidelines"
                                                            checked={showGuidelines}
                                                            onChange={(e) => setShowGuidelines(e.target.checked)}
                                                            className="w-4 h-4 rounded"
                                                        />
                                                        <label htmlFor="showGuidelines" className="text-white text-sm">
                                                            {layout === 'classic' ? 'Show grid lines' : 'Show grid guides'}
                                                        </label>
                                                    </div>
                                                )}

                                                {layout === 'classic' && (
                                                    <div className="flex items-center gap-2">
                                                        <input
                                                            type="checkbox"
                                                            id="showTitlesClassic"
                                                            checked={showTitles}
                                                            onChange={(e) => setShowTitles(e.target.checked)}
                                                            className="w-4 h-4 rounded"
                                                        />
                                                        <label htmlFor="showTitlesClassic" className="text-white text-sm">Show album list</label>
                                                    </div>
                                                )}

                                                <div className="flex items-center gap-2">
                                                    <input
                                                        type="checkbox"
                                                        id="performanceMode"
                                                        checked={performanceMode}
                                                        onChange={(e) => setPerformanceMode(e.target.checked)}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <label htmlFor="performanceMode" className="text-white text-sm">Performance mode</label>
                                                </div>

                                                {(layout === 'standard' || layout === 'classic') && (
                                                    <div className="flex items-center gap-2">
                                                        <input
                                                            type="checkbox"
                                                            id="showNumbers"
                                                            checked={showNumbers}
                                                            onChange={(e) => setShowNumbers(e.target.checked)}
                                                            className="w-4 h-4 rounded"
                                                        />
                                                        <label htmlFor="showNumbers" className="text-white text-sm">Show numbers</label>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Right Panel - Grid */}
                                <div className="bg-white/5 backdrop-blur-2xl rounded-2xl p-4 md:p-6 shadow-2xl border border-white/10">
                                    <div ref={gridRef} style={{ backgroundColor: bgColor }} className="p-6 md:p-8 rounded-xl min-h-[400px]">
                                        {layout === 'standard' && (
                                            <>
                                                <h2 style={{ color: titleColor }} className="text-2xl md:text-3xl font-bold text-center mb-6">
                                                    {title}
                                                </h2>
                                                <div className="flex gap-6">
                                                    <div className="grid gap-2 flex-1" style={{ gridTemplateColumns: `repeat(${gridWidth}, minmax(0, 1fr))` }}>
                                                        {grid.map((album, index) => (
                                                            <div
                                                                key={index}
                                                                onDragOver={(e) => handleDragOver(e, index)}
                                                                onDragLeave={handleDragLeave}
                                                                onDrop={(e) => handleDrop(e, index)}
                                                                className={`aspect-square relative group transition-all ${
                                                                    showGuidelines ? 'grid-slot' : 'grid-slot hidden-guides'
                                                                } ${dragOverIndex === index ? 'drag-over' : ''}`}
                                                                style={{ minWidth: '60px', minHeight: '60px' }}
                                                            >
                                                                {album ? (
                                                                    <>
                                                                        <img
                                                                            src={album.image}
                                                                            alt={album.title}
                                                                            draggable
                                                                            onDragStart={(e) => handleDragStart(e, album, index)}
                                                                            onDragEnd={handleDragEnd}
                                                                            onContextMenu={(e) => {
                                                                                e.preventDefault();
                                                                                openRenameModal(index);
                                                                            }}
                                                                            className="album-cover w-full h-full object-cover rounded"
                                                                        />
                                                                        <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10">
                                                                            <button onClick={() => openRenameModal(index)} className="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded">
                                                                                <Pencil className="w-3 h-3" />
                                                                            </button>
                                                                            <button onClick={() => removeFromGrid(index)} className="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded">
                                                                                <Trash className="w-3 h-3" />
                                                                            </button>
                                                                        </div>
                                                                        {showNumbers && (
                                                                            <div className="absolute bottom-1 left-1 bg-black/70 text-white px-2 py-0.5 rounded text-xs font-bold">
                                                                                {index + 1}
                                                                            </div>
                                                                        )}
                                                                    </>
                                                                ) : (
                                                                    <div className="empty-state">{!hasAlbums && index === 0 ? 'Drag albums here' : (showNumbers ? index + 1 : '')}</div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {showTitles && (
                                                        <div className="w-64 hidden lg:block">
                                                            <div className="space-y-2">
                                                                {grid.map((album, index) => (
                                                                    album && (
                                                                        <div key={index} style={{ color: titleColor }} className="text-sm cursor-pointer hover:opacity-70 transition-opacity" onClick={() => openRenameModal(index)}>
                                                                            {showNumbers && <span className="font-bold">{index + 1}.</span>} {album.title} <span className="text-gray-400">— {album.artist}</span>
                                                                        </div>
                                                                    )
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </>
                                        )}

                                        {layout === 'aboutYou' && (
                                            <div className="max-w-[800px] mx-auto">
                                                <div className="grid grid-cols-6 gap-2 w-full">
                                                    {aboutYouGrid.map((cell, index) => (
                                                        <div 
                                                            key={index} 
                                                            onDragOver={(e) => handleDragOver(e, index)} 
                                                            onDragLeave={handleDragLeave} 
                                                            onDrop={(e) => handleDrop(e, index)} 
                                                            className={`grid-slot relative group transition-all ${!showGuidelines ? 'hidden-guides' : ''} ${dragOverIndex === index ? 'drag-over' : ''}`} 
                                                            style={{ minWidth: '80px', minHeight: '120px' }}
                                                        >
                                                            <div className="about-you-cell w-full h-full p-2">
                                                                {cell?.album ? (
                                                                    <>
                                                                        <img 
                                                                            src={cell.album.image} 
                                                                            alt={cell.album.title} 
                                                                            draggable 
                                                                            onDragStart={(e) => handleDragStart(e, cell.album, index)} 
                                                                            onDragEnd={handleDragEnd} 
                                                                            className="album-cover w-full aspect-square object-cover rounded" 
                                                                        />
                                                                        <button 
                                                                            onClick={() => removeFromGrid(index)} 
                                                                            className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-all z-10"
                                                                        >
                                                                            <Trash className="w-3 h-3" />
                                                                        </button>
                                                                    </>
                                                                ) : (
                                                                    <div className="w-full aspect-square bg-white/5 rounded flex items-center justify-center text-white/20 text-xs">Drag here</div>
                                                                )}
                                                                <div 
                                                                    contentEditable 
                                                                    suppressContentEditableWarning 
                                                                    onBlur={(e) => updateLabel(index, e.target.textContent)} 
                                                                    className="editable-label text-xs font-medium w-full" 
                                                                    style={{ color: titleColor }}
                                                                >
                                                                    {cell?.label || ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {layout === 'classic' && (
                                            <>
                                                {title && (
                                                    <h2 style={{ color: titleColor }} className="text-2xl md:text-3xl font-bold text-center mb-4">
                                                        {title}
                                                    </h2>
                                                )}
                                                <div className="flex gap-6">
                                                    <div className="flex-1 max-w-[600px] mx-auto">
                                                        {/* Row 1: 5 albums */}
                                                        <div className="grid grid-cols-5 gap-0">
                                                            {grid.slice(0, 5).map((album, i) => (
                                                                <div 
                                                                    key={i} 
                                                                    onDragOver={(e) => handleDragOver(e, i)} 
                                                                    onDragLeave={handleDragLeave} 
                                                                    onDrop={(e) => handleDrop(e, i)} 
                                                                    className={`aspect-square relative group ${showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'} ${dragOverIndex === i ? 'drag-over' : ''}`}
                                                                >
                                                                    {album ? (
                                                                        <>
                                                                            <img 
                                                                                src={album.image} 
                                                                                alt={album.title} 
                                                                                draggable 
                                                                                onDragStart={(e) => handleDragStart(e, album, i)} 
                                                                                onDragEnd={handleDragEnd} 
                                                                                onContextMenu={(e) => { e.preventDefault(); openRenameModal(i); }} 
                                                                                className="w-full h-full object-cover" 
                                                                            />
                                                                            <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 z-10">
                                                                                <button onClick={() => openRenameModal(i)} className="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded">
                                                                                    <Pencil className="w-3 h-3" />
                                                                                </button>
                                                                                <button onClick={() => removeFromGrid(i)} className="bg-red-500 hover:bg-red-600 text-white p-1 rounded">
                                                                                    <Trash className="w-3 h-3" />
                                                                                </button>
                                                                            </div>
                                                                            {showNumbers && (
                                                                                <div className="absolute bottom-1 left-1 bg-black/70 text-white px-1.5 py-0.5 rounded text-xs font-bold">
                                                                                    {i + 1}
                                                                                </div>
                                                                            )}
                                                                        </>
                                                                    ) : showGuidelines && <div className="text-white/10 text-center text-xs flex items-center justify-center h-full">{i + 1}</div>}
                                                                </div>
                                                            ))}
                                                        </div>
                                                        {/* Rows 2-6 */}
                                                        {[
                                                            { start: 5, end: 10, cols: 5 },
                                                            { start: 10, end: 16, cols: 6 },
                                                            { start: 16, end: 22, cols: 6 },
                                                            { start: 22, end: 32, cols: 10 },
                                                            { start: 32, end: 42, cols: 10 }
                                                        ].map(({ start, end, cols }) => (
                                                            <div key={start} className={`grid gap-0`} style={{ gridTemplateColumns: `repeat(${cols}, minmax(0, 1fr))` }}>
                                                                {grid.slice(start, end).map((album, i) => {
                                                                    const idx = start + i;
                                                                    return (
                                                                        <div 
                                                                            key={idx} 
                                                                            onDragOver={(e) => handleDragOver(e, idx)} 
                                                                            onDragLeave={handleDragLeave} 
                                                                            onDrop={(e) => handleDrop(e, idx)} 
                                                                            className={`aspect-square relative group ${showGuidelines ? 'classic-slot' : 'classic-slot hidden-guides'} ${dragOverIndex === idx ? 'drag-over' : ''}`}
                                                                        >
                                                                            {album ? (
                                                                                <>
                                                                                    <img 
                                                                                        src={album.image} 
                                                                                        alt={album.title} 
                                                                                        draggable 
                                                                                        onDragStart={(e) => handleDragStart(e, album, idx)} 
                                                                                        onDragEnd={handleDragEnd} 
                                                                                        onContextMenu={(e) => { e.preventDefault(); openRenameModal(idx); }} 
                                                                                        className="w-full h-full object-cover" 
                                                                                    />
                                                                                    <div className="absolute top-0.5 right-0.5 flex gap-0.5 opacity-0 group-hover:opacity-100 z-10">
                                                                                        <button onClick={() => openRenameModal(idx)} className="bg-blue-500 text-white p-0.5 rounded">
                                                                                            <Pencil className="w-2 h-2" />
                                                                                        </button>
                                                                                        <button onClick={() => removeFromGrid(idx)} className="bg-red-500 text-white p-0.5 rounded">
                                                                                            <Trash className="w-2 h-2" />
                                                                                        </button>
                                                                                    </div>
                                                                                    {showNumbers && (
                                                                                        <div className="absolute bottom-0.5 left-0.5 bg-black/70 text-white px-1 py-0.5 rounded text-[10px] font-bold">
                                                                                            {idx + 1}
                                                                                        </div>
                                                                                    )}
                                                                                </>
                                                                            ) : showGuidelines && <div className="text-white/10 text-center text-[8px] flex items-center justify-center h-full">{idx + 1}</div>}
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {showTitles && filledAlbums.length > 0 && (
                                                        <div className="w-64 hidden lg:block">
                                                            {filledAlbums.map((album, idx) => {
                                                                const gridIndex = grid.findIndex(a => a && a.id === album.id);
                                                                return (
                                                                    <div 
                                                                        key={idx} 
                                                                        style={{ color: titleColor }} 
                                                                        className="text-xs cursor-pointer hover:opacity-70 mb-1" 
                                                                        onClick={() => openRenameModal(gridIndex)}
                                                                    >
                                                                        {showNumbers && <span className="font-bold">{idx + 1}.</span>} {album.title} — {album.artist}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TopstersMode />, document.getElementById('root'));
    </script>
</body>
</html>
